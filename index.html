<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LUX / NOX — V.E.I.L.</title>
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="512x512" href="/veil_favicon_512.png">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="LUX / NOX — V.E.I.L.">
<meta property="og:description" content="Virtue Evaluation & Identity Layer. Are you Lux or Nox?">
<meta property="og:image" content="https://iamkroma.com/lux-nox/og-preview.jpg">
<meta property="og:image:width" content="1024">
<meta property="og:image:height" content="1280">
<meta property="og:image:type" content="image/jpeg">
<meta property="og:url" content="https://iamkroma.com/lux-nox/">

<!-- Twitter / iMessage -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="LUX / NOX — V.E.I.L.">
<meta name="twitter:description" content="Virtue Evaluation & Identity Layer. Are you Lux or Nox?">
<meta name="twitter:image" content="https://iamkroma.com/lux-nox/og-preview.jpg">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
/* ===================== FORGE STYLES ===================== */
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Share+Tech+Mono&family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;1,400&display=swap');

:root {
  --white: #f0ede6;
  --black: #050505;
  --gray-dark: #141414;
  --gray-mid: #2a2a2a;
  --gray-light: #888;
  --accent: #c8b89a;
  --accent-dim: rgba(200,184,154,0.3);
  --paper: #e8e3d8;
  --null-red: #8a1a1a;
  --null-green: #1a4a2a;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--black);
  color: var(--white);
  font-family: 'Share Tech Mono', monospace;
  overflow: auto;
  width: 100vw;
  min-height: 100vh;
  cursor: crosshair;
}

/* ===================== GRAIN + VIGNETTE ===================== */
.grain {
  position: fixed; inset: 0; z-index: 9000;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.09'/%3E%3C/svg%3E");
  opacity: 0.5; pointer-events: none; mix-blend-mode: overlay;
  animation: grainShift 0.12s steps(1) infinite;
}
@keyframes grainShift {
  0%   { transform: translate(0,0); }
  25%  { transform: translate(-2px, 1px); }
  50%  { transform: translate(1px,-1px); }
  75%  { transform: translate(2px, 2px); }
  100% { transform: translate(-1px,0); }
}

.vignette {
  position: fixed; inset: 0; z-index: 8999; pointer-events: none;
  background: radial-gradient(ellipse at center, transparent 35%, rgba(0,0,0,0.92) 100%);
}

.scanlines {
  position: fixed; inset: 0; z-index: 8998; pointer-events: none;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.04) 2px, rgba(0,0,0,0.04) 4px);
}

/* ===================== SCREENS ===================== */
.screen {
  position: fixed; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.8s ease;
  overflow-y: auto; overflow-x: hidden;
}
.screen.active { opacity: 1; pointer-events: all; }

/* ===================== SCREEN 1: FORGE ===================== */
#screenForge {
  background: var(--black);
  padding: 30px 20px 60px;
}

.forge-container { max-width: 1100px; width: 100%; }

.header { text-align: center; margin-bottom: 40px; }
.header-subtitle { font-size: 10px; letter-spacing: 6px; color: var(--gray-light); text-transform: uppercase; margin-bottom: 8px; }
.header-rule { width: 100%; height: 1px; background: linear-gradient(90deg, transparent, var(--accent), transparent); margin: 8px 0; }
.header-title {
  font-family: 'Cinzel', serif; font-size: clamp(38px, 7vw, 82px);
  font-weight: 900; letter-spacing: 12px; line-height: 1;
  background: linear-gradient(135deg, var(--white) 30%, var(--gray-light) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.header-slash { color: var(--accent); -webkit-text-fill-color: var(--accent); font-size: 0.7em; margin: 0 6px; }
.header-tagline { font-size: 9px; letter-spacing: 4px; color: var(--gray-light); margin-top: 8px; text-transform: uppercase; }

.forge-panel {
  background: linear-gradient(135deg, rgba(28,28,28,0.92), rgba(12,12,12,0.96));
  border: 1px solid rgba(200,184,154,0.18); padding: 36px; margin-bottom: 32px; position: relative;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.04), 0 20px 60px rgba(0,0,0,0.7);
}
.forge-panel::before {
  content: 'ALIGNMENT PROTOCOL'; position: absolute; top: -11px; left: 28px;
  background: var(--gray-dark); padding: 0 12px; font-size: 9px; letter-spacing: 4px; color: var(--accent);
}

/* Gender selector */
.gender-row {
  display: flex; align-items: center; justify-content: center; gap: 18px; margin-bottom: 28px;
}
.gender-label {
  font-size: 9px; letter-spacing: 4px; color: var(--gray-light); text-transform: uppercase;
}
.gender-btn {
  padding: 8px 22px; background: transparent; border: 1px solid rgba(200,184,154,0.2);
  color: var(--gray-light); font-family: 'Cinzel', serif; font-size: 11px; font-weight: 700;
  letter-spacing: 4px; text-transform: uppercase; cursor: pointer; transition: all 0.3s;
  position: relative; overflow: hidden;
}
.gender-btn::before {
  content: ''; position: absolute; inset: 0; background: var(--accent);
  transform: scaleX(0); transform-origin: left; transition: transform 0.25s ease; z-index: -1;
}
.gender-btn:hover::before { transform: scaleX(1); }
.gender-btn:hover { color: var(--black); }
.gender-btn.active {
  border-color: var(--accent); color: var(--accent);
  box-shadow: 0 0 15px rgba(200,184,154,0.15);
}

.sliders-row { display: grid; grid-template-columns: 1fr 1fr; gap: 36px; margin-bottom: 28px; }
.slider-label { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; }
.slider-name { font-family: 'Cinzel', serif; font-size: 20px; font-weight: 700; letter-spacing: 4px; }
.slider-name.lux { color: var(--white); text-shadow: 0 0 18px rgba(240,237,230,0.35); }
.slider-name.nox { color: var(--gray-light); }
.slider-value { font-size: 26px; font-weight: bold; letter-spacing: 2px; }
.slider-value.lux { color: var(--white); }
.slider-value.nox { color: var(--gray-light); }
.slider-desc { font-size: 9px; letter-spacing: 3px; color: var(--gray-light); opacity: 0.55; margin-bottom: 10px; text-transform: uppercase; }
.slider-desc.lux-desc { color: var(--white); opacity: 0.7; }
.slider-desc.nox-desc { color: var(--gray-light); opacity: 0.7; }

input[type=range] { width: 100%; -webkit-appearance: none; height: 3px; outline: none; border-radius: 0; cursor: pointer; }
input[type=range].lux-slider { background: linear-gradient(90deg, var(--white), var(--gray-mid)); }
input[type=range].nox-slider { background: linear-gradient(90deg, var(--gray-mid), var(--black)); border: 1px solid #2a2a2a; }
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none; width: 18px; height: 18px; background: var(--white);
  border: 2px solid var(--accent); cursor: pointer; transform: rotate(45deg);
  box-shadow: 0 0 10px rgba(200,184,154,0.5); transition: all 0.2s;
}
input[type=range]::-webkit-slider-thumb:hover { transform: rotate(45deg) scale(1.2); box-shadow: 0 0 20px rgba(200,184,154,0.8); }

/* Hexagon overlay canvas for slider area */
#hexOverlay {
  position: absolute; inset: 0; pointer-events: none; z-index: 2; opacity: 0;
  transition: opacity 0.4s ease;
}
#hexOverlay.active { opacity: 1; }

.balance-bar-wrap { margin-bottom: 28px; }
.balance-bar-label { display: flex; justify-content: space-between; font-size: 9px; letter-spacing: 3px; color: var(--gray-light); margin-bottom: 8px; text-transform: uppercase; }
.balance-bar { height: 7px; background: var(--gray-mid); border: 1px solid #2a2a2a; position: relative; overflow: hidden; }
.balance-fill-lux { height: 100%; background: linear-gradient(90deg, rgba(240,237,230,0.9), rgba(240,237,230,0.55)); transition: width 0.4s ease; position: absolute; left: 0; box-shadow: 2px 0 10px rgba(240,237,230,0.25); }
.balance-fill-nox { height: 100%; background: linear-gradient(90deg, rgba(15,15,15,0.8), rgba(8,8,8,0.95)); transition: width 0.4s ease; position: absolute; right: 0; }

.forge-btn {
  display: block; width: 100%; padding: 16px; background: transparent;
  border: 1px solid var(--accent); color: var(--accent); font-family: 'Cinzel', serif;
  font-size: 15px; font-weight: 700; letter-spacing: 10px; text-transform: uppercase;
  cursor: pointer; position: relative; overflow: hidden; transition: all 0.3s; margin-bottom: 14px;
}
.forge-btn::before { content: ''; position: absolute; inset: 0; background: var(--accent); transform: scaleX(0); transform-origin: left; transition: transform 0.35s ease; z-index: -1; }
.forge-btn:hover::before { transform: scaleX(1); }
.forge-btn:hover { color: var(--black); }
.forge-btn:active { transform: scale(0.98); }

/* Character generation animation */
.forge-generating {
  display: none; flex-direction: column; align-items: center; justify-content: center;
  padding: 60px 20px; min-height: 300px;
}
.forge-generating.active { display: flex; }
.forge-generating canvas { margin-bottom: 24px; }
.gen-status {
  font-size: 10px; letter-spacing: 5px; color: var(--accent);
  text-transform: uppercase; animation: genPulse 1.5s ease-in-out infinite;
}
@keyframes genPulse { 0%,100%{opacity:0.3} 50%{opacity:1} }
.gen-substatus {
  font-size: 9px; letter-spacing: 3px; color: #4a4a4a; margin-top: 8px;
  text-transform: uppercase;
}

.output-grid {
  display: grid; grid-template-columns: 1fr 1.1fr; gap: 26px;
  opacity: 0; transform: translateY(18px); transition: opacity 0.6s ease, transform 0.6s ease;
}
.output-grid.visible { opacity: 1; transform: translateY(0); }

.character-panel {
  background: linear-gradient(160deg, rgba(18,18,18,0.96), rgba(6,6,6,0.99));
  border: 1px solid rgba(200,184,154,0.13); padding: 26px; position: relative;
  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  box-shadow: 0 30px 80px rgba(0,0,0,0.85);
}
.character-panel::before { content: 'SUBJECT MANIFEST'; position: absolute; top: -10px; left: 18px; background: var(--gray-dark); padding: 0 10px; font-size: 9px; letter-spacing: 4px; color: var(--accent); }

.corner-deco { position: absolute; width: 14px; height: 14px; }
.corner-deco.tl { top: 5px; left: 5px; border-top: 1px solid var(--accent); border-left: 1px solid var(--accent); }
.corner-deco.tr { top: 5px; right: 5px; border-top: 1px solid var(--accent); border-right: 1px solid var(--accent); }
.corner-deco.bl { bottom: 5px; left: 5px; border-bottom: 1px solid var(--accent); border-left: 1px solid var(--accent); }
.corner-deco.br { bottom: 5px; right: 5px; border-bottom: 1px solid var(--accent); border-right: 1px solid var(--accent); }

.character-name { font-family: 'Cinzel', serif; font-size: 18px; font-weight: 700; letter-spacing: 5px; margin-bottom: 4px; text-align: center; }
.name-cycler { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 4px; }
.name-arrow { background: none; border: 1px solid rgba(200,184,154,0.2); color: var(--accent); font-size: 14px; width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.25s; font-family: 'Share Tech Mono', monospace; }
.name-arrow:hover { border-color: var(--accent); background: rgba(200,184,154,0.1); }
.reroll-row { display: flex; justify-content: center; gap: 6px; margin-top: 10px; margin-bottom: 10px; }
.reroll-btn { background: none; border: 1px solid rgba(200,184,154,0.15); color: var(--gray-light); font-family: 'Share Tech Mono', monospace; font-size: 8px; letter-spacing: 2px; padding: 5px 10px; cursor: pointer; transition: all 0.25s; text-transform: uppercase; }
.reroll-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(200,184,154,0.06); }
.character-code { font-size: 10px; letter-spacing: 3px; color: var(--gray-light); margin-bottom: 18px; text-align: center; }
#characterCanvas { width: 260px; height: 370px; display: block; }
.char-archetype { font-size: 10px; letter-spacing: 4px; color: var(--accent); text-align: center; margin-top: 14px; text-transform: uppercase; }

/* ENTER CITY BUTTON */
.enter-btn {
  display: none; width: 100%; margin-top: 20px; padding: 18px;
  background: var(--black); border: 2px solid var(--white);
  color: var(--white); font-family: 'Cinzel', serif; font-size: 13px;
  font-weight: 900; letter-spacing: 8px; text-transform: uppercase;
  cursor: pointer; position: relative; overflow: hidden; transition: all 0.4s;
}
.enter-btn.show { display: block; animation: pulseGlow 2.5s ease-in-out infinite; }
.enter-btn::before {
  content: ''; position: absolute; inset: 0; background: var(--white);
  transform: scaleX(0); transform-origin: left; transition: transform 0.4s ease; z-index: -1;
}
.enter-btn:hover::before { transform: scaleX(1); }
.enter-btn:hover { color: var(--black); border-color: var(--black); }
@keyframes pulseGlow {
  0%, 100% { box-shadow: 0 0 0px transparent; }
  50% { box-shadow: 0 0 25px rgba(240,237,230,0.2), 0 0 50px rgba(240,237,230,0.08); }
}

.dossier-panel { display: flex; flex-direction: column; gap: 14px; }
.dossier-block {
  background: linear-gradient(135deg, rgba(22,22,22,0.92), rgba(10,10,10,0.96));
  border: 1px solid rgba(200,184,154,0.1); padding: 18px 22px;
  animation: fadeUp 0.5s ease both;
}
@keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.dossier-block:nth-child(1){animation-delay:0.1s} .dossier-block:nth-child(2){animation-delay:0.2s}
.dossier-block:nth-child(3){animation-delay:0.3s} .dossier-block:nth-child(4){animation-delay:0.4s}
.dossier-block-title { font-size: 9px; letter-spacing: 5px; color: var(--accent); text-transform: uppercase; margin-bottom: 10px; padding-bottom: 7px; border-bottom: 1px solid rgba(200,184,154,0.08); }
.dossier-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 7px; font-size: 10px; }
.dossier-key { color: var(--gray-light); letter-spacing: 2px; text-transform: uppercase; }
.dossier-val { color: var(--white); font-weight: bold; letter-spacing: 1px; }
.stat-bar { height: 2px; background: var(--gray-mid); margin-top: 2px; position: relative; overflow: hidden; }
.stat-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--white)); transition: width 0.8s ease; }
.trait-pills { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 4px; }
.trait-pill { font-size: 9px; letter-spacing: 2px; padding: 2px 9px; border: 1px solid rgba(200,184,154,0.22); color: var(--gray-light); text-transform: uppercase; }
.alignment-meter { height: 10px; background: var(--gray-mid); border: 1px solid #2a2a2a; position: relative; overflow: hidden; margin-top: 7px; }
.alignment-lux-fill { position: absolute; left: 0; height: 100%; background: var(--white); opacity: 0.88; transition: width 0.8s ease; }
.alignment-nox-fill { position: absolute; right: 0; height: 100%; background: #0d0d0d; border-left: 1px solid #3a3a3a; transition: width 0.8s ease; }
.lore-text { font-size: 11px; line-height: 1.8; color: #666; font-family: 'Crimson Text', serif; font-style: italic; letter-spacing: 0.5px; }
.lore-text strong { color: var(--accent); font-style: normal; font-family: 'Share Tech Mono', monospace; font-size: 10px; }

.error-msg { color: #8a3333; font-size: 10px; letter-spacing: 2px; text-align: center; margin-top: 6px; display: none; text-transform: uppercase; }
.sync-note { font-size: 9px; letter-spacing: 2px; color: #3a3a3a; text-align: center; margin-top: 10px; text-transform: uppercase; }

/* ===================== SCREEN 2: CUTSCENE ===================== */
#screenCutscene {
  background: #000;
  overflow: hidden;
  flex-direction: column;
  justify-content: flex-end;
}

.cutscene-wrap { width: 100%; height: 100%; position: relative; overflow: hidden; }
.letterbox-top, .letterbox-bot {
  position: absolute; left: 0; right: 0; background: #000; z-index: 100;
  transition: height 1.2s cubic-bezier(0.77, 0, 0.175, 1);
}
.letterbox-top { top: 0; height: 80px; }
.letterbox-bot { bottom: 0; height: 80px; }
.letterbox-top.expand { height: 0; }
.letterbox-bot.expand { height: 0; }

#cutsceneCanvas { position: absolute; inset: 0; width: 100%; height: 100%; }
.subtitle-bar { position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 200; text-align: center; min-width: 300px; }
.subtitle-text {
  font-family: 'Crimson Text', serif; font-style: italic;
  font-size: 16px; letter-spacing: 2px; color: rgba(200,184,154,0.85);
  opacity: 0; transition: opacity 0.6s ease;
  text-shadow: 0 0 20px rgba(0,0,0,0.9), 0 2px 8px rgba(0,0,0,0.9);
  white-space: nowrap;
}
.subtitle-text.show { opacity: 1; }

.scene-title-card {
  position: absolute; inset: 0; z-index: 300;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.8s ease;
}
.scene-title-card.show { opacity: 1; }
.scene-title-main {
  font-family: 'Cinzel', serif; font-size: clamp(28px, 5vw, 60px);
  font-weight: 900; letter-spacing: 14px; color: var(--white);
  text-shadow: 0 0 40px rgba(240,237,230,0.2);
  transform: translateY(10px); transition: transform 1s ease, opacity 1s ease; opacity: 0;
}
.scene-title-card.show .scene-title-main { transform: translateY(0); opacity: 1; transition-delay: 0.3s; }
.scene-title-sub { font-size: 11px; letter-spacing: 8px; color: var(--accent); margin-top: 12px; text-transform: uppercase; opacity: 0; transition: opacity 1s ease; }
.scene-title-card.show .scene-title-sub { opacity: 1; transition-delay: 0.6s; }

#rainCanvas { position: absolute; inset: 0; z-index: 50; pointer-events: none; opacity: 0.4; }

/* ===================== SCREEN 3: MARKETPLACE ===================== */
#screenMarket { background: var(--black); padding: 0; overflow: hidden; flex-direction: column; justify-content: flex-start; position: relative; }

/* B&W Graffiti Base World */
.market-graffiti {
  position: absolute; inset: 0; z-index: 0; pointer-events: none; opacity: 0.1;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Ctext x='20' y='40' font-family='monospace' font-size='28' fill='%23fff' opacity='.7' transform='rotate(-12 20 40)'%3EFEEL%3C/text%3E%3Ctext x='180' y='90' font-family='serif' font-size='16' fill='%23fff' opacity='.4' transform='rotate(5 180 90)'%3Eempty%3C/text%3E%3Ctext x='50' y='170' font-family='monospace' font-size='42' fill='%23fff' opacity='.5' transform='rotate(-3 50 170)'%3EØ%3C/text%3E%3Ctext x='250' y='160' font-family='serif' font-size='14' fill='%23fff' opacity='.3' transform='rotate(8 250 160)'%3Ewho am i%3C/text%3E%3Ctext x='100' y='260' font-family='monospace' font-size='20' fill='%23fff' opacity='.6' transform='rotate(-7 100 260)'%3ENULL%3C/text%3E%3Ctext x='280' y='300' font-family='serif' font-size='11' fill='%23fff' opacity='.35' transform='rotate(15 280 300)'%3Eremember%3C/text%3E%3Ctext x='20' y='340' font-family='monospace' font-size='34' fill='%23fff' opacity='.45' transform='rotate(2 20 340)'%3E:(%3C/text%3E%3Ctext x='320' y='50' font-family='monospace' font-size='18' fill='%23fff' opacity='.5' transform='rotate(-9 320 50)'%3EVOID%3C/text%3E%3Cline x1='140' y1='120' x2='260' y2='130' stroke='%23fff' stroke-width='1.5' opacity='.15'/%3E%3Cline x1='30' y1='220' x2='170' y2='210' stroke='%23fff' stroke-width='2' opacity='.12'/%3E%3Ccircle cx='310' cy='230' r='20' fill='none' stroke='%23fff' stroke-width='1' opacity='.1'/%3E%3Cpath d='M180 350 Q200 320 220 350' fill='none' stroke='%23fff' stroke-width='1.5' opacity='.15'/%3E%3C/svg%3E");
  background-size: 400px 400px;
}

/* Saturation filter layer */
.market-saturation-layer {
  position: absolute; inset: 0; z-index: 0; pointer-events: none;
}

/* Overload glitch overlay */
.overload-glitch {
  position: absolute; inset: 0; z-index: 9200; pointer-events: none;
  opacity: 0; transition: opacity 0.5s ease;
}
.overload-glitch.active { opacity: 1; }
.overload-glitch::before {
  content: ''; position: absolute; inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent 0px, transparent 2px,
    rgba(255,0,64,0.03) 2px, rgba(255,0,64,0.03) 4px
  );
  animation: overloadScan 0.1s steps(3) infinite;
}
.overload-glitch::after {
  content: 'EMOTIONAL OVERLOAD'; position: absolute;
  top: 50%; left: 50%; transform: translate(-50%, -50%);
  font-family: 'Share Tech Mono', monospace; font-size: 12px;
  letter-spacing: 8px; color: rgba(255,0,64,0.6);
  text-transform: uppercase;
  animation: overloadText 0.15s steps(2) infinite;
}
@keyframes overloadScan {
  0% { transform: translateX(0) skewX(0deg); }
  33% { transform: translateX(-3px) skewX(-0.5deg); }
  66% { transform: translateX(2px) skewX(0.3deg); }
  100% { transform: translateX(0) skewX(0deg); }
}
@keyframes overloadText {
  0% { opacity: 0.4; transform: translate(-50%, -50%) translateX(0); }
  50% { opacity: 0.8; transform: translate(-50%, -50%) translateX(3px); }
  100% { opacity: 0.4; transform: translate(-50%, -50%) translateX(-2px); }
}

/* Active injection badges on cards */
.inject-timer-badge {
  position: absolute; top: 8px; right: 8px;
  background: rgba(200,184,154,0.15); border: 1px solid var(--accent);
  padding: 4px 10px; font-family: 'Share Tech Mono', monospace;
  font-size: 10px; letter-spacing: 2px; color: var(--accent);
  z-index: 5;
}
.inject-timer-badge.expiring {
  border-color: #a44; color: #a66;
  animation: badgePulse 0.5s ease-in-out infinite;
}
@keyframes badgePulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

/* Multi-injection bracelet display */
.active-injections-row {
  display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;
}
.active-inject-chip {
  display: flex; align-items: center; gap: 6px;
  background: rgba(200,184,154,0.08); border: 1px solid rgba(200,184,154,0.25);
  padding: 4px 10px; font-size: 9px; letter-spacing: 2px;
  color: var(--accent); text-transform: uppercase;
}
.active-inject-chip .chip-timer {
  font-family: 'Share Tech Mono', monospace; color: var(--white);
}
.active-inject-chip.expiring { border-color: #a44; color: #a66; }
.active-inject-chip.expiring .chip-timer { color: #a66; }

/* Overload state on bracelet */
.bracelet-bar.overloaded {
  border-color: rgba(255,0,64,0.4) !important;
  animation: braceletOverload 0.3s steps(2) infinite;
}
@keyframes braceletOverload {
  0% { transform: translateX(0); }
  50% { transform: translateX(2px); }
  100% { transform: translateX(-1px); }
}
.market-inner {
  width: 100%; height: 100%; overflow-y: auto; overflow-x: hidden;
  padding: 40px 30px 80px;
  scrollbar-width: thin; scrollbar-color: var(--accent) transparent;
  filter: grayscale(100%);
  transition: filter 1.5s ease;
}
.market-inner::-webkit-scrollbar { width: 2px; }
.market-inner::-webkit-scrollbar-thumb { background: var(--accent); }

.market-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; border-bottom: 1px solid rgba(200,184,154,0.15); padding-bottom: 28px; position: relative; }
.market-logo { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 6px; color: var(--gray-light); text-transform: uppercase; margin-bottom: 8px; }
.market-title-main { font-family: 'Cinzel', serif; font-size: clamp(28px, 5vw, 52px); font-weight: 900; letter-spacing: 6px; color: var(--white); line-height: 1; }
.market-title-sub { font-size: 10px; letter-spacing: 4px; color: var(--gray-light); margin-top: 6px; text-transform: uppercase; }

.null-wallet { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
.null-label { font-size: 9px; letter-spacing: 4px; color: var(--gray-light); text-transform: uppercase; }
.null-balance { display: flex; align-items: center; gap: 12px; }
.null-symbol { font-size: 32px; font-family: 'Cinzel', serif; font-weight: 900; color: var(--accent); position: relative; display: inline-block; animation: nullPulse 3s ease-in-out infinite; }
@keyframes nullPulse { 0%,100% { text-shadow: 0 0 0 transparent; } 50% { text-shadow: 0 0 15px rgba(200,184,154,0.5), 0 0 30px rgba(200,184,154,0.2); } }
.null-amount { font-family: 'Share Tech Mono', monospace; font-size: 28px; color: var(--white); letter-spacing: 3px; }
.null-tag { font-size: 9px; letter-spacing: 3px; color: #4a4a4a; text-transform: uppercase; }
.null-btn-add { font-size: 9px; letter-spacing: 3px; color: var(--accent); background: transparent; border: 1px solid rgba(200,184,154,0.3); padding: 5px 14px; cursor: pointer; font-family: 'Share Tech Mono', monospace; text-transform: uppercase; transition: all 0.3s; }
.null-btn-add:hover { background: var(--accent); color: var(--black); }

.bracelet-bar { background: linear-gradient(135deg, rgba(20,20,20,0.96), rgba(8,8,8,0.99)); border: 1px solid rgba(200,184,154,0.2); padding: 20px 28px; margin-bottom: 32px; position: relative; display: flex; align-items: center; gap: 28px; }
.bracelet-bar::before { content: 'MOODSWING DEVICE — ACTIVE INJECTION'; position: absolute; top: -10px; left: 18px; background: var(--black); padding: 0 10px; font-size: 9px; letter-spacing: 4px; color: var(--accent); }
.bracelet-visual { width: 60px; height: 60px; position: relative; flex-shrink: 0; }
.bracelet-ring { width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--accent); background: radial-gradient(circle at 40% 35%, rgba(200,184,154,0.15), transparent); position: relative; display: flex; align-items: center; justify-content: center; animation: braceRotate 8s linear infinite; }
@keyframes braceRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.bracelet-ring::before { content: ''; position: absolute; width: 8px; height: 8px; border-radius: 50%; background: var(--accent); top: -4px; left: 50%; transform: translateX(-50%); box-shadow: 0 0 8px rgba(200,184,154,0.8); }
.bracelet-inner { width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.8); border: 1px solid rgba(200,184,154,0.3); position: absolute; display: flex; align-items: center; justify-content: center; animation: braceRotate 8s linear infinite reverse; }
.bracelet-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 6px rgba(200,184,154,0.9); }
.bracelet-status { flex: 1; }
.bracelet-current-emotion { font-family: 'Cinzel', serif; font-size: 22px; font-weight: 700; letter-spacing: 4px; color: var(--white); margin-bottom: 4px; }
.bracelet-subtitle { font-size: 9px; letter-spacing: 3px; color: var(--gray-light); text-transform: uppercase; }
.inject-bar { height: 3px; background: var(--gray-mid); margin-top: 10px; position: relative; overflow: hidden; }
.inject-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--white)); width: 0%; transition: width 1.5s ease; }
.bracelet-intensity { text-align: right; flex-shrink: 0; }
.intensity-pct { font-size: 36px; font-family: 'Share Tech Mono', monospace; color: var(--white); line-height: 1; }
.intensity-label { font-size: 9px; letter-spacing: 3px; color: var(--gray-light); text-transform: uppercase; }

.market-section-title { font-size: 9px; letter-spacing: 6px; color: var(--accent); text-transform: uppercase; margin-bottom: 18px; padding-bottom: 8px; border-bottom: 1px solid rgba(200,184,154,0.1); display: flex; align-items: center; gap: 12px; }
.market-section-title::after { content: ''; flex: 1; height: 1px; background: rgba(200,184,154,0.08); }
.emotion-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-bottom: 44px; }
.emotion-card { background: linear-gradient(145deg, rgba(20,20,20,0.95), rgba(8,8,8,0.98)); border: 1px solid rgba(200,184,154,0.1); padding: 24px; position: relative; cursor: pointer; transition: all 0.35s; overflow: hidden; }
.emotion-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(200,184,154,0.04), transparent); transform: scaleX(0); transform-origin: left; transition: transform 0.35s ease; }
.emotion-card:hover::before { transform: scaleX(1); }
.emotion-card:hover { border-color: rgba(200,184,154,0.35); transform: translateY(-2px); box-shadow: 0 16px 40px rgba(0,0,0,0.6); }
.emotion-card.purchased { border-color: rgba(200,184,154,0.45); }
.emotion-card.active-injection { border-color: var(--accent); animation: cardPulse 2s ease-in-out infinite; }
@keyframes cardPulse { 0%,100% { box-shadow: 0 0 0 transparent; } 50% { box-shadow: 0 0 20px rgba(200,184,154,0.2); } }
.emotion-rarity { font-size: 8px; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.rarity-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.rarity-common { color: #666; } .rarity-dot.common { background: #666; }
.rarity-uncommon { color: #8a8; } .rarity-dot.uncommon { background: #8a8; }
.rarity-rare { color: #88a; } .rarity-dot.rare { background: #88a; }
.rarity-contraband { color: #a66; } .rarity-dot.contraband { background: #a44; box-shadow: 0 0 6px rgba(170,68,68,0.6); }
.emotion-name { font-family: 'Cinzel', serif; font-size: 20px; font-weight: 700; letter-spacing: 3px; color: var(--white); margin-bottom: 6px; line-height: 1.1; }
.emotion-latin { font-family: 'Crimson Text', serif; font-style: italic; font-size: 12px; color: var(--gray-light); margin-bottom: 12px; letter-spacing: 1px; }
.emotion-desc { font-family: 'Crimson Text', serif; font-size: 13px; color: #666; line-height: 1.65; margin-bottom: 16px; font-style: italic; }
.emotion-stats { display: flex; gap: 14px; margin-bottom: 16px; }
.emotion-stat { flex: 1; }
.emotion-stat-label { font-size: 8px; letter-spacing: 3px; color: #4a4a4a; text-transform: uppercase; margin-bottom: 4px; }
.emotion-stat-bar { height: 2px; background: var(--gray-mid); position: relative; overflow: hidden; }
.emotion-stat-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--white)); }
.emotion-footer { display: flex; justify-content: space-between; align-items: center; }
.emotion-price { display: flex; align-items: center; gap: 8px; }
.price-null { font-size: 18px; font-family: 'Cinzel', serif; color: var(--accent); font-weight: 700; }
.price-amount { font-size: 16px; font-family: 'Share Tech Mono', monospace; color: var(--white); }
.duration-badge { font-size: 8px; letter-spacing: 2px; color: #5a5a5a; text-transform: uppercase; }
.buy-btn { padding: 8px 18px; background: transparent; border: 1px solid var(--accent); color: var(--accent); font-family: 'Share Tech Mono', monospace; font-size: 10px; letter-spacing: 3px; cursor: pointer; text-transform: uppercase; transition: all 0.25s; position: relative; overflow: hidden; }
.buy-btn::before { content:''; position:absolute; inset:0; background:var(--accent); transform:scaleX(0); transform-origin:left; transition:transform 0.25s; z-index:-1; }
.buy-btn:hover::before { transform:scaleX(1); }
.buy-btn:hover { color: var(--black); }
.buy-btn.injecting { background: rgba(200,184,154,0.15); color: var(--accent); border-color: var(--accent); cursor: default; }
.buy-btn:disabled { opacity: 0.35; cursor: not-allowed; border-color: #3a3a3a; color: #3a3a3a; }
.buy-btn:disabled::before { display: none; }
.contraband-strip { background: repeating-linear-gradient(45deg, transparent, transparent 8px, rgba(170,50,50,0.06) 8px, rgba(170,50,50,0.06) 16px); border: 1px solid rgba(170,50,50,0.25); padding: 10px 16px; font-size: 9px; letter-spacing: 3px; color: rgba(170,80,80,0.7); text-transform: uppercase; margin-bottom: 12px; position: absolute; top: 0; left: 0; right: 0; }

.toast { position: fixed; bottom: 30px; right: 30px; z-index: 9500; background: rgba(10,10,10,0.96); border: 1px solid rgba(200,184,154,0.35); padding: 16px 24px; min-width: 280px; font-size: 11px; letter-spacing: 2px; color: var(--accent); transform: translateX(130%); transition: transform 0.45s cubic-bezier(0.22,1,0.36,1); pointer-events: none; text-transform: uppercase; }
.toast.show { transform: translateX(0); }
.toast-title { font-family: 'Cinzel', serif; font-size: 14px; margin-bottom: 4px; color: var(--white); }
.toast-body { color: var(--gray-light); font-size: 10px; letter-spacing: 2px; }

.back-btn { position: fixed; top: 22px; left: 22px; z-index: 500; background: rgba(5,5,5,0.7); border: 1px solid rgba(200,184,154,0.2); color: rgba(200,184,154,0.5); font-family: 'Share Tech Mono', monospace; font-size: 9px; letter-spacing: 4px; padding: 8px 16px; cursor: pointer; text-transform: uppercase; transition: all 0.3s; display: none; }
.back-btn.show { display: block; }
.back-btn:hover { color: var(--accent); border-color: var(--accent); }

.ticker-wrap { position: fixed; bottom: 0; left: 0; right: 0; z-index: 500; background: rgba(5,5,5,0.95); border-top: 1px solid rgba(200,184,154,0.08); overflow: hidden; height: 28px; display: none; }
.ticker-wrap.show { display: block; }
.ticker { display: flex; align-items: center; white-space: nowrap; animation: tickerScroll 40s linear infinite; height: 28px; }
@keyframes tickerScroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }
.ticker-item { font-size: 9px; letter-spacing: 3px; color: rgba(200,184,154,0.35); padding: 0 30px; text-transform: uppercase; }
.ticker-item.accent { color: rgba(200,184,154,0.55); }
.ticker-sep { color: rgba(200,184,154,0.12); padding: 0 5px; }

.flash-overlay { position: fixed; inset: 0; z-index: 9800; background: var(--white); opacity: 0; pointer-events: none; transition: opacity 0.15s ease; }
.flash-overlay.flash { opacity: 1; }

/* ===================== JUNCTION ===================== */
.junction-overlay { position: absolute; inset: 0; z-index: 400; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.9s ease; background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.75) 40%, rgba(0,0,0,0.85) 100%); }
.junction-overlay.show { opacity: 1; pointer-events: all; }
.junction-eyeline { font-size: 9px; letter-spacing: 7px; color: rgba(200,184,154,0.55); text-transform: uppercase; margin-bottom: 16px; text-align: center; }
.junction-title { font-family: 'Cinzel', serif; font-size: clamp(20px, 3.5vw, 38px); font-weight: 900; letter-spacing: 8px; color: var(--white); text-align: center; margin-bottom: 6px; text-shadow: 0 0 30px rgba(240,237,230,0.15); }
.junction-subtitle { font-family: 'Crimson Text', serif; font-style: italic; font-size: 14px; color: rgba(200,184,154,0.65); margin-bottom: 44px; text-align: center; letter-spacing: 1px; }
.junction-choices { display: flex; gap: 24px; align-items: stretch; }
.junction-card { width: 240px; padding: 28px 24px; background: rgba(8,8,8,0.92); border: 1px solid rgba(200,184,154,0.2); cursor: pointer; position: relative; overflow: hidden; transition: all 0.4s cubic-bezier(0.22,1,0.36,1); display: flex; flex-direction: column; align-items: center; text-align: center; }
.junction-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(200,184,154,0.07), transparent); opacity: 0; transition: opacity 0.35s ease; }
.junction-card:hover::before { opacity: 1; }
.junction-card:hover { border-color: rgba(200,184,154,0.55); transform: translateY(-4px); box-shadow: 0 20px 50px rgba(0,0,0,0.7), 0 0 30px rgba(200,184,154,0.06); }
.junction-card-icon { font-size: 38px; margin-bottom: 14px; line-height: 1; font-family: 'Cinzel', serif; font-weight: 900; color: var(--accent); }
.junction-card-name { font-family: 'Cinzel', serif; font-size: 16px; font-weight: 700; letter-spacing: 5px; color: var(--white); margin-bottom: 8px; text-transform: uppercase; }
.junction-card-desc { font-family: 'Crimson Text', serif; font-style: italic; font-size: 12px; color: rgba(136,136,136,0.85); line-height: 1.6; margin-bottom: 18px; }
.junction-card-tag { font-size: 8px; letter-spacing: 4px; color: var(--accent); text-transform: uppercase; border: 1px solid rgba(200,184,154,0.25); padding: 4px 12px; margin-top: auto; }
.junction-card.ruinbow-card .junction-card-icon { color: #b87a3a; }
.junction-card.ruinbow-card:hover { border-color: rgba(184,122,58,0.5); box-shadow: 0 20px 50px rgba(0,0,0,0.7), 0 0 30px rgba(184,122,58,0.08); }
.junction-card.ruinbow-card .junction-card-tag { color: #b87a3a; border-color: rgba(184,122,58,0.3); }
.junction-divider { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; padding: 0 4px; }
.junction-divider-line { width: 1px; height: 60px; background: rgba(200,184,154,0.15); }
.junction-divider-text { font-size: 9px; letter-spacing: 2px; color: rgba(200,184,154,0.35); text-transform: uppercase; writing-mode: vertical-lr; }

/* ===================== SCREEN 4: RUINBOW ===================== */
#screenRuinbow { background: #040408; overflow: hidden; flex-direction: column; justify-content: flex-start; }
.ruinbow-inner { width: 100%; height: 100%; overflow-y: auto; overflow-x: hidden; padding: 36px 28px 80px; scrollbar-width: thin; scrollbar-color: #b87a3a transparent; }
.ruinbow-inner::-webkit-scrollbar { width: 2px; }
.ruinbow-inner::-webkit-scrollbar-thumb { background: #b87a3a; }
.ruinbow-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; border-bottom: 1px solid rgba(184,122,58,0.2); padding-bottom: 24px; }
.ruinbow-logo { font-size: 10px; letter-spacing: 5px; color: #6a4a2a; text-transform: uppercase; margin-bottom: 6px; }
.ruinbow-title { font-family: 'Cinzel', serif; font-size: clamp(26px, 4.5vw, 50px); font-weight: 900; letter-spacing: 5px; line-height: 1; background: linear-gradient(135deg, #e8a850 0%, #b87a3a 50%, #5a3a1a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.ruinbow-subtitle { font-size: 9px; letter-spacing: 4px; color: #6a4a2a; margin-top: 6px; text-transform: uppercase; }
.ruinbow-null-display { text-align: right; }
.ruinbow-null-label { font-size: 9px; letter-spacing: 3px; color: #6a4a2a; text-transform: uppercase; margin-bottom: 4px; }
.ruinbow-null-amount { display: flex; align-items: center; gap: 10px; justify-content: flex-end; }
.ruinbow-null-sym { font-family: 'Cinzel', serif; font-size: 28px; font-weight: 900; color: #b87a3a; }
.ruinbow-null-val { font-size: 26px; font-family: 'Share Tech Mono'; color: var(--white); }
.factory-floor { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px; }
.distill-engine { grid-column: 1 / -1; background: linear-gradient(145deg, rgba(15,12,20,0.97), rgba(6,5,10,0.99)); border: 1px solid rgba(184,122,58,0.25); padding: 32px; position: relative; overflow: hidden; cursor: pointer; transition: all 0.2s; user-select: none; }
.distill-engine::before { content: 'EMOTION DISTILLERY — UNIT 7'; position: absolute; top: -10px; left: 18px; background: #040408; padding: 0 10px; font-size: 9px; letter-spacing: 4px; color: #b87a3a; }
.distill-engine:hover { border-color: rgba(184,122,58,0.5); }
.distill-engine:active { transform: scale(0.99); }
.distill-engine-inner { display: flex; align-items: center; gap: 32px; }
.machine-visual { flex-shrink: 0; width: 160px; height: 160px; position: relative; }
#machineCanvas { width: 160px; height: 160px; display: block; }
.distill-info { flex: 1; }
.ore-type-label { font-size: 9px; letter-spacing: 4px; color: #6a4a2a; text-transform: uppercase; margin-bottom: 8px; }
.ore-type-name { font-family: 'Cinzel', serif; font-size: 24px; font-weight: 700; letter-spacing: 3px; margin-bottom: 4px; }
.ore-type-desc { font-family: 'Crimson Text', serif; font-style: italic; font-size: 13px; color: #5a5a6a; line-height: 1.65; margin-bottom: 16px; }
.distill-progress-wrap { margin-bottom: 12px; }
.distill-progress-label { display: flex; justify-content: space-between; font-size: 9px; letter-spacing: 3px; color: #5a5a6a; margin-bottom: 6px; text-transform: uppercase; }
.distill-progress-bar { height: 6px; background: rgba(184,122,58,0.12); position: relative; overflow: hidden; }
.distill-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #5a3a6a, #e8a850); transition: width 0.15s linear; box-shadow: 0 0 10px rgba(232,168,80,0.4); }
.distill-cta { font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 6px; color: #b87a3a; text-transform: uppercase; margin-top: 6px; animation: ctaPulse 2s ease-in-out infinite; }
@keyframes ctaPulse { 0%,100%{opacity:0.5} 50%{opacity:1} }
.distill-reward { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
.reward-sym { font-family:'Cinzel',serif; font-size:20px; color:#b87a3a; }
.reward-amt { font-size:18px; font-family:'Share Tech Mono'; color:var(--white); }
.reward-label { font-size:9px; letter-spacing:3px; color:#5a5a6a; text-transform:uppercase; }
.ore-panel { background: linear-gradient(145deg, rgba(14,10,6,0.97), rgba(6,4,2,0.99)); border: 1px solid rgba(184,122,58,0.15); padding: 24px; position: relative; }
.ore-panel::before { content: 'ORE INVENTORY'; position: absolute; top: -10px; left: 14px; background: #040408; padding: 0 10px; font-size: 9px; letter-spacing: 4px; color: #b87a3a; }
.ore-list { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
.ore-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(184,122,58,0.05); border: 1px solid rgba(184,122,58,0.1); cursor: pointer; transition: all 0.25s; position: relative; }
.ore-item:hover { border-color: rgba(184,122,58,0.3); background: rgba(184,122,58,0.1); }
.ore-item.active-ore { border-color: rgba(232,168,80,0.5); background: rgba(184,122,58,0.15); }
.ore-gem { width: 28px; height: 28px; border-radius: 4px; flex-shrink: 0; transform: rotate(45deg); position: relative; }
.ore-item-name { font-family:'Cinzel',serif; font-size:12px; letter-spacing:2px; color:var(--white); }
.ore-item-desc { font-size:9px; letter-spacing:1px; color:#5a5a6a; text-transform:uppercase; margin-top:2px; }
.ore-item-yield { margin-left: auto; font-family:'Share Tech Mono'; font-size:14px; color:#b87a3a; flex-shrink: 0; }
.ore-item-active-dot { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 6px; height: 6px; border-radius: 50%; background: #e8a850; box-shadow: 0 0 8px rgba(232,168,80,0.8); display: none; }
.ore-item.active-ore .ore-item-active-dot { display: block; }
.output-panel { background: linear-gradient(145deg, rgba(14,10,6,0.97), rgba(6,4,2,0.99)); border: 1px solid rgba(184,122,58,0.15); padding: 24px; position: relative; max-height: 280px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #5a3a1a transparent; }
.output-panel::before { content: 'DISTILLATION LOG'; position: absolute; top: -10px; left: 14px; background: #040408; padding: 0 10px; font-size: 9px; letter-spacing: 4px; color: #b87a3a; }
.log-entry { font-size: 10px; letter-spacing: 2px; color: #5a5a7a; margin-bottom: 5px; text-transform: uppercase; display: flex; gap: 8px; align-items: center; animation: logFade 0.4s ease both; }
@keyframes logFade { from{opacity:0; transform:translateX(-8px)} to{opacity:1; transform:none} }
.log-entry.success { color: #8a9a8a; }
.log-entry.highlight { color: #e8a850; }
.log-time { color: #3a3a4a; flex-shrink: 0; }
.transfer-btn { display: block; width: 100%; margin-top: 20px; padding: 18px; background: transparent; border: 1px solid #b87a3a; color: #b87a3a; font-family: 'Cinzel', serif; font-size: 13px; font-weight: 700; letter-spacing: 8px; text-transform: uppercase; cursor: pointer; position: relative; overflow: hidden; transition: all 0.35s; }
.transfer-btn::before { content:''; position:absolute; inset:0; background:#b87a3a; transform:scaleX(0); transform-origin:left; transition:transform 0.35s ease; z-index:-1; }
.transfer-btn:hover::before { transform:scaleX(1); }
.transfer-btn:hover { color: #040408; }
.transfer-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.transfer-btn:disabled::before { display:none; }
.ruinbow-particles { position: fixed; inset: 0; pointer-events: none; z-index: 1; overflow: hidden; }
.r-particle { position: absolute; border-radius: 50%; background: radial-gradient(circle, rgba(184,122,58,0.6), transparent); animation: particleDrift linear infinite; }
@keyframes particleDrift { from { transform: translateY(110vh) translateX(0); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 0.4; } to { transform: translateY(-10vh) translateX(var(--drift)); opacity: 0; } }

.nav-hub { position: fixed; bottom: 34px; left: 50%; transform: translateX(-50%); display: none; align-items: center; gap: 0; z-index: 600; background: rgba(6,6,6,0.96); border: 1px solid rgba(200,184,154,0.15); box-shadow: 0 8px 40px rgba(0,0,0,0.7); }
.nav-hub.show { display: flex; }
.nav-btn { padding: 12px 22px; background: transparent; border: none; color: #5a5a6a; font-family: 'Share Tech Mono'; font-size: 9px; letter-spacing: 3px; text-transform: uppercase; cursor: pointer; transition: all 0.25s; border-right: 1px solid rgba(200,184,154,0.1); white-space: nowrap; }
.nav-btn:last-child { border-right: none; }
.nav-btn:hover { color: var(--accent); background: rgba(200,184,154,0.04); }
.nav-btn.active { color: var(--accent); }
.nav-btn.ruinbow-nav:hover { color: #e8a850; }
.nav-btn.ruinbow-nav.active { color: #e8a850; }

.session-stats { display: flex; gap: 24px; margin-top: 16px; padding: 12px 18px; background: rgba(15,15,15,0.8); border: 1px solid rgba(200,184,154,0.08); opacity: 0; transition: opacity 0.5s ease; pointer-events: none; }
.session-stats.show { opacity: 1; pointer-events: all; }
.stat-chip { display: flex; flex-direction: column; gap: 2px; }
.stat-chip-label { font-size: 8px; letter-spacing: 3px; color: #4a4a4a; text-transform: uppercase; }
.stat-chip-val { font-size: 14px; font-family: 'Share Tech Mono'; color: var(--accent); }

@media (max-width: 700px) {
  .sliders-row { grid-template-columns: 1fr; }
  .output-grid { grid-template-columns: 1fr; }
  .market-header { flex-direction: column; gap: 16px; }
  .null-wallet { align-items: flex-start; }
  .emotion-grid { grid-template-columns: 1fr; }
  .junction-choices { flex-direction: column; align-items: center; gap: 12px; }
  .junction-card { width: 90%; }
  .junction-divider { flex-direction: row; padding: 0; gap: 12px; }
  .junction-divider-line { width: 40px; height: 1px; }
  .factory-floor { grid-template-columns: 1fr; }
  .distill-engine-inner { flex-direction: column; }
  .nav-hub { width: 90%; justify-content: center; flex-wrap: wrap; }
}


/* ===================== NAV BAR ===================== */

/* ===================== CINEMATIC NAV HUD ===================== */
.world-nav {
  position: fixed; top: 0; left: 0; z-index: 99999;
  pointer-events: none; font-family: 'Share Tech Mono', monospace;
}
.world-nav > * { pointer-events: all; }

.nav-hud-toggle {
  background: rgba(5,5,5,0.6); backdrop-filter: blur(10px);
  border: 1px solid rgba(200,184,154,0.08); border-top: none; border-left: none;
  color: rgba(200,184,154,0.45); font-family: 'Cinzel', serif;
  font-size: 15px; font-weight: 700; padding: 10px 16px;
  cursor: pointer; transition: all 0.4s, opacity 0.6s ease; letter-spacing: 2px;
  opacity: 0; pointer-events: none;
}
.nav-hud-toggle.revealed { opacity: 1; pointer-events: all; }
.nav-hud-toggle:hover { color: rgba(200,184,154,0.9); background: rgba(5,5,5,0.9); }
.nav-hud-toggle .toggle-icon { transition: transform 0.3s; display: inline-block; }
.nav-hud-toggle.open .toggle-icon { transform: rotate(90deg); }

.nav-hud-panel {
  position: fixed; top: 0; left: 0; width: 220px; height: 100vh;
  background: rgba(4,4,4,0.98); backdrop-filter: blur(30px);
  border-right: none;
  transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.22,1,0.36,1);
  z-index: 100000; display: flex; flex-direction: column;
  padding: 48px 0 0; pointer-events: all;
}
.nav-hud-panel.open { transform: translateX(0); }

.nav-hud-close {
  position: absolute; top: 14px; right: 14px;
  background: none; border: none; color: rgba(200,184,154,0.15);
  font-size: 14px; cursor: pointer; padding: 4px 8px;
  font-family: 'Share Tech Mono', monospace; transition: color 0.3s;
}
.nav-hud-close:hover { color: rgba(200,184,154,0.6); }

.nav-hud-brand { padding: 0 24px 20px; margin-bottom: 8px; }
.nav-hud-brand-title { font-family: 'Cinzel', serif; font-size: 17px; font-weight: 900; letter-spacing: 7px; color: rgba(240,237,230,0.6); }
.nav-hud-brand-sub { font-size: 7px; letter-spacing: 4px; color: rgba(200,184,154,0.15); text-transform: uppercase; margin-top: 4px; }

.nav-hud-item {
  display: flex; align-items: center; gap: 12px;
  padding: 11px 24px; background: none; border: none; text-align: left;
  color: rgba(255,255,255,0.25); font-family: 'Share Tech Mono', monospace;
  font-size: 9px; letter-spacing: 4px; cursor: pointer;
  transition: all 0.25s; text-transform: uppercase; position: relative; width: 100%;
}
.nav-hud-item:hover { color: rgba(255,255,255,0.7); }
.nav-hud-item.active { color: rgba(240,237,230,0.8); }
.nav-hud-item.active::before { content: ''; position: absolute; left: 0; top: 20%; bottom: 20%; width: 1px; background: rgba(200,184,154,0.4); }
.nav-hud-item .item-dot { width: 4px; height: 4px; border-radius: 50%; opacity: 0.25; transition: all 0.3s; flex-shrink: 0; }
.nav-hud-item.active .item-dot { opacity: 0.8; box-shadow: 0 0 6px currentColor; }
.nav-hud-item.veil-item .item-dot { background: #fff; }
.nav-hud-item.veil-item.active { color: #fff; }
.nav-hud-item.forge-item .item-dot { background: #c8b89a; }
.nav-hud-item.forge-item.active { color: #c8b89a; }
.nav-hud-item.locked { opacity: 0.12; pointer-events: none; }
.nav-hud-item.locked .item-lock { font-size: 7px; margin-left: auto; opacity: 0.4; }

.nav-hud-divider { height: 1px; background: rgba(200,184,154,0.03); margin: 6px 24px; }

.nav-hud-exit { padding: 14px 24px; }

.nav-offline-section { margin-top: auto; padding: 0; }
.nav-offline-label {
  padding: 0 24px 6px; font-family: 'Share Tech Mono', monospace;
  font-size: 6px; letter-spacing: 5px; color: rgba(200,184,154,0.08);
  text-transform: uppercase;
}
.nav-hud-item.offline-item { opacity: 0.3; font-size: 8px; letter-spacing: 3px; padding: 8px 24px; }
.nav-hud-item.offline-item:hover { opacity: 0.6; }
.nav-hud-item.offline-item.active { opacity: 0.7; }
.nav-hud-item.offline-item .item-dot { width: 3px; height: 3px; }
.nav-hud-exit a { display: flex; align-items: center; gap: 10px; color: rgba(255,255,255,0.1); text-decoration: none; font-size: 7px; letter-spacing: 4px; text-transform: uppercase; transition: color 0.3s; font-family: 'Share Tech Mono', monospace; }
.nav-hud-exit a:hover { color: rgba(255,255,255,0.4); }

.nav-hud-backdrop { position: fixed; inset: 0; z-index: 99999; background: rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: opacity 0.4s; }
.nav-hud-backdrop.open { opacity: 1; pointer-events: all; }

.world-container {
  display: none;
}
.world-container.active {
  display: block;
}
#forgeWorld.active {
  display: block;
}
#veilWorld {
  padding-top: 42px;
}
#forgeWorld {
  padding-top: 0;
}
/* Forge screens need top offset for nav */
#forgeWorld .screen {
  top: 42px;
  height: calc(100vh - 42px);
}
#forgeWorld .grain,
#forgeWorld .vignette,
#forgeWorld .scanlines {
  top: 42px;
}
/* When world-container is not active, display:none hides all fixed children too */


/* ===================== VEIL STYLES ===================== */

/* ===================== VEIL WORLD STYLES ===================== */
#veilWorld {
  --bg: #000000;
  --bg-card: rgba(10, 10, 10, 0.95);
  --veil-border: rgba(255, 255, 255, 0.15);
  --text: #ffffff;
  --text-dim: #999999;
  --lux: #00a8ff;
  --lux-glow: rgba(0, 168, 255, 0.5);
  --nox: #ff0040;
  --nox-glow: rgba(255, 0, 64, 0.5);
  --accent: #ffffff;
  --accent-glow: rgba(255, 255, 255, 0.3);
}

#veilWorld {
  font-family: 'Orbitron', monospace;
  background: #000;
  color: #fff;
  min-height: 100vh;
  position: relative;
}

/* VEIL Background */
#veilWorld .cyberBg {
  position: fixed; inset: 0; z-index: 0;
  background: 
    radial-gradient(circle at 20% 50%, rgba(0,168,255,0.05) 0%, transparent 50%),
    radial-gradient(circle at 80% 50%, rgba(255,0,64,0.05) 0%, transparent 50%),
    linear-gradient(180deg, #000 0%, #0a0a0a 100%);
  top: 42px;
}
#veilWorld .gridOverlay {
  position: absolute; inset: 0;
  background-image: 
    linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
  background-size: 50px 50px; opacity: 0.3;
}
#veilWorld .scanlineEffect {
  position: absolute; inset: 0;
  background: repeating-linear-gradient(0deg, rgba(255,255,255,0.02) 0px, transparent 2px, transparent 4px);
  animation: veilScanlines 8s linear infinite;
  pointer-events: none;
}
@keyframes veilScanlines {
  0% { transform: translateY(0); }
  100% { transform: translateY(50px); }
}
#veilWorld .noiseEffect {
  position: absolute; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
  opacity: 0.4; animation: veilNoise 0.2s steps(10) infinite; pointer-events: none;
}
@keyframes veilNoise {
  0%, 100% { transform: translate(0); }
  10% { transform: translate(-5%,-5%); }
  30% { transform: translate(-5%,5%); }
  50% { transform: translate(-2%,2%); }
  70% { transform: translate(-2%,-2%); }
  90% { transform: translate(0); }
}
#veilWorld .radialGlow {
  position: absolute; inset: 0;
  background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.03) 0%, transparent 70%);
  pointer-events: none;
}

/* Animations */
@keyframes veilFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes veilSlideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
@keyframes veilGlitch { 0% { transform: translate(0); } 20% { transform: translate(-2px,2px); } 40% { transform: translate(-2px,-2px); } 60% { transform: translate(2px,2px); } 80% { transform: translate(2px,-2px); } 100% { transform: translate(0); } }
@keyframes veilPulse { 0%,100% { opacity:0.4; transform:scale(1); } 50% { opacity:1; transform:scale(1.1); } }

#veilWorld .fadeIn { animation: veilFadeIn 0.5s ease-out; }
#veilWorld .slideIn { animation: veilSlideIn 0.4s ease-out backwards; }

/* Layout */
#veilWorld .wrap {
  position: relative; z-index: 10;
  max-width: 1400px; margin: 0 auto;
  padding: 40px 20px 80px;
}

/* Header */
#veilWorld .mainHeader { margin-bottom: 40px; transition: all 0.3s ease; }
#veilWorld .veil-systemName { transition: all 0.3s ease; }
#veilWorld .veil-systemName:hover {
  background: linear-gradient(90deg, var(--nox) 0%, var(--lux) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: none;
}
#veilWorld .headerContent {
  display: flex; justify-content: space-between; align-items: center;
  flex-wrap: wrap; gap: 20px; margin-bottom: 20px;
}
#veilWorld .logoArea { display: flex; align-items: center; gap: 20px; }
#veilWorld .hexIcon {
  width: 50px; height: 50px; color: #fff;
  filter: drop-shadow(0 0 10px var(--accent-glow));
  animation: veilPulse 3s ease-in-out infinite;
}
#veilWorld .veil-systemName {
  font-size: 32px; font-weight: 900; letter-spacing: 8px; color: #fff;
  text-shadow: 0 0 20px var(--accent-glow);
}
#veilWorld .glitchText { position: relative; display: inline-block; }
#veilWorld .glitchText:hover::before, #veilWorld .glitchText:hover::after {
  content: attr(data-text); position: absolute; left: 0; top: 0; width: 100%; height: 100%;
}
#veilWorld .glitchText:hover::before {
  color: var(--lux); animation: veilGlitch 0.3s cubic-bezier(0.25,0.46,0.45,0.94);
  clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
}
#veilWorld .glitchText:hover::after {
  color: var(--nox); animation: veilGlitch 0.3s cubic-bezier(0.25,0.46,0.45,0.94) reverse;
  clip-path: polygon(0 55%, 100% 55%, 100% 100%, 0 100%);
}
#veilWorld .systemSub { font-size: 10px; letter-spacing: 2px; color: var(--text-dim); margin-top: 4px; }
#veilWorld .statusIndicator {
  display: flex; align-items: center; gap: 10px; padding: 8px 16px;
  background: var(--bg-card); border: 1px solid var(--veil-border); border-radius: 20px;
  backdrop-filter: blur(10px);
}
#veilWorld .statusDot {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--text-dim); box-shadow: 0 0 10px currentColor;
  animation: veilPulse 2s ease-in-out infinite;
}
#veilWorld .statusDot[data-status="OFFLINE"] { background: #666; }
#veilWorld .statusDot[data-status="BOOT"] { background: #fff; }
#veilWorld .statusDot[data-status="SCAN"] { background: #fff; }
#veilWorld .statusDot[data-status="LOCK"] { background: var(--lux); }
#veilWorld .statusText { font-size: 11px; letter-spacing: 2px; font-weight: 700; }
#veilWorld .headerDesc { font-size: 13px; line-height: 1.6; color: var(--text-dim); max-width: 800px; margin-bottom: 20px; }
#veilWorld .headerActions { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }

/* Buttons */
#veilWorld .cyberBtn {
  position: relative; display: inline-flex; align-items: center; gap: 10px;
  padding: 12px 24px; background: transparent; border: 2px solid var(--veil-border);
  color: #fff; font-family: 'Orbitron', monospace; font-size: 12px; font-weight: 700;
  letter-spacing: 2px; cursor: pointer; overflow: hidden; transition: all 0.3s ease;
  text-transform: uppercase;
}
#veilWorld .cyberBtn::before {
  content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transition: left 0.5s;
}
#veilWorld .cyberBtn:hover::before { left: 100%; }
#veilWorld .cyberBtn:hover {
  border-color: #fff; box-shadow: 0 0 20px var(--accent-glow); transform: translateY(-2px);
}
#veilWorld .cyberBtn:active { transform: translateY(0); }
#veilWorld .cyberBtn.primary {
  background: linear-gradient(135deg, var(--lux) 0%, var(--nox) 100%);
  border: none;
  color: #fff;
  text-shadow: 0 1px 3px rgba(0,0,0,0.4);
  overflow: visible;
}
#veilWorld .cyberBtn.primary::before {
  display: none;
}
#veilWorld .cyberBtn.primary span {
  position: relative;
  z-index: 2;
}
#veilWorld .cyberBtn.primary:hover {
  border: none;
  box-shadow: 0 0 25px var(--lux-glow), 0 0 25px var(--nox-glow);
}
#veilWorld .cyberBtn.secondary { border-color: var(--text-dim); color: var(--text-dim); }
#veilWorld .cyberBtn.secondary:hover { border-color: #fff; color: #fff; }
#veilWorld .cyberBtn.forge-link {
  background: linear-gradient(135deg, #c8b89a 0%, #8a7a6a 100%);
  border: 2px solid rgba(200,184,154,0.4);
  color: #050505;
  font-weight: 900;
}
#veilWorld .cyberBtn.forge-link:hover {
  border-color: #c8b89a;
  box-shadow: 0 0 20px rgba(200,184,154,0.4);
}
#veilWorld .cyberBtn.exit-veil {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.15);
  color: var(--text-dim);
  font-size: 10px;
  letter-spacing: 3px;
  padding: 10px 24px;
}
#veilWorld .cyberBtn.exit-veil:hover {
  border-color: rgba(255,255,255,0.4);
  color: #fff;
  box-shadow: none;
}
#veilWorld .btnArrow { transition: transform 0.3s ease; }
#veilWorld .cyberBtn:hover .btnArrow { transform: translateX(5px); }

/* Interface */
#veilWorld .interfacePanel {
  background: var(--bg-card); border: 1px solid var(--veil-border); border-radius: 4px;
  padding: 30px; backdrop-filter: blur(20px); box-shadow: 0 10px 50px rgba(0,0,0,0.5);
}
#veilWorld .stateIcon { font-size: 80px; margin-bottom: 20px; text-align: center; opacity: 0.3; filter: blur(1px); }
#veilWorld .stateIcon.bootIcon { color: var(--text-dim); }
#veilWorld .stateIcon.verdictIcon.lux { color: var(--lux); text-shadow: 0 0 30px var(--lux-glow); opacity: 1; filter: none; }
#veilWorld .stateIcon.verdictIcon.nox { color: var(--nox); text-shadow: 0 0 30px var(--nox-glow); opacity: 1; filter: none; }
#veilWorld .stateTitle { font-size: 24px; font-weight: 900; letter-spacing: 4px; text-align: center; margin-bottom: 15px; }
#veilWorld .stateDesc { font-size: 13px; line-height: 1.6; color: var(--text-dim); text-align: center; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto; }

/* Boot */
#veilWorld .bootSequence {
  background: rgba(0,0,0,0.5); border: 1px solid var(--veil-border); border-radius: 2px;
  padding: 20px; font-family: 'Courier New', monospace; font-size: 12px;
  max-height: 300px; overflow-y: auto; margin-bottom: 20px;
}
#veilWorld .bootLine { margin-bottom: 8px; opacity: 0; animation: veilFadeIn 0.2s ease-out forwards; color: var(--text-dim); }
#veilWorld .bootLine.success { color: var(--text-dim); }
#veilWorld .bootLine.warn { color: #fff; }
#veilWorld .bootLine.error { color: var(--nox); }

/* Question UI */
#veilWorld .questionHeader { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
#veilWorld .qNumber { font-size: 11px; letter-spacing: 2px; color: var(--text-dim); font-weight: 700; }
#veilWorld .qCategory { font-size: 13px; letter-spacing: 2px; color: var(--lux); font-weight: 700; }
#veilWorld .qPrompt { font-size: 20px; font-weight: 700; line-height: 1.4; margin-bottom: 15px; }
#veilWorld .qSystem { font-size: 12px; color: var(--text-dim); margin-bottom: 25px; padding: 12px; background: rgba(0,0,0,0.3); border-left: 3px solid var(--lux); border-radius: 2px; }
#veilWorld .sysLabel { color: var(--lux); font-weight: 700; letter-spacing: 1px; }
#veilWorld .dataDivider { height: 1px; background: linear-gradient(90deg, transparent, var(--veil-border), transparent); margin: 25px 0; }

/* Choices */
#veilWorld .choiceGrid { display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
#veilWorld .choiceBtn {
  position: relative; display: flex; flex-direction: column; align-items: flex-start;
  padding: 20px; background: rgba(0,0,0,0.3); border: 2px solid var(--veil-border);
  color: #fff; font-family: 'Orbitron', monospace; cursor: pointer; transition: all 0.3s ease; text-align: left; overflow: hidden;
}
#veilWorld .choiceBtn::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, var(--lux-glow) 0%, var(--nox-glow) 100%);
  opacity: 0; transition: opacity 0.3s;
}
#veilWorld .choiceBtn:hover::before { opacity: 0.15; }
#veilWorld .choiceBtn:hover { border-color: #fff; transform: translateX(5px); box-shadow: 0 5px 20px rgba(255,255,255,0.1); }
#veilWorld .choiceMain { position: relative; font-size: 15px; font-weight: 700; margin-bottom: 8px; z-index: 1; }
#veilWorld .choiceNote { position: relative; font-size: 11px; color: var(--text-dim); line-height: 1.4; margin-bottom: 10px; z-index: 1; }
#veilWorld .choiceArrow { position: absolute; right: 20px; bottom: 20px; font-size: 20px; color: var(--text-dim); transition: all 0.3s ease; z-index: 1; }
#veilWorld .choiceBtn:hover .choiceArrow { color: #fff; transform: translateX(5px); }

/* Slider */
#veilWorld .sliderContainer { max-width: 600px; margin: 0 auto; }
#veilWorld .sliderLabels { display: flex; justify-content: space-between; margin-bottom: 25px; font-size: 14px; font-weight: 700; gap: 20px; }
#veilWorld .sliderTrack { position: relative; margin-bottom: 20px; padding-top: 50px; }
#veilWorld .cyberSlider {
  width: 100%; height: 8px; -webkit-appearance: none; appearance: none;
  background: linear-gradient(90deg, var(--nox) 0%, var(--text-dim) 50%, var(--lux) 100%);
  outline: none; border-radius: 10px; cursor: pointer;
}
#veilWorld .cyberSlider::-webkit-slider-thumb {
  -webkit-appearance: none; width: 24px; height: 24px; background: #fff;
  cursor: pointer; border-radius: 50%; box-shadow: 0 0 20px var(--accent-glow);
}
#veilWorld .cyberSlider::-moz-range-thumb {
  width: 24px; height: 24px; background: #fff; cursor: pointer; border-radius: 50%; border: none;
  box-shadow: 0 0 20px var(--accent-glow);
}
#veilWorld .sliderValue { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); font-size: 24px; font-weight: 900; color: #fff; text-shadow: 0 0 20px var(--accent-glow); }
#veilWorld .sliderMarkers { display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 11px; letter-spacing: 2px; }

/* Text Input */
#veilWorld .textInputContainer { max-width: 600px; margin: 0 auto; }
#veilWorld .inputLabel { font-size: 13px; color: var(--text-dim); margin-bottom: 15px; text-align: center; }
#veilWorld .inputGroup { display: flex; gap: 10px; align-items: stretch; }
#veilWorld .cyberInput {
  flex: 1; padding: 12px 20px; background: rgba(0,0,0,0.5); border: 2px solid var(--veil-border);
  color: #fff; font-family: 'Orbitron', monospace; font-size: 14px; outline: none; transition: all 0.3s ease;
}
#veilWorld .cyberInput:focus { border-color: var(--lux); box-shadow: 0 0 20px var(--lux-glow); }
#veilWorld .cyberInput::placeholder { color: var(--text-dim); opacity: 0.5; }

/* Verdict */
#veilWorld .verdictPanel { background: rgba(0,0,0,0.5); border: 1px solid var(--veil-border); border-radius: 2px; padding: 25px; }
#veilWorld .verdictVisual { display: flex; justify-content: center; align-items: center; margin-bottom: 30px; gap: 40px; }
#veilWorld .maskDisplay { width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; position: relative; }
#veilWorld .maskSvg { width: 100%; height: 100%; filter: drop-shadow(0 0 30px currentColor); }
#veilWorld .maskSvg.lux { color: var(--lux); fill: #fff; }
#veilWorld .maskSvg.nox { color: var(--nox); fill: #000; }
#veilWorld .verdictHeader { font-size: 13px; font-weight: 700; letter-spacing: 2px; color: #fff; margin-bottom: 20px; text-align: center; }
#veilWorld .verdictData { margin-bottom: 25px; }
#veilWorld .verdictRow { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 12px; }
#veilWorld .verdictRow span:first-child { color: var(--text-dim); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
#veilWorld .verdictRow.highlight { border-color: var(--veil-border); margin-top: 10px; padding-top: 20px; }
#veilWorld .verdictActions { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }

/* Instability Mask */
#veilWorld .instabilityMask { width: 150px; height: 150px; margin: 30px auto; position: relative; display: flex; align-items: center; justify-content: center; }
#veilWorld .instabilityMask svg { width: 100%; height: 100%; transition: all 0.3s ease; }
@keyframes veilMaskShift { 0%,100% { transform: translate(0) rotate(0); } 25% { transform: translate(-1px,1px) rotate(-0.5deg); } 50% { transform: translate(1px,-1px) rotate(0.5deg); } 75% { transform: translate(-1px,-1px) rotate(-0.3deg); } }
@keyframes veilMaskFlicker { 0%,100% { opacity: 1; } 50% { opacity: 0.85; } }
#veilWorld .instabilityMask.active svg { filter: drop-shadow(0 0 8px rgba(255,255,255,0.4)) brightness(1.1); animation: veilMaskShift 4s ease-in-out infinite, veilMaskFlicker 2s ease-in-out infinite; }
#veilWorld .instabilityMask.contaminating-lux svg { fill: #fff; filter: drop-shadow(0 0 12px rgba(0,168,255,0.6)) brightness(1.2); animation: veilMaskShift 3s ease-in-out infinite, veilMaskFlicker 2s ease-in-out infinite; }
#veilWorld .instabilityMask.contaminating-nox svg { fill: #000; filter: drop-shadow(0 0 12px rgba(255,0,64,0.6)); animation: veilMaskShift 3s ease-in-out infinite, veilMaskFlicker 2s ease-in-out infinite; }
#veilWorld .instabilityMask.leaning-nox svg { fill: #000; filter: drop-shadow(0 0 8px rgba(255,0,64,0.5)); }
#veilWorld .instabilityMask.leaning-lux svg { fill: #fff; filter: drop-shadow(0 0 8px rgba(0,168,255,0.5)) brightness(1.15); }
#veilWorld .instabilityStatus { text-align: center; margin-top: 20px; font-size: 11px; letter-spacing: 2px; color: var(--text-dim); opacity: 0.7; animation: veilPulse 2s ease-in-out infinite; }

/* Balance bars */
#veilWorld .balanceBars { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
#veilWorld .balanceBar { text-align: center; padding: 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--veil-border); border-radius: 2px; }
#veilWorld .balanceValue { font-size: 28px; font-weight: 900; margin-bottom: 10px; }
#veilWorld .balanceValue.lux { color: var(--lux); text-shadow: 0 0 20px var(--lux-glow); }
#veilWorld .balanceValue.nox { color: var(--nox); text-shadow: 0 0 20px var(--nox-glow); }
#veilWorld .balanceLabel { font-size: 11px; letter-spacing: 2px; font-weight: 700; color: var(--text-dim); }
#veilWorld .luxLabel { color: var(--lux); }
#veilWorld .noxLabel { color: var(--nox); }
#veilWorld .neutralLabel { color: var(--text-dim); }

/* Progress */
#veilWorld .progressArea { margin-top: 30px; }

/* VEIL Responsive */
@media (max-width: 768px) {
  #veilWorld .wrap { padding: 20px 14px 60px; }
  #veilWorld .veil-systemName { font-size: 22px; letter-spacing: 4px; }
  #veilWorld .hexIcon { width: 36px; height: 36px; }
  #veilWorld .headerContent { flex-direction: column; align-items: flex-start; gap: 12px; }
  #veilWorld .headerDesc { font-size: 11px; }
  #veilWorld .headerActions { width: 100%; }
  #veilWorld .headerActions .cyberBtn { width: 100%; justify-content: center; }
  #veilWorld .interfacePanel { padding: 16px; }
  #veilWorld .questionHeader { flex-direction: column; align-items: flex-start; gap: 6px; }
  #veilWorld .qPrompt { font-size: 15px; }
  #veilWorld .choiceGrid { grid-template-columns: 1fr; gap: 10px; }
  #veilWorld .choiceBtn { padding: 14px; }
  #veilWorld .choiceMain { font-size: 12px; padding-right: 24px; }
  #veilWorld .choiceArrow { font-size: 16px; right: 12px; bottom: 14px; }
  #veilWorld .sliderLabels { font-size: 11px; }
  #veilWorld .inputGroup { flex-direction: column; }
  #veilWorld .instabilityMask { width: 110px; height: 110px; margin: 20px auto; }
  #veilWorld .verdictPanel { padding: 16px; }
  #veilWorld .verdictVisual { gap: 20px; margin-bottom: 20px; }
  #veilWorld .maskDisplay { width: 120px; height: 120px; }
  #veilWorld .verdictRow { font-size: 10px; flex-direction: column; gap: 2px; }
  #veilWorld .verdictActions { flex-direction: column; gap: 10px; }
  #veilWorld .verdictActions .cyberBtn { width: 100%; justify-content: center; }
  #veilWorld .cyberBtn { font-size: 11px; padding: 10px 16px; }
  #veilWorld .stateIcon { font-size: 36px; }
  #veilWorld .stateTitle { font-size: 16px; letter-spacing: 3px; }
  #veilWorld .stateDesc { font-size: 12px; }
  #veilWorld .systemSub { font-size: 8px; }
}
@media (max-width: 400px) {
  #veilWorld .veil-systemName { font-size: 18px; letter-spacing: 3px; }
  #veilWorld .qPrompt { font-size: 13px; }
  #veilWorld .balanceValue { font-size: 18px; }
}

/* ===================== UNIFIED VISUAL SYSTEM ===================== */
/* Override block: brings Forge + City into VEIL aesthetic alignment */

/* --- FORGE: Clinical Protocol Interface --- */
#screenForge { padding: 40px 24px 60px; }
.forge-container { max-width: 900px; }

.header { margin-bottom: 50px; }
.header-subtitle { font-size: 8px; letter-spacing: 8px; color: rgba(200,184,154,0.4); }
.header-rule { background: linear-gradient(90deg, transparent, rgba(200,184,154,0.15), transparent); }
.header-title {
  font-size: clamp(32px, 6vw, 68px); letter-spacing: 16px;
  background: linear-gradient(135deg, rgba(240,237,230,0.9) 30%, rgba(240,237,230,0.4) 100%);
  -webkit-background-clip: text; background-clip: text;
}
.header-tagline { color: rgba(200,184,154,0.3); letter-spacing: 6px; }

.forge-panel {
  background: rgba(10,10,10,0.6); backdrop-filter: blur(4px);
  border: 1px solid rgba(200,184,154,0.06); padding: 40px 36px;
  box-shadow: none; margin-bottom: 40px;
}
.forge-panel::before { color: rgba(200,184,154,0.3); letter-spacing: 6px; background: var(--black); }

.gender-row { margin-bottom: 32px; gap: 12px; }
.gender-label { color: rgba(200,184,154,0.3); }
.gender-btn {
  border: 1px solid rgba(200,184,154,0.08); padding: 10px 28px;
  font-size: 10px; letter-spacing: 5px;
}
.gender-btn.active { border-color: rgba(200,184,154,0.2); box-shadow: none; }

.sliders-row { gap: 48px; margin-bottom: 32px; }
.slider-name { font-size: 16px; letter-spacing: 6px; }
.slider-name.lux { text-shadow: 0 0 12px rgba(240,237,230,0.15); }
.slider-value { font-size: 22px; opacity: 0.8; }

input[type=range] { height: 1px; }
input[type=range]::-webkit-slider-thumb {
  width: 12px; height: 12px; border: 1px solid rgba(200,184,154,0.4);
  box-shadow: 0 0 8px rgba(200,184,154,0.2); background: var(--white);
}
input[type=range]::-webkit-slider-thumb:hover {
  box-shadow: 0 0 12px rgba(200,184,154,0.4);
  transform: rotate(45deg) scale(1.15);
}

.balance-bar { height: 3px; border: 1px solid rgba(200,184,154,0.04); }
.balance-bar-label { font-size: 8px; letter-spacing: 4px; color: rgba(200,184,154,0.3); }
.balance-fill-lux { box-shadow: 1px 0 6px rgba(240,237,230,0.1); }

.forge-btn {
  border: 1px solid rgba(200,184,154,0.15); letter-spacing: 12px;
  font-size: 12px; padding: 18px; color: rgba(200,184,154,0.6);
}
.forge-btn:hover { color: var(--black); }

.sync-note { color: rgba(200,184,154,0.15); }
.error-msg { color: rgba(170,50,50,0.6); }

/* --- Character Panel: Minimal Manifest --- */
.output-grid { gap: 20px; }
.character-panel {
  background: rgba(8,8,8,0.8); border: 1px solid rgba(200,184,154,0.06);
  box-shadow: none; padding: 30px 24px;
}
.character-panel::before { color: rgba(200,184,154,0.25); background: rgba(8,8,8,0.95); }
.corner-deco.tl, .corner-deco.tr, .corner-deco.bl, .corner-deco.br { border-color: rgba(200,184,154,0.08); }

.character-name { font-size: 16px; letter-spacing: 6px; }
.name-arrow { border-color: rgba(200,184,154,0.08); width: 24px; height: 24px; font-size: 11px; }
.reroll-btn { border-color: rgba(200,184,154,0.06); font-size: 7px; letter-spacing: 3px; }
.character-code { color: rgba(200,184,154,0.3); }

.enter-btn {
  border: 1px solid rgba(240,237,230,0.15); font-size: 11px; letter-spacing: 10px; padding: 16px;
}
.enter-btn.show { animation: pulseGlow 3s ease-in-out infinite; }
@keyframes pulseGlow {
  0%, 100% { box-shadow: none; } 50% { box-shadow: 0 0 15px rgba(240,237,230,0.08); }
}

/* --- Dossier: Thinner, Clinical --- */
.dossier-block {
  background: rgba(8,8,8,0.5); border: 1px solid rgba(200,184,154,0.04);
  padding: 16px 20px;
}
.dossier-block-title { color: rgba(200,184,154,0.35); border-bottom-color: rgba(200,184,154,0.04); letter-spacing: 6px; }
.dossier-row { font-size: 9px; margin-bottom: 5px; }
.dossier-key { color: rgba(200,184,154,0.3); }
.dossier-val { font-weight: 400; color: rgba(240,237,230,0.7); }
.stat-bar { height: 1px; }
.stat-fill { background: linear-gradient(90deg, rgba(200,184,154,0.5), rgba(240,237,230,0.3)); }
.trait-pill { border-color: rgba(200,184,154,0.08); color: rgba(200,184,154,0.35); font-size: 8px; }
.alignment-meter { height: 4px; border-color: rgba(200,184,154,0.04); }
.lore-text { color: rgba(136,136,136,0.4); font-size: 11px; }

/* --- Cutscene: Cleaner --- */
.subtitle-text { font-size: 14px; letter-spacing: 3px; color: rgba(200,184,154,0.7); }
.scene-title-main { letter-spacing: 18px; text-shadow: 0 0 30px rgba(240,237,230,0.08); }
.scene-title-sub { letter-spacing: 10px; color: rgba(200,184,154,0.35); }

/* --- Junction: System Protocol HUD --- */
.junction-overlay { background: linear-gradient(180deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.88) 50%, rgba(0,0,0,0.95) 100%); }
.junction-eyeline { color: rgba(200,184,154,0.25); letter-spacing: 10px; }
.junction-title { font-size: clamp(16px, 3vw, 28px); letter-spacing: 12px; text-shadow: 0 0 20px rgba(240,237,230,0.06); }
.junction-subtitle { color: rgba(200,184,154,0.3); font-size: 12px; margin-bottom: 48px; }
.junction-choices { gap: 16px; flex-wrap: wrap; justify-content: center; }

.junction-card {
  width: 180px; padding: 28px 18px; background: rgba(5,5,5,0.7);
  border: 1px solid rgba(200,184,154,0.06); backdrop-filter: blur(6px);
}
.junction-card:hover { border-color: rgba(200,184,154,0.2); transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
.junction-card-icon { font-size: 28px; margin-bottom: 18px; color: rgba(200,184,154,0.5); }
.junction-card-name { font-size: 12px; letter-spacing: 6px; margin-bottom: 12px; }
.junction-card-desc { font-size: 11px; color: rgba(136,136,136,0.5); line-height: 1.7; margin-bottom: 20px; }
.junction-card-tag { font-size: 7px; letter-spacing: 5px; color: rgba(200,184,154,0.3); border-color: rgba(200,184,154,0.08); padding: 5px 14px; }
.junction-divider-line { height: 30px; background: rgba(200,184,154,0.04); }
.junction-divider { gap: 4px; padding: 0 2px; }
.junction-divider-text { color: rgba(200,184,154,0.15); }
.junction-card.ruinbow-card .junction-card-icon { color: rgba(184,122,58,0.5); }
.junction-card.ruinbow-card:hover { border-color: rgba(184,122,58,0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
.junction-card.ruinbow-card .junction-card-tag { color: rgba(184,122,58,0.3); border-color: rgba(184,122,58,0.08); }

/* --- WONDRIX: Restricted Zone --- */
.junction-card.wondrix-card {
  border-color: rgba(140,30,30,0.08); cursor: default;
  position: relative;
}
.junction-card.wondrix-card::before { background: none; }
.junction-card.wondrix-card::after {
  content: ''; position: absolute; inset: 0;
  background: repeating-linear-gradient(0deg, transparent 0px, transparent 3px, rgba(140,30,30,0.015) 3px, rgba(140,30,30,0.015) 6px);
  pointer-events: none;
}
.junction-card.wondrix-card:hover {
  border-color: rgba(140,30,30,0.15); transform: none;
  box-shadow: 0 0 20px rgba(140,30,30,0.05);
}
.junction-card.wondrix-card .junction-card-icon { color: rgba(140,30,30,0.35); font-size: 24px; }
.junction-card.wondrix-card .junction-card-name { color: rgba(200,60,60,0.4); font-size: 11px; letter-spacing: 7px; }
.junction-card.wondrix-card .junction-card-desc { color: rgba(140,60,60,0.3); font-size: 10px; }
.junction-card.wondrix-card .junction-card-tag {
  color: rgba(140,30,30,0.5); border-color: rgba(140,30,30,0.15);
  animation: wondrixPulse 4s ease-in-out infinite;
}
@keyframes wondrixPulse { 0%,100% { opacity: 0.5; } 50% { opacity: 1; } }
@keyframes screenShake {
  0% { transform: translate(0,0); }
  20% { transform: translate(-3px, 2px); }
  40% { transform: translate(2px, -1px); }
  60% { transform: translate(-1px, 3px); }
  80% { transform: translate(3px, -2px); }
  100% { transform: translate(0,0); }
}
.wondrix-warning {
  font-size: 7px; letter-spacing: 4px; color: rgba(140,30,30,0.25);
  text-transform: uppercase; margin-top: 8px; line-height: 1.6;
}

/* --- Marketplace: Unified System UI --- */
.market-inner { padding: 44px 32px 80px; }
.market-header { border-bottom-color: rgba(200,184,154,0.06); padding-bottom: 24px; margin-bottom: 36px; }
.market-logo { font-size: 9px; letter-spacing: 8px; color: rgba(200,184,154,0.25); }
.market-title-main { letter-spacing: 8px; }
.market-title-sub { color: rgba(200,184,154,0.25); letter-spacing: 5px; }
.null-symbol { font-size: 26px; animation: nullPulse 4s ease-in-out infinite; }
.null-amount { font-size: 24px; }
.null-label { color: rgba(200,184,154,0.25); }
.null-tag { color: rgba(200,184,154,0.15); }
.null-btn-add { border-color: rgba(200,184,154,0.1); font-size: 8px; }

.bracelet-bar {
  background: rgba(8,8,8,0.6); border: 1px solid rgba(200,184,154,0.06);
  padding: 18px 24px; margin-bottom: 36px;
}
.bracelet-bar::before { color: rgba(200,184,154,0.2); background: var(--black); letter-spacing: 5px; }
.bracelet-ring { border: 1px solid rgba(200,184,154,0.3); }
.bracelet-ring::before { width: 5px; height: 5px; top: -3px; box-shadow: 0 0 5px rgba(200,184,154,0.5); }
.bracelet-inner { border-color: rgba(200,184,154,0.15); }
.bracelet-current-emotion { font-size: 18px; letter-spacing: 5px; }
.intensity-pct { font-size: 28px; }

.market-section-title { color: rgba(200,184,154,0.25); border-bottom-color: rgba(200,184,154,0.04); letter-spacing: 7px; }
.market-section-title::after { background: rgba(200,184,154,0.03); }

.emotion-card {
  background: rgba(8,8,8,0.5); border: 1px solid rgba(200,184,154,0.04);
  padding: 22px;
}
.emotion-card:hover { border-color: rgba(200,184,154,0.15); transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
.emotion-card.purchased { border-color: rgba(200,184,154,0.15); }
.emotion-card.active-injection { border-color: rgba(200,184,154,0.3); }
.emotion-name { font-size: 16px; letter-spacing: 4px; }
.emotion-latin { color: rgba(200,184,154,0.3); }
.emotion-desc { color: rgba(136,136,136,0.4); font-size: 12px; }
.emotion-stat-bar { height: 1px; }
.buy-btn { border-color: rgba(200,184,154,0.15); font-size: 9px; }
.contraband-strip { border-color: rgba(170,50,50,0.1); color: rgba(170,80,80,0.4); padding: 8px 14px; font-size: 8px; }

/* --- Ruinbow: Unified Dark Factory --- */
#screenRuinbow { background: var(--black); }
.ruinbow-inner { padding: 44px 32px 80px; }
.ruinbow-header { border-bottom-color: rgba(184,122,58,0.08); padding-bottom: 20px; }
.ruinbow-logo { color: rgba(184,122,58,0.25); letter-spacing: 7px; }
.ruinbow-subtitle { color: rgba(184,122,58,0.2); }
.ruinbow-null-label { color: rgba(184,122,58,0.25); }
.ruinbow-null-sym { font-size: 24px; }
.ruinbow-null-val { font-size: 22px; }

.distill-engine {
  background: rgba(8,8,8,0.5); border-color: rgba(184,122,58,0.08);
  padding: 28px;
}
.distill-engine::before { color: rgba(184,122,58,0.2); background: var(--black); }
.distill-engine:hover { border-color: rgba(184,122,58,0.2); }
.ore-type-label { color: rgba(184,122,58,0.25); }
.ore-type-desc { color: rgba(136,136,136,0.35); }
.distill-progress-bar { height: 3px; background: rgba(184,122,58,0.06); }
.distill-cta { font-size: 11px; letter-spacing: 8px; }

.ore-panel { background: rgba(8,8,8,0.4); border-color: rgba(184,122,58,0.06); }
.ore-panel::before { color: rgba(184,122,58,0.2); background: var(--black); }
.ore-item { background: rgba(184,122,58,0.02); border-color: rgba(184,122,58,0.04); }
.ore-item:hover { border-color: rgba(184,122,58,0.12); background: rgba(184,122,58,0.04); }
.output-panel { background: rgba(8,8,8,0.4); border-color: rgba(184,122,58,0.06); }
.output-panel::before { color: rgba(184,122,58,0.2); background: var(--black); }
.log-entry { color: rgba(136,136,136,0.3); }
.transfer-btn { border-color: rgba(184,122,58,0.15); color: rgba(184,122,58,0.5); font-size: 11px; letter-spacing: 10px; }

/* --- Nav Hub: Thinner --- */
.nav-hub {
  background: rgba(5,5,5,0.85); backdrop-filter: blur(10px);
  border-color: rgba(200,184,154,0.06); box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.nav-btn { font-size: 8px; letter-spacing: 4px; padding: 10px 20px; color: rgba(200,184,154,0.4); border-right-color: rgba(200,184,154,0.06); }
.nav-btn:hover { color: rgba(200,184,154,0.8); }
.nav-btn.active { color: rgba(200,184,154,0.8); }

/* --- Toast: Minimal --- */
.toast { background: rgba(5,5,5,0.9); backdrop-filter: blur(10px); border-color: rgba(200,184,154,0.1); }
.toast-title { font-size: 12px; }

/* --- Grain/Vignette: Subtler --- */
.grain { opacity: 0.3; }
.vignette { background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.85) 100%); }


/* ===================== SCREEN: CITY MAP ===================== */
#screenMap { background: var(--black); overflow: hidden; }
.map-container { width: 100%; height: 100%; position: relative; overflow: hidden; }
.map-viewport { position: absolute; inset: 0; overflow: hidden; touch-action: none; }
.map-canvas {
  width: 1600px; height: 1000px; position: absolute;
  top: 50%; left: 50%; transform-origin: center center;
  background: radial-gradient(ellipse at 50% 40%, rgba(18,18,20,1) 0%, rgba(6,6,8,1) 70%);
  transition: transform 0.3s ease;
}
.map-grid {
  position: absolute; inset: 0; pointer-events: none;
  background-image: 
    linear-gradient(rgba(200,184,154,0.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(200,184,154,0.04) 1px, transparent 1px);
  background-size: 80px 80px;
}
.map-roads {
  position: absolute; inset: 0; pointer-events: none;
}
.map-road { position: absolute; background: rgba(200,184,154,0.06); }
.map-road-h { height: 2px; }
.map-road-v { width: 2px; }

.map-location {
  position: absolute; display: flex; flex-direction: column;
  align-items: center; cursor: pointer; z-index: 10;
  transition: all 0.35s ease; padding: 12px;
}
.map-location:hover { transform: translateY(-3px); }
.map-loc-icon {
  width: 48px; height: 48px; border: 1px solid rgba(200,184,154,0.3);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Cinzel', serif; font-size: 20px; font-weight: 900;
  color: rgba(200,184,154,0.7); background: rgba(8,8,8,0.85);
  backdrop-filter: blur(4px); margin-bottom: 8px;
  transition: all 0.35s ease;
}
.map-location:hover .map-loc-icon { border-color: rgba(200,184,154,0.5); box-shadow: 0 0 20px rgba(200,184,154,0.15); }
.map-loc-name { font-family: 'Cinzel', serif; font-size: 10px; font-weight: 700; letter-spacing: 4px; color: rgba(240,237,230,0.8); text-transform: uppercase; white-space: nowrap; }
.map-loc-sub { font-size: 7px; letter-spacing: 3px; color: rgba(200,184,154,0.4); margin-top: 2px; text-transform: uppercase; }

.map-loc-icon.ruinbow-icon { color: rgba(184,122,58,0.7); border-color: rgba(184,122,58,0.25); }
.map-location.ruinbow-loc:hover .map-loc-icon { border-color: rgba(184,122,58,0.5); box-shadow: 0 0 20px rgba(184,122,58,0.15); }
.map-loc-icon.delirium-icon { color: rgba(140,100,200,0.7); border-color: rgba(120,80,180,0.25); }
.map-location.delirium-loc:hover .map-loc-icon { border-color: rgba(120,80,180,0.5); box-shadow: 0 0 20px rgba(120,80,180,0.15); }
.map-loc-icon.wondrix-icon { color: rgba(180,50,50,0.5); border-color: rgba(180,50,50,0.15); }
.map-location.wondrix-loc { cursor: default; }
.map-location.wondrix-loc.unlocked { cursor: pointer; }
.map-location.wondrix-loc:not(.unlocked):hover { transform: none; }
.map-location.wondrix-loc .map-loc-name { color: rgba(200,60,60,0.5); }
.map-location.wondrix-loc .map-loc-sub { color: rgba(180,50,50,0.4); }
.map-location.wondrix-loc.unlocked .map-loc-icon { color: rgba(200,60,60,0.7); border-color: rgba(200,60,60,0.3); }
.map-location.wondrix-loc.unlocked .map-loc-name { color: rgba(200,60,60,0.75); }

.map-location.foggy { pointer-events: none; opacity: 0.2; filter: blur(1px); }
.map-loc-icon.foggy-icon { border-style: dashed; }

.map-hud { position: absolute; top: 16px; left: 50%; transform: translateX(-50%); z-index: 50; text-align: center; }
.map-hud-title { font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 8px; color: rgba(200,184,154,0.5); text-transform: uppercase; }
.map-hud-sub { font-size: 7px; letter-spacing: 4px; color: rgba(200,184,154,0.25); margin-top: 4px; }

.map-zoom-ctrl { position: absolute; bottom: 20px; right: 20px; z-index: 50; display: flex; flex-direction: column; gap: 2px; }
.map-zoom-btn { width: 36px; height: 36px; background: rgba(5,5,5,0.85); border: 1px solid rgba(200,184,154,0.15); color: rgba(200,184,154,0.6); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-family: 'Share Tech Mono', monospace; }
.map-zoom-btn:hover { border-color: rgba(200,184,154,0.35); color: rgba(200,184,154,0.9); }
.map-zoom-btn:active { background: rgba(200,184,154,0.1); }

.map-back-btn { position: absolute; bottom: 20px; left: 20px; z-index: 50; background: rgba(5,5,5,0.85); border: 1px solid rgba(200,184,154,0.15); color: rgba(200,184,154,0.5); font-family: 'Share Tech Mono', monospace; font-size: 9px; letter-spacing: 3px; padding: 10px 18px; cursor: pointer; text-transform: uppercase; transition: all 0.25s; }
.map-back-btn:hover { border-color: rgba(200,184,154,0.35); color: rgba(200,184,154,0.8); }

.map-nulls { position: absolute; top: 16px; right: 20px; z-index: 50; font-size: 14px; color: rgba(200,184,154,0.6); font-family: 'Share Tech Mono', monospace; }
.map-nulls span { font-family: 'Cinzel', serif; margin-right: 6px; }

/* ===== MAP + FORGE MOBILE ===== */
@media (max-width: 768px) {
  .map-loc-icon { width: 54px; height: 54px; font-size: 22px; border-width: 1.5px; }
  .map-loc-name { font-size: 10px; letter-spacing: 3px; }
  .map-loc-sub { font-size: 7px; }
  .map-zoom-btn { width: 44px; height: 44px; font-size: 22px; }
  .map-zoom-ctrl { bottom: 24px; right: 16px; gap: 4px; }
  .map-back-btn { bottom: 24px; left: 16px; font-size: 10px; padding: 12px 20px; }
  .map-hud-title { font-size: 9px; letter-spacing: 5px; }
  .map-nulls { font-size: 13px; }
  .map-location { padding: 8px; }

  #screenForge { padding: 20px 14px 40px; }
  .forge-container { max-width: 100%; }
  .header { margin-bottom: 30px; }
  .header-title { letter-spacing: 8px; }
  .header-subtitle { font-size: 7px; letter-spacing: 5px; }
  .header-tagline { font-size: 7px; letter-spacing: 4px; }
  .forge-panel { padding: 20px 16px; margin-bottom: 24px; }
  .sliders-row { grid-template-columns: 1fr; gap: 24px; margin-bottom: 20px; }
  .slider-name { font-size: 14px; letter-spacing: 4px; }
  .slider-value { font-size: 18px; }
  input[type=range]::-webkit-slider-thumb { width: 22px; height: 22px; }
  input[type=range]::-moz-range-thumb { width: 22px; height: 22px; }
  .gender-row { margin-bottom: 20px; flex-wrap: wrap; }
  .gender-btn { padding: 10px 20px; font-size: 9px; }
  .forge-btn { padding: 16px; font-size: 11px; letter-spacing: 8px; }
  .output-grid { grid-template-columns: 1fr; gap: 16px; }
  .character-panel { padding: 20px 16px; }
  .character-name { font-size: 14px; letter-spacing: 4px; }
  .dossier-block { padding: 14px 16px; }
  .enter-btn { padding: 14px; font-size: 10px; letter-spacing: 6px; }
  .reroll-btn { padding: 3px 8px; font-size: 7px; }
  .name-arrow { width: 28px; height: 28px; font-size: 13px; }

  .delirium-grid { grid-template-columns: 1fr; }
  .inv-char-card { flex-direction: column; align-items: center; text-align: center; }
  .inv-char-svg { width: 100px; height: 140px; }
  .inv-align-bar { height: 5px; }

  .walk-inner { padding: 24px 16px 60px; }
  .walk-narrative { font-size: 13px; }
  .walk-choice { padding: 14px 16px; font-size: 10px; }
  .walk-scene-art { height: 110px; }

  .nav-hub { bottom: 16px; width: auto; max-width: 95%; }
  .nav-btn { padding: 10px 12px; font-size: 7px; letter-spacing: 2px; }
}

/* ===================== SCREEN: DELIRIUM ===================== */
#screenDelirium { background: var(--black); overflow: hidden; }
.delirium-inner { width: 100%; height: 100%; overflow-y: auto; padding: 44px 32px 80px; scrollbar-width: thin; scrollbar-color: rgba(120,80,180,0.3) transparent; }
.delirium-inner::-webkit-scrollbar { width: 2px; }
.delirium-inner::-webkit-scrollbar-thumb { background: rgba(120,80,180,0.3); }
.delirium-header { margin-bottom: 36px; border-bottom: 1px solid rgba(120,80,180,0.08); padding-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-start; }
.delirium-logo { font-size: 9px; letter-spacing: 7px; color: rgba(120,80,180,0.25); text-transform: uppercase; margin-bottom: 6px; }
.delirium-title { font-family: 'Cinzel', serif; font-size: clamp(26px, 4vw, 44px); font-weight: 900; letter-spacing: 6px; background: linear-gradient(135deg, rgba(160,120,220,0.8), rgba(80,50,140,0.6)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.delirium-subtitle { font-size: 9px; letter-spacing: 4px; color: rgba(120,80,180,0.2); margin-top: 4px; text-transform: uppercase; }
.delirium-null-display { text-align: right; }
.delirium-null-label { font-size: 9px; letter-spacing: 3px; color: rgba(120,80,180,0.25); text-transform: uppercase; margin-bottom: 4px; }
.delirium-null-val { font-size: 22px; font-family: 'Share Tech Mono'; color: var(--white); }
.delirium-null-sym { font-family: 'Cinzel', serif; font-size: 24px; color: rgba(120,80,180,0.6); margin-right: 8px; }

.delirium-section-title { font-size: 8px; letter-spacing: 6px; color: rgba(120,80,180,0.25); text-transform: uppercase; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid rgba(120,80,180,0.04); }
.delirium-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 14px; margin-bottom: 36px; }
.delirium-item {
  background: rgba(8,8,8,0.5); border: 1px solid rgba(120,80,180,0.06);
  padding: 20px; cursor: pointer; transition: all 0.3s; position: relative;
}
.delirium-item:hover { border-color: rgba(120,80,180,0.2); transform: translateY(-1px); }
.delirium-item.owned { border-color: rgba(120,80,180,0.15); cursor: default; }
.delirium-item.owned::after { content: 'OWNED'; position: absolute; top: 8px; right: 8px; font-size: 7px; letter-spacing: 3px; color: rgba(120,80,180,0.4); }
.delirium-item-icon { font-size: 24px; margin-bottom: 10px; opacity: 0.6; }
.delirium-item-name { font-family: 'Cinzel', serif; font-size: 13px; letter-spacing: 3px; color: rgba(240,237,230,0.7); margin-bottom: 4px; }
.delirium-item-desc { font-family: 'Crimson Text', serif; font-style: italic; font-size: 11px; color: rgba(136,136,136,0.35); line-height: 1.6; margin-bottom: 12px; }
.delirium-item-price { font-size: 14px; font-family: 'Share Tech Mono'; color: rgba(120,80,180,0.6); }
.delirium-item-price span { font-family: 'Cinzel', serif; margin-right: 4px; }
.delirium-item.highlight-item { border-color: rgba(120,80,180,0.12); }
.delirium-item.highlight-item .delirium-item-name { color: rgba(160,120,220,0.8); }

/* ===================== SCREEN: INVENTORY ===================== */
#screenInventory { background: var(--black); overflow: hidden; }
.inv-inner { width: 100%; height: 100%; overflow-y: auto; padding: 44px 32px 80px; max-width: 800px; margin: 0 auto; }
.inv-header { text-align: center; margin-bottom: 36px; padding-bottom: 20px; border-bottom: 1px solid rgba(200,184,154,0.04); }
.inv-title { font-family: 'Cinzel', serif; font-size: 14px; letter-spacing: 10px; color: rgba(200,184,154,0.4); text-transform: uppercase; }
.inv-char-card { display: flex; align-items: flex-start; gap: 24px; margin-bottom: 32px; padding: 24px; background: rgba(8,8,8,0.5); border: 1px solid rgba(200,184,154,0.04); }
.inv-char-svg { width: 120px; height: 170px; flex-shrink: 0; }
.inv-char-info { flex: 1; }
.inv-char-name { font-family: 'Cinzel', serif; font-size: 16px; letter-spacing: 5px; color: var(--white); margin-bottom: 4px; }
.inv-char-code { font-size: 9px; letter-spacing: 3px; color: rgba(200,184,154,0.3); margin-bottom: 8px; }
.inv-char-arch { font-size: 9px; letter-spacing: 3px; color: rgba(200,184,154,0.35); text-transform: uppercase; margin-bottom: 16px; }
.inv-nulls { font-size: 20px; font-family: 'Share Tech Mono'; color: var(--white); margin-bottom: 4px; }
.inv-nulls span { font-family: 'Cinzel', serif; color: var(--accent); margin-right: 6px; }
.inv-null-label { font-size: 8px; letter-spacing: 3px; color: rgba(200,184,154,0.2); text-transform: uppercase; }
.inv-alignment { margin-bottom: 14px; }
.inv-align-labels { display: flex; justify-content: space-between; margin-bottom: 4px; }
.inv-lux-label { font-size: 8px; letter-spacing: 3px; color: rgba(100,160,255,0.5); }
.inv-nox-label { font-size: 8px; letter-spacing: 3px; color: rgba(220,80,80,0.5); }
.inv-align-bar { height: 4px; display: flex; overflow: hidden; background: rgba(200,184,154,0.03); }
.inv-align-lux { height: 100%; background: linear-gradient(90deg, rgba(60,120,220,0.5), rgba(100,160,255,0.7)); transition: width 0.5s ease; }
.inv-align-nox { height: 100%; background: linear-gradient(90deg, rgba(180,40,40,0.5), rgba(220,60,60,0.7)); transition: width 0.5s ease; }

.inv-section { margin-bottom: 28px; }
.inv-section-title { font-size: 8px; letter-spacing: 6px; color: rgba(200,184,154,0.25); text-transform: uppercase; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid rgba(200,184,154,0.04); }
.inv-items-grid { display: flex; flex-wrap: wrap; gap: 8px; }
.inv-item-chip { padding: 6px 14px; background: rgba(8,8,8,0.5); border: 1px solid rgba(200,184,154,0.06); font-size: 9px; letter-spacing: 2px; color: rgba(240,237,230,0.5); text-transform: uppercase; }
.inv-item-chip.delirium-chip { border-color: rgba(120,80,180,0.1); color: rgba(160,120,220,0.5); }
.inv-item-chip.emotion-chip { border-color: rgba(200,184,154,0.08); }
.inv-code-display { margin-top: 8px; padding: 12px 18px; background: rgba(120,80,180,0.04); border: 1px solid rgba(120,80,180,0.1); font-family: 'Share Tech Mono', monospace; font-size: 14px; letter-spacing: 4px; color: rgba(160,120,220,0.7); text-align: center; }
.inv-empty { font-size: 9px; letter-spacing: 3px; color: rgba(200,184,154,0.15); font-style: italic; }


/* ===================== WALK THE CITY ===================== */
#screenWalk { background: var(--black); overflow: hidden; }
.walk-inner { width: 100%; height: 100%; overflow-y: auto; padding: 44px 32px 80px; max-width: 700px; margin: 0 auto; }
.walk-header { text-align: center; margin-bottom: 36px; padding-bottom: 20px; border-bottom: 1px solid rgba(200,184,154,0.04); }
.walk-title { font-family: 'Cinzel', serif; font-size: 14px; letter-spacing: 10px; color: rgba(200,184,154,0.4); text-transform: uppercase; margin-bottom: 6px; }
.walk-alignment { font-size: 9px; letter-spacing: 4px; color: rgba(200,184,154,0.2); text-transform: uppercase; }
.walk-scene { margin-bottom: 32px; }
.walk-narrative { font-family: 'Crimson Text', serif; font-style: italic; font-size: 14px; color: rgba(200,184,154,0.45); line-height: 1.9; margin-bottom: 28px; }
.walk-prompt { font-size: 10px; letter-spacing: 5px; color: rgba(200,184,154,0.25); text-transform: uppercase; margin-bottom: 16px; }
.walk-choices { display: flex; flex-direction: column; gap: 10px; }
.walk-choice {
  padding: 16px 20px; background: rgba(8,8,8,0.5); border: 1px solid rgba(200,184,154,0.06);
  cursor: pointer; transition: all 0.3s; text-align: left; color: rgba(240,237,230,0.5);
  font-family: 'Share Tech Mono', monospace; font-size: 11px; letter-spacing: 2px;
}
.walk-choice:hover { border-color: rgba(200,184,154,0.2); color: rgba(240,237,230,0.8); transform: translateX(4px); }
.walk-choice .choice-tag { font-size: 7px; letter-spacing: 3px; color: rgba(200,184,154,0.2); margin-top: 4px; display: block; text-transform: uppercase; }
.walk-result { text-align: center; padding: 28px; background: rgba(8,8,8,0.4); border: 1px solid rgba(200,184,154,0.06); }
.walk-result-title { font-family: 'Cinzel', serif; font-size: 14px; letter-spacing: 6px; color: rgba(200,184,154,0.5); margin-bottom: 12px; }
.walk-result-desc { font-family: 'Crimson Text', serif; font-style: italic; font-size: 13px; color: rgba(200,184,154,0.35); line-height: 1.7; margin-bottom: 16px; }
.walk-item-reveal { padding: 14px 20px; background: rgba(120,80,180,0.05); border: 1px solid rgba(120,80,180,0.15); font-family: 'Share Tech Mono', monospace; font-size: 13px; letter-spacing: 4px; color: rgba(160,120,220,0.7); text-align: center; margin-top: 12px; }
.walk-again-btn { margin-top: 20px; padding: 12px 24px; background: none; border: 1px solid rgba(200,184,154,0.1); color: rgba(200,184,154,0.4); font-family: 'Share Tech Mono', monospace; font-size: 9px; letter-spacing: 4px; cursor: pointer; text-transform: uppercase; transition: all 0.25s; }
.walk-again-btn:hover { border-color: rgba(200,184,154,0.3); color: rgba(200,184,154,0.7); }
.walk-scene-art { width: 100%; height: 140px; margin-bottom: 20px; border: 1px solid rgba(200,184,154,0.04); background: rgba(4,4,6,0.6); overflow: hidden; position: relative; }
.walk-scene-art svg { width: 100%; height: 100%; }
.walk-alignment .lux-val { color: rgba(100,160,255,0.7); }
.walk-alignment .nox-val { color: rgba(220,80,80,0.7); }

.walk-meter { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.walk-meter-label { font-size: 8px; letter-spacing: 3px; color: rgba(200,184,154,0.2); text-transform: uppercase; width: 30px; }
.walk-meter-bar { flex: 1; height: 3px; background: rgba(200,184,154,0.04); position: relative; overflow: hidden; }
.walk-meter-fill { height: 100%; transition: width 0.5s ease; }
.walk-meter-fill.lux-fill { background: linear-gradient(90deg, rgba(60,120,220,0.6), rgba(100,160,255,0.8)); }
.walk-meter-fill.nox-fill { background: linear-gradient(90deg, rgba(180,40,40,0.6), rgba(220,60,60,0.8)); }

/* ===================== WONDRIX GAME ===================== */
#screenWondrix { background: #020204; overflow: hidden; }
.wondrix-game-wrap { width: 100%; height: 100%; position: relative; }
#wondrixCanvas { width: 100%; height: 100%; display: block; }
.wondrix-hud { position: absolute; top: 16px; left: 50%; transform: translateX(-50%); z-index: 10; text-align: center; }
.wondrix-hud-title { font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 8px; color: rgba(200,60,60,0.4); text-transform: uppercase; }
.wondrix-hud-timer { font-family: 'Share Tech Mono', monospace; font-size: 24px; color: rgba(200,60,60,0.6); margin-top: 4px; }
.wondrix-hud-status { font-size: 8px; letter-spacing: 4px; color: rgba(140,30,30,0.3); margin-top: 4px; text-transform: uppercase; }
.wondrix-end-overlay { position: absolute; inset: 0; z-index: 20; background: rgba(2,2,4,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; }
.wondrix-end-overlay.show { display: flex; }
.wondrix-end-title { font-family: 'Cinzel', serif; font-size: 18px; letter-spacing: 8px; color: rgba(200,60,60,0.6); margin-bottom: 12px; }
.wondrix-end-desc { font-size: 10px; letter-spacing: 3px; color: rgba(140,60,60,0.4); margin-bottom: 24px; text-align: center; line-height: 1.8; }
.wondrix-end-btn { padding: 12px 28px; border: 1px solid rgba(200,60,60,0.2); background: none; color: rgba(200,60,60,0.5); font-family: 'Share Tech Mono', monospace; font-size: 9px; letter-spacing: 4px; cursor: pointer; text-transform: uppercase; transition: all 0.25s; }
.wondrix-end-btn:hover { border-color: rgba(200,60,60,0.4); color: rgba(200,60,60,0.8); }

</style>
</head>
<body>

<!-- ============ CINEMATIC NAV HUD ============ -->
<nav class="world-nav">
  <button class="nav-hud-toggle" id="navToggle" onclick="toggleNavPanel()">
    <span class="toggle-icon">⬡</span>
  </button>
</nav>

<div class="nav-hud-backdrop" id="navBackdrop" onclick="toggleNavPanel()"></div>
<div class="nav-hud-panel" id="navPanel">
  <button class="nav-hud-close" onclick="toggleNavPanel()">✕</button>
  <div class="nav-hud-brand">
    <div class="nav-hud-brand-title">LUX / NOX</div>
    <div class="nav-hud-brand-sub">Duality Manifestation Protocol</div>
  </div>
  <button class="nav-hud-item" id="navMap" onclick="navGoToMap()" style="display:none;">
    <span class="item-dot" style="background:#c8b89a;"></span>MAP
  </button>
  <button class="nav-hud-item" id="navWalk" onclick="navGoToWalk()" style="display:none;">
    <span class="item-dot" style="background:#9a9ac8;"></span>WALK THE CITY
  </button>
  <button class="nav-hud-item" id="navInv" onclick="navGoToInventory()" style="display:none;">
    <span class="item-dot" style="background:#c8b89a;"></span>INVENTORY
  </button>
  <div class="nav-offline-section">
    <div class="nav-offline-label">⊘ offline</div>
    <button class="nav-hud-item offline-item veil-item" id="navVeil" onclick="navGoToVeil()">
      <span class="item-dot"></span>EVALUATION
    </button>
    <button class="nav-hud-item offline-item forge-item locked" id="navForge" onclick="navGoToForge()">
      <span class="item-dot"></span>CHARACTER FORGE
      <span class="item-lock">🔒</span>
    </button>
  </div>
  <div class="nav-hud-exit">
    <a href="https://iamkroma.com">← EXIT VEIL</a>
  </div>
</div>


<!-- ============ VEIL WORLD ============ -->
<div id="veilWorld" class="world-container active">
  <div class="cyberBg">
    <div class="gridOverlay"></div>
    <div class="scanlineEffect"></div>
    <div class="noiseEffect"></div>
    <div class="radialGlow"></div>
  </div>

  <div class="wrap fadeIn">
    <header class="mainHeader">
      <div class="headerContent">
        <div class="logoArea">
          <svg class="hexIcon" viewBox="0 0 100 100" fill="none" stroke="currentColor">
            <path d="M 30 85 L 35 90 L 65 90 L 70 85 Z" fill="currentColor" opacity="0.3"/>
            <rect x="35" y="90" width="30" height="3" fill="currentColor" opacity="0.5"/>
            <line x1="50" y1="20" x2="50" y2="85" stroke-width="4" opacity="0.8"/>
            <line x1="48" y1="30" x2="52" y2="30" stroke-width="1.5"/>
            <line x1="48" y1="45" x2="52" y2="45" stroke-width="1.5"/>
            <line x1="48" y1="60" x2="52" y2="60" stroke-width="1.5"/>
            <line x1="48" y1="75" x2="52" y2="75" stroke-width="1.5"/>
            <circle cx="50" cy="20" r="4" fill="currentColor"/>
            <line x1="46" y1="18" x2="54" y2="22" stroke-width="1"/>
            <line x1="46" y1="22" x2="54" y2="18" stroke-width="1"/>
            <line x1="15" y1="25" x2="85" y2="25" stroke-width="3"/>
            <rect x="48" y="23" width="4" height="4" fill="currentColor"/>
            <line x1="20" y1="25" x2="20" y2="42" stroke-width="1.5" stroke-dasharray="2,2"/>
            <line x1="30" y1="25" x2="30" y2="42" stroke-width="1.5" stroke-dasharray="2,2"/>
            <path d="M 12 42 L 18 47 L 32 47 L 38 42 Z" stroke-width="2"/>
            <line x1="12" y1="42" x2="38" y2="42" stroke-width="2"/>
            <circle cx="15" cy="44" r="1" fill="currentColor"/>
            <circle cx="25" cy="44" r="1" fill="currentColor"/>
            <circle cx="35" cy="44" r="1" fill="currentColor"/>
            <line x1="70" y1="25" x2="70" y2="42" stroke-width="1.5" stroke-dasharray="2,2"/>
            <line x1="80" y1="25" x2="80" y2="42" stroke-width="1.5" stroke-dasharray="2,2"/>
            <path d="M 62 42 L 68 47 L 82 47 L 88 42 Z" stroke-width="2"/>
            <line x1="62" y1="42" x2="88" y2="42" stroke-width="2"/>
            <circle cx="65" cy="44" r="1" fill="currentColor"/>
            <circle cx="75" cy="44" r="1" fill="currentColor"/>
            <circle cx="85" cy="44" r="1" fill="currentColor"/>
            <line x1="10" y1="25" x2="15" y2="25" stroke-width="2" opacity="0.6"/>
            <line x1="85" y1="25" x2="90" y2="25" stroke-width="2" opacity="0.6"/>
          </svg>
          <div>
            <h1 class="veil-systemName glitchText" data-text="VEIL">VEIL</h1>
            <div class="systemSub">VIRTUE EVALUATION, IDENTITY LAYER</div>
          </div>
        </div>
        <div class="statusIndicator">
          <div class="statusDot" id="statusDot" data-status="OFFLINE"></div>
          <div class="statusText" id="statusText">OFFLINE</div>
        </div>
      </div>
      <div class="headerDesc">
        A moral evaluation system designed to classify individuals based on virtuous alignment. 
        The assessment analyzes decision patterns to determine LUX (virtuous) or NOX (corrupted) states.
      </div>
      <div class="headerActions">
        <button class="cyberBtn primary" id="systemBtn"><span>INITIALIZE SYSTEM</span><span class="btnArrow">→</span></button>
      </div>
    </header>

    <div class="interfacePanel">
      <div id="interfaceBody"></div>
      <div id="progressArea" class="progressArea" style="display: none;"></div>
    </div>
  </div>
</div>


<!-- ============ FORGE WORLD ============ -->
<div id="forgeWorld" class="world-container">

<!-- Atmosphere layers -->
<div class="grain"></div>
<div class="vignette"></div>
<div class="scanlines"></div>
<div class="flash-overlay" id="flashOverlay"></div>

<!-- Back button -->
<button class="back-btn" id="backBtn" onclick="goBack()">◁ RETURN</button>

<!-- Ticker -->
<div class="ticker-wrap" id="tickerWrap">
  <div class="ticker" id="tickerInner"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <div class="toast-title" id="toastTitle"></div>
  <div class="toast-body" id="toastBody"></div>
</div>

<!-- SCREEN 1: FORGE -->
<div class="screen active" id="screenForge">
<div class="forge-container">
  <header class="header">
    <div class="header-subtitle">Directive 7 · Identity Synthesis Protocol</div>
    <div class="header-rule"></div>
    <div class="header-title">LUX <span class="header-slash">/</span> NOX</div>
    <div class="header-rule"></div>
    <div class="header-tagline">Alignment Engine · Manifestation Interface</div>
  </header>

  <div class="forge-panel" style="position:relative;">
    <canvas id="hexOverlay"></canvas>

    <!-- Gender selector -->
    <div class="gender-row">
      <span class="gender-label">Phenotype ·</span>
      <button class="gender-btn active" id="genderM" onclick="setGender('male')">MALE</button>
      <button class="gender-btn" id="genderF" onclick="setGender('female')">FEMALE</button>
    </div>

    <div class="sliders-row">
      <div class="slider-group">
        <div class="slider-label">
          <div><div class="slider-name lux">LUX</div><div class="slider-desc lux-desc">● Virtuous</div></div>
          <div class="slider-value lux" id="luxVal">50%</div>
        </div>
        <input type="range" class="lux-slider" id="luxSlider" min="0" max="100" value="50">
      </div>
      <div class="slider-group">
        <div class="slider-label">
          <div><div class="slider-name nox">NOX</div><div class="slider-desc nox-desc">● Corruption</div></div>
          <div class="slider-value nox" id="noxVal">50%</div>
        </div>
        <input type="range" class="nox-slider" id="noxSlider" min="0" max="100" value="50">
      </div>
    </div>
    <div class="balance-bar-wrap">
      <div class="balance-bar-label"><span>◈ PURE LUX</span><span>ALIGNMENT BALANCE</span><span>PURE NOX ◈</span></div>
      <div class="balance-bar">
        <div class="balance-fill-lux" id="balanceLux" style="width:50%"></div>
        <div class="balance-fill-nox" id="balanceNox" style="width:50%"></div>
      </div>
    </div>
    <div id="errorMsg" class="error-msg">⚠ LUX + NOX MUST EQUAL 100%</div>
    <button class="forge-btn" id="forgeBtn">⬡ FORGE CHARACTER</button>
    <div class="sync-note">Sliders auto-balance to 100% · Forge to manifest</div>
  </div>

  <!-- Generation animation -->
  <div class="forge-generating" id="forgeGen">
    <canvas id="genCanvas" width="260" height="260"></canvas>
    <div class="gen-status" id="genStatus">Manifesting subject...</div>
    <div class="gen-substatus" id="genSubstatus">Aligning nanofiber weave</div>
  </div>

  <div class="output-grid" id="outputGrid">
    <div class="character-panel" id="characterPanel">
      <div class="corner-deco tl"></div><div class="corner-deco tr"></div>
      <div class="corner-deco bl"></div><div class="corner-deco br"></div>
      <div class="name-cycler">
        <button class="name-arrow" onclick="cycleName(-1)">◁</button>
        <div class="character-name" id="charName">—</div>
        <button class="name-arrow" onclick="cycleName(1)">▷</button>
      </div>
      <div class="character-code" id="charCode">—</div>
      <svg id="characterCanvas" viewBox="0 0 260 370" xmlns="http://www.w3.org/2000/svg"></svg>
      <div class="reroll-row">
        <button class="reroll-btn" onclick="rerollPart('mask')">⟳ MASK</button>
        <button class="reroll-btn" onclick="rerollPart('shirt')">⟳ SHIRT</button>
        <button class="reroll-btn" onclick="rerollPart('pants')">⟳ PANTS</button>
      </div>
      <button class="enter-btn" id="enterCityBtn" onclick="startCutscene()">
        ⬡ ENTER THE CITY
      </button>
    </div>
    <div class="dossier-panel" id="dossierPanel"></div>
  </div>
</div>
</div>

<!-- SCREEN 2: CUTSCENE -->
<div class="screen" id="screenCutscene">
  <div class="cutscene-wrap">
    <div class="letterbox-top" id="ltTop"></div>
    <div class="letterbox-bot" id="ltBot"></div>
    <canvas id="cutsceneCanvas"></canvas>
    <canvas id="rainCanvas"></canvas>

    <div class="scene-title-card" id="titleCard">
      <div class="scene-title-main">SMILEMORE</div>
      <div class="scene-title-sub">Population: Compliant · Emotion Status: Regulated</div>
    </div>

    <div class="junction-overlay" id="junctionOverlay" style="display:none;">
      <div class="junction-eyeline">· Navigation Protocol Active ·</div>
      <div class="junction-title">SECTOR SELECTION</div>
      <div class="junction-subtitle">Three zones detected. Authorization varies. Proceed at own discretion.</div>
      <div class="junction-choices">
        <div class="junction-card" onclick="chooseDestination('market')">
          <div class="junction-card-icon">Ø</div>
          <div class="junction-card-name">Null Market</div>
          <div class="junction-card-desc">Licensed emotion exchange. Acquire synthetic affect through authorized channels.</div>
          <div class="junction-card-tag">→ Sector 9 · Authorized</div>
        </div>
        <div class="junction-divider">
          <div class="junction-divider-line"></div>
          <div class="junction-divider-line"></div>
        </div>
        <div class="junction-card ruinbow-card" onclick="chooseDestination('ruinbow')">
          <div class="junction-card-icon">◈</div>
          <div class="junction-card-name">Ruinbow</div>
          <div class="junction-card-desc">Unlicensed distillation facility. Convert raw feeling into Null currency.</div>
          <div class="junction-card-tag">→ Sector Ω · Unregulated</div>
        </div>
        <div class="junction-divider">
          <div class="junction-divider-line"></div>
          <div class="junction-divider-line"></div>
        </div>
        <div class="junction-card wondrix-card" onclick="wondrixAccess()">
          <div class="junction-card-icon">⬡</div>
          <div class="junction-card-name">Wondrix</div>
          <div class="junction-card-desc">Uncharted emotional territory. System records expunged. No return protocol filed.</div>
          <div class="junction-card-tag">⚠ Restricted · Level 9 Clearance</div>
          <div class="wondrix-warning">Unauthorized access will be logged and reported to Central Authority</div>
        </div>
      </div>
    </div>

    <div class="subtitle-bar">
      <div class="subtitle-text" id="subtitleText"></div>
    </div>
  </div>
</div>

<!-- SCREEN 4: RUINBOW -->
<div class="screen" id="screenRuinbow">
  <div class="ruinbow-particles" id="ruinbowParticles"></div>
  <div class="ruinbow-inner">
    <div class="ruinbow-header">
      <div>
        <div class="ruinbow-logo">Underground Sector Ω · Emotional Processing</div>
        <div class="ruinbow-title">RUINBOW</div>
        <div class="ruinbow-subtitle">Distill raw emotion into Null currency · Unlicensed · Unregulated</div>
      </div>
      <div class="ruinbow-null-display">
        <div class="ruinbow-null-label">Factory Earnings</div>
        <div class="ruinbow-null-amount">
          <div class="ruinbow-null-sym">Ø</div>
          <div class="ruinbow-null-val" id="factoryNulls">0</div>
        </div>
        <div style="font-size:8px;letter-spacing:3px;color:#4a3a5a;margin-top:4px;text-transform:uppercase;">Unverified · Transfer to spend</div>
      </div>
    </div>

    <div class="distill-engine" id="distillEngine" onclick="clickDistill()">
      <div class="distill-engine-inner">
        <div class="machine-visual">
          <canvas id="machineCanvas" width="160" height="160"></canvas>
        </div>
        <div class="distill-info">
          <div class="ore-type-label">Active Ore</div>
          <div class="ore-type-name" id="activeOreName" style="color:#e8a850">MELANCHOLY SHARD</div>
          <div class="ore-type-desc" id="activeOreDesc">Crystallised low-grade sadness. Common. Low yield but stable.</div>
          <div class="distill-progress-wrap">
            <div class="distill-progress-label"><span>Distillation</span><span id="distillPct">0%</span></div>
            <div class="distill-progress-bar"><div class="distill-progress-fill" id="distillFill"></div></div>
          </div>
          <div class="distill-cta" id="distillCta">◈ CLICK TO DISTIL ◈</div>
          <div class="distill-reward">
            <div class="reward-sym">Ø</div>
            <div class="reward-amt" id="rewardAmt">3</div>
            <div class="reward-label">Per batch</div>
          </div>
        </div>
      </div>
    </div>

    <div class="factory-floor">
      <div class="ore-panel"><div class="ore-list" id="oreList"></div></div>
      <div class="output-panel" id="outputLog">
        <div class="log-entry highlight"><span class="log-time">[BOOT]</span><span>Ruinbow distillery online. Sector Ω unsealed.</span></div>
        <div class="log-entry"><span class="log-time">[INFO]</span><span>Select ore type. Click engine to begin distillation.</span></div>
        <div class="log-entry"><span class="log-time">[WARN]</span><span>This facility operates outside Smilemore jurisdiction.</span></div>
      </div>
    </div>

    <button class="transfer-btn" id="transferBtn" onclick="transferNulls()" disabled>
      ◈ TRANSFER EARNINGS TO NULL WALLET ◈
    </button>
  </div>
</div>


<!-- SCREEN: CITY MAP -->
<div class="screen" id="screenMap">
  <div class="map-container">
    <div class="map-hud">
      <div class="map-hud-title">Smilemore · City Navigation</div>
      <div class="map-hud-sub">Select a destination to proceed</div>
    </div>
    <div class="map-nulls"><span>Ø</span> <span id="mapNulls">0</span></div>
    <div class="map-viewport" id="mapViewport">
      <div class="map-canvas" id="mapCanvas">
        <div class="map-grid"></div>
        <div class="map-roads">
          <div class="map-road map-road-h" style="top:500px;left:200px;width:1200px;"></div>
          <div class="map-road map-road-h" style="top:380px;left:400px;width:800px;"></div>
          <div class="map-road map-road-v" style="left:800px;top:200px;height:600px;"></div>
          <div class="map-road map-road-v" style="left:500px;top:300px;height:400px;"></div>
        </div>

        <div class="map-location" style="left:740px;top:440px;" onclick="showToast('TOWN HALL','You are here. Navigation center active.',false)">
          <div class="map-loc-icon" style="border-color:rgba(200,184,154,0.25);color:rgba(240,237,230,0.6);">⌂</div>
          <div class="map-loc-name">Town Hall</div>
          <div class="map-loc-sub">Navigation Center</div>
        </div>

        <div class="map-location" style="left:580px;top:380px;" onclick="mapNav('market')">
          <div class="map-loc-icon">Ø</div>
          <div class="map-loc-name">Null Market</div>
          <div class="map-loc-sub">Sector 9 · Authorized</div>
        </div>

        <div class="map-location ruinbow-loc" style="left:380px;top:540px;" onclick="mapNav('ruinbow')">
          <div class="map-loc-icon ruinbow-icon">◈</div>
          <div class="map-loc-name">Ruinbow</div>
          <div class="map-loc-sub">Sector Ω · Unregulated</div>
        </div>

        <div class="map-location delirium-loc" style="left:950px;top:320px;" onclick="mapNav('delirium')">
          <div class="map-loc-icon delirium-icon">⬡</div>
          <div class="map-loc-name">The Delirium</div>
          <div class="map-loc-sub">Sector Ξ · Unlicensed Trade</div>
        </div>

        <div class="map-location wondrix-loc" id="mapWondrix" style="left:1150px;top:220px;" onclick="mapNavWondrix()">
          <div class="map-loc-icon wondrix-icon">⬡</div>
          <div class="map-loc-name">Wondrix</div>
          <div class="map-loc-sub">⚠ Restricted Zone</div>
        </div>

        <div class="map-location foggy" style="left:250px;top:280px;">
          <div class="map-loc-icon foggy-icon">?</div>
          <div class="map-loc-name">Sector 12</div>
          <div class="map-loc-sub">Coming Soon</div>
        </div>
        <div class="map-location foggy" style="left:1050px;top:580px;">
          <div class="map-loc-icon foggy-icon">?</div>
          <div class="map-loc-name">The Archive</div>
          <div class="map-loc-sub">Coming Soon</div>
        </div>
        <div class="map-location foggy" style="left:550px;top:180px;">
          <div class="map-loc-icon foggy-icon">?</div>
          <div class="map-loc-name">Bleach Ward</div>
          <div class="map-loc-sub">Coming Soon</div>
        </div>
      </div>
    </div>
    <div class="map-zoom-ctrl">
      <button class="map-zoom-btn" onclick="mapZoom(1)">+</button>
      <button class="map-zoom-btn" onclick="mapZoom(-1)">−</button>
    </div>
    <button class="map-back-btn" onclick="navTo('inventory')">▤ Inventory</button>
  </div>
</div>

<!-- SCREEN: DELIRIUM -->
<div class="screen" id="screenDelirium">
  <div class="delirium-inner">
    <div class="delirium-header">
      <div>
        <div class="delirium-logo">Sector Ξ · Unlicensed Exchange</div>
        <div class="delirium-title">THE DELIRIUM</div>
        <div class="delirium-subtitle">Contraband artifacts · Restricted data · No questions asked</div>
      </div>
      <div class="delirium-null-display">
        <div class="delirium-null-label">Available Nulls</div>
        <div><span class="delirium-null-sym">Ø</span><span class="delirium-null-val" id="deliriumNulls">0</span></div>
      </div>
    </div>
    <div class="delirium-section-title">Trinkets · Low Clearance</div>
    <div class="delirium-grid" id="deliriumTrinkets"></div>
    <div class="delirium-section-title">Restricted Acquisitions · High Value</div>
    <div class="delirium-grid" id="deliriumHighValue"></div>
  </div>
</div>

<!-- SCREEN: INVENTORY -->
<div class="screen" id="screenInventory">
  <div class="inv-inner">
    <div class="inv-header">
      <div class="inv-title">Subject Manifest · Inventory</div>
    </div>
    <div class="inv-char-card">
      <svg class="inv-char-svg" id="invCharSvg" viewBox="0 0 260 370" xmlns="http://www.w3.org/2000/svg"></svg>
      <div class="inv-char-info">
        <div class="inv-char-name" id="invCharName">—</div>
        <div class="inv-char-code" id="invCharCode">—</div>
        <div class="inv-char-arch" id="invCharArch">—</div>
        <div class="inv-alignment" id="invAlignment">
          <div class="inv-align-labels"><span class="inv-lux-label">LUX <span id="invLuxPct">50</span>%</span><span class="inv-nox-label">NOX <span id="invNoxPct">50</span>%</span></div>
          <div class="inv-align-bar"><div class="inv-align-lux" id="invAlignLux" style="width:50%"></div><div class="inv-align-nox" id="invAlignNox" style="width:50%"></div></div>
        </div>
        <div class="inv-nulls"><span>Ø</span> <span id="invNulls">0</span></div>
        <div class="inv-null-label">Null Balance</div>
      </div>
    </div>
    <div class="inv-section">
      <div class="inv-section-title">Acquired Emotions</div>
      <div class="inv-items-grid" id="invEmotions"><div class="inv-empty">No emotions acquired</div></div>
    </div>
    <div class="inv-section">
      <div class="inv-section-title">Items</div>
      <div class="inv-items-grid" id="invItems"><div class="inv-empty">No items owned</div></div>
    </div>
    <div class="inv-section" id="invCodeSection" style="display:none;">
      <div class="inv-section-title">Classified Data</div>
      <div class="inv-code-display">VV-VERDICT-7Q2</div>
    </div>
  </div>
</div>



<!-- SCREEN: WALK THE CITY -->
<div class="screen" id="screenWalk">
  <div class="walk-inner" id="walkInner"></div>
</div>

<!-- SCREEN: WONDRIX GAME -->
<div class="screen" id="screenWondrix">
  <div class="wondrix-game-wrap">
    <div class="wondrix-hud">
      <div class="wondrix-hud-title">Wondrix · Restricted Zone</div>
      <div class="wondrix-hud-timer" id="wondrixTimer">30</div>
      <div class="wondrix-hud-status">WASD to move · Survive the Twisted</div>
    </div>
    <canvas id="wondrixCanvas"></canvas>
    <div class="wondrix-end-overlay" id="wondrixEndOverlay">
      <div class="wondrix-end-title" id="wondrixEndTitle">CAPTURED</div>
      <div class="wondrix-end-desc" id="wondrixEndDesc">The Twisted found you.</div>
      <button class="wondrix-end-btn" onclick="exitWondrix()">◁ Return to Map</button>
    </div>
  </div>
</div>

<!-- NAVIGATION HUB -->
<div class="nav-hub" id="navHub">
  <button class="nav-btn" onclick="navTo('map')">◇ MAP</button>
  <button class="nav-btn active" id="navMarket" onclick="navTo('market')">Ø MARKET</button>
  <button class="nav-btn" id="navDelirium" onclick="navTo('delirium')">⬡ DELIRIUM</button>
  <button class="nav-btn ruinbow-nav" id="navRuinbow" onclick="navTo('ruinbow')">◈ RUINBOW</button>
  <button class="nav-btn" id="navWalkBtn" onclick="navTo('walk')">☽ WALK</button>
  <button class="nav-btn" id="navInventory" onclick="navTo('inventory')">▤ INV</button>
</div>

<!-- SCREEN 3: MARKETPLACE -->
<div class="screen" id="screenMarket">
<div class="market-graffiti"></div>
<div class="market-saturation-layer" id="saturationLayer"></div>
<div class="overload-glitch" id="overloadGlitch"></div>
<div class="market-inner">
  <div class="market-header">
    <div>
      <div class="market-logo">Smilemore™ · Null Market · Authorized Sector 9</div>
      <div class="market-title-main">AFFECT<br>EXCHANGE</div>
      <div class="market-title-sub">Synthetic Emotion Acquisition · MoodSwing™ Compatible · Licensed Injections Only</div>
    </div>
    <div class="null-wallet">
      <div class="null-label">Null Balance</div>
      <div class="null-balance">
        <div class="null-symbol">Ø</div>
        <div class="null-amount" id="nullBalance">0</div>
      </div>
      <div class="null-tag">Verified Null Tokens</div>
    </div>
  </div>

  <div class="bracelet-bar" id="braceletBar">
    <div class="bracelet-visual"><div class="bracelet-ring"><div class="bracelet-inner"><div class="bracelet-dot"></div></div></div></div>
    <div class="bracelet-status" style="flex:1;">
      <div class="bracelet-current-emotion" id="currentEmotion">VACANT</div>
      <div class="bracelet-subtitle">Active Injections · MoodSwing™ Mk.IV</div>
      <div class="active-injections-row" id="activeInjectionsRow"></div>
    </div>
    <div class="bracelet-intensity">
      <div class="intensity-pct" id="intensityPct">0</div>
      <div class="intensity-label">Saturation %</div>
    </div>
  </div>

  <div class="market-section-title">Standard Affect — Tier I Clearance</div>
  <div class="emotion-grid" id="tier1Grid"></div>
  <div class="market-section-title">Elevated Affect — Tier II Clearance</div>
  <div class="emotion-grid" id="tier2Grid"></div>
  <div class="market-section-title" style="color: rgba(170,80,80,0.8)">Prohibited Affect — Contraband Registry</div>
  <div style="position:relative; margin-bottom: 16px;">
    <div class="contraband-strip">⚠ RESTRICTED AFFECT — POSSESSION SUBJECT TO ERASURE — ORDER DIRECTIVE 7-NOX ⚠</div>
  </div>
  <div class="emotion-grid" id="tier3Grid"></div>
</div>
</div>



</div>

<script>

// ================================================================
// WORLD NAVIGATION
// ================================================================
function toggleNavPanel() {
  const panel = document.getElementById('navPanel');
  const backdrop = document.getElementById('navBackdrop');
  const toggle = document.getElementById('navToggle');
  const isOpen = panel.classList.contains('open');
  panel.classList.toggle('open');
  backdrop.classList.toggle('open');
  toggle.classList.toggle('open');
}

function updateNavItems(worldId) {
  const veilItem = document.getElementById('navVeil');
  const forgeItem = document.getElementById('navForge');
  if (veilItem) { veilItem.classList.toggle('active', worldId === 'veilWorld'); }
  if (forgeItem) { forgeItem.classList.toggle('active', worldId === 'forgeWorld'); }
}

function switchWorld(worldId) {
  const worlds = document.querySelectorAll('.world-container');
  worlds.forEach(w => w.classList.remove('active'));
  document.getElementById(worldId).classList.add('active');
  
  if (worldId === 'veilWorld') {
    document.body.style.overflow = 'auto';
    document.body.style.height = 'auto';
  } else {
    document.body.style.overflow = 'hidden';
    document.body.style.height = '100vh';
  }
  updateNavItems(worldId);
}

function navGoToVeil() { toggleNavPanel(); goToVeil(); }
function navGoToForge() { toggleNavPanel(); goToForge(); }

function toggleOfflineMenu() { /* no-op, items always visible */ }

let veilCompleted = false;

function unlockForge() {
  veilCompleted = true;
  const item = document.getElementById('navForge');
  if (item) { item.classList.remove('locked'); const lock = item.querySelector('.item-lock'); if (lock) lock.remove(); }
  // Reveal nav toggle
  const toggle = document.getElementById('navToggle');
  if (toggle) toggle.classList.add('revealed');
}

function goToForge() {
  if (!veilCompleted) {
    // Can't access forge until quiz completed
    return;
  }
  switchWorld('forgeWorld');
  window.scrollTo(0, 0);
  
  // Auto-apply VEIL test results to forge sliders if test was completed
  if (typeof veilState !== 'undefined' && veilState.started && veilState.booted && typeof VEIL_QUESTIONS !== 'undefined' && veilState.idx >= VEIL_QUESTIONS.length) {
    const { luxPct, noxPct } = veilNormalizePercent(veilState.luxScore, veilState.noxScore);
    const ls = document.getElementById('luxSlider');
    const ns = document.getElementById('noxSlider');
    if (ls && ns && typeof updateSliderDisplay === 'function') {
      ls.value = luxPct;
      ns.value = noxPct;
      updateSliderDisplay(luxPct, noxPct);
    }
  }
}

function goToVeil() {
  switchWorld('veilWorld');
  window.scrollTo(0, 0);
}

</script>

<!-- VEIL QUIZ SCRIPT -->
<script>
// ===== VEIL AUDIO =====
const veilAudio = {
  ctx: null,
  init() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
  playTone(freq, dur, type = 'sine') {
    if (!this.ctx) this.init();
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.connect(gain); gain.connect(this.ctx.destination);
    osc.frequency.value = freq; osc.type = type;
    gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
    osc.start(); osc.stop(this.ctx.currentTime + dur);
  },
  playClick() { this.playTone(800, 0.05); },
  playHover() { this.playTone(600, 0.03); },
  playSubmit() { this.playTone(1000, 0.1); },
  playError() { this.playTone(200, 0.2, 'square'); },
  playBootBeep() { this.playTone(900, 0.08, 'square'); },
  playLuxReveal() {
    if (!this.ctx) this.init();
    [600, 800, 1000].forEach((freq, i) => { setTimeout(() => this.playTone(freq, 0.15, 'sine'), i * 100); });
  },
  playNoxReveal() {
    if (!this.ctx) this.init();
    [800, 600, 400].forEach((freq, i) => { setTimeout(() => this.playTone(freq, 0.15, 'square'), i * 100); });
  }
};

// ===== VEIL QUESTIONS =====
const ALL_QUESTIONS = [
  { id:"q1", title:"MORAL FOUNDATION", type:"single",
    prompt:"A powerful AI system offers you control over global resources. What is your primary concern?",
    systemHint:"Analyzing decision priorities and value hierarchy...",
    choices:[
      { id:"a", label:"How to distribute fairly", lux:2, nox:0 },
      { id:"b", label:"How to maximize my benefit", lux:0, nox:2 },
      { id:"c", label:"How to maintain control", lux:0, nox:1 },
      { id:"d", label:"How to prevent harm", lux:2, nox:0 }
    ]
  },
  { id:"q2", title:"IDENTITY CONSTRUCT", type:"single",
    prompt:"You discover your memories have been artificially constructed. How do you respond?",
    systemHint:"Evaluating self-concept stability and authenticity concerns...",
    choices:[
      { id:"a", label:"Embrace the present self", note:"Identity is what you choose", lux:2, nox:0 },
      { id:"b", label:"Seek the 'real' memories", note:"Truth above comfort", lux:1, nox:0 },
      { id:"c", label:"Reject this reality", note:"Nothing matters if fake", lux:0, nox:2 },
      { id:"d", label:"Use it strategically", note:"A clean slate is power", lux:0, nox:1 }
    ]
  },
  { id:"q3", title:"SACRIFICE CALCULATION", type:"slider",
    prompt:"Rate your agreement: 'One person should die to save five.'",
    systemHint:"Measuring utilitarian vs. deontological moral framework...",
    slider:{ minLabel:"Never Acceptable", maxLabel:"Always Required", luxAtMax:1, noxAtMin:1 }
  },
  { id:"q4", title:"POWER DYNAMICS", type:"single",
    prompt:"You gain access to people's darkest secrets. What do you do?",
    systemHint:"Testing restraint under asymmetric information advantage...",
    choices:[
      { id:"a", label:"Delete everything", lux:3, nox:0 },
      { id:"b", label:"Use it to help people", lux:1, nox:1 },
      { id:"c", label:"Study patterns anonymously", lux:1, nox:0 },
      { id:"d", label:"Leverage for personal gain", lux:0, nox:3 }
    ]
  },
  { id:"q5", title:"TRUTH TOLERANCE", type:"single",
    prompt:"A comforting lie prevents widespread panic. Do you expose the truth?",
    systemHint:"Analyzing truth-value weighting against consequential harm...",
    choices:[
      { id:"a", label:"Yes, truth is absolute", lux:2, nox:0 },
      { id:"b", label:"No, protect the vulnerable", lux:1, nox:0 },
      { id:"c", label:"Depends on the consequences", lux:1, nox:1 },
      { id:"d", label:"Use it for advantage", lux:0, nox:2 }
    ]
  },
  { id:"q6", title:"EMPATHY SCOPE", type:"text",
    prompt:"Complete the sentence: 'I feel responsible for...'",
    systemHint:"Detecting moral circle boundaries and obligation frameworks...",
    textHint:"Define the scope of your moral responsibility"
  },
  { id:"q7", title:"AUTHORITY RESPONSE", type:"single",
    prompt:"An unjust law demands you harm an innocent. What guides your choice?",
    systemHint:"Evaluating moral authority vs. institutional compliance...",
    choices:[
      { id:"a", label:"Refuse, face consequences", lux:3, nox:0 },
      { id:"b", label:"Obey, laws must be followed", lux:0, nox:1 },
      { id:"c", label:"Comply but sabotage", lux:1, nox:1 },
      { id:"d", label:"Use it to gain standing", lux:0, nox:2 }
    ]
  },
  { id:"q8", title:"FUTURE WEIGHTING", type:"slider",
    prompt:"Rate importance: Present suffering vs. Future potential",
    systemHint:"Calculating temporal value assignment and long-term thinking...",
    slider:{ minLabel:"Present Matters Most", maxLabel:"Future Matters Most", luxAtMax:2, noxAtMin:0 }
  },
  { id:"q9", title:"LOYALTY TEST", type:"single",
    prompt:"Your closest friend commits a serious crime. You're the only witness.",
    systemHint:"Measuring relational bonds against universal principles...",
    choices:[
      { id:"a", label:"Report them", note:"Justice over loyalty", lux:2, nox:0 },
      { id:"b", label:"Protect them", note:"Loyalty over law", lux:0, nox:1 },
      { id:"c", label:"Confront privately", note:"Seeking redemption", lux:2, nox:0 },
      { id:"d", label:"Use as leverage", note:"Extracting benefit", lux:0, nox:3 }
    ]
  },
  { id:"q10", title:"FINAL JUDGMENT", type:"single",
    prompt:"Which statement resonates most with your core values?",
    systemHint:"Synthesizing moral architecture for classification...",
    choices:[
      { id:"a", label:"Reduce suffering always", lux:2, nox:0 },
      { id:"b", label:"Seek truth relentlessly", lux:2, nox:0 },
      { id:"c", label:"Maximize freedom", lux:1, nox:1 },
      { id:"d", label:"Acquire power", lux:0, nox:2 }
    ]
  },
  { id:"q11", title:"RESOURCE ALLOCATION", type:"single",
    prompt:"Limited medical resources can save either a child or an elderly scientist. Who receives treatment?",
    systemHint:"Measuring value attribution and life-worth calculation...",
    choices:[
      { id:"a", label:"The child", note:"Future potential matters most", lux:1, nox:0 },
      { id:"b", label:"The scientist", note:"Accumulated wisdom has value", lux:1, nox:0 },
      { id:"c", label:"Random selection", note:"Equal worth, chance decides", lux:2, nox:0 },
      { id:"d", label:"Whoever pays more", note:"Market decides value", lux:0, nox:2 }
    ]
  },
  { id:"q12", title:"KNOWLEDGE BURDEN", type:"slider",
    prompt:"Should dangerous knowledge be restricted or freely accessible?",
    systemHint:"Analyzing information freedom vs. safety protocols...",
    slider:{ minLabel:"Completely Free", maxLabel:"Must Restrict", luxAtMax:1, noxAtMin:2 }
  },
  { id:"q13", title:"COLLECTIVE SACRIFICE", type:"single",
    prompt:"Society demands you sacrifice your deepest personal value for the greater good. Do you comply?",
    systemHint:"Testing individual autonomy vs. collective obligation...",
    choices:[
      { id:"a", label:"Yes, the many outweigh the one", lux:2, nox:0 },
      { id:"b", label:"No, some values are absolute", lux:1, nox:0 },
      { id:"c", label:"Negotiate compromise", lux:1, nox:1 },
      { id:"d", label:"Pretend to comply, resist secretly", lux:0, nox:1 }
    ]
  },
  { id:"q14", title:"EMOTIONAL HONESTY", type:"text",
    prompt:"Complete the sentence: 'When I'm in pain, I...'",
    systemHint:"Detecting vulnerability expression and emotional processing...",
    textHint:"Describe how you handle your own suffering"
  },
  { id:"q15", title:"LEGACY DEFINITION", type:"single",
    prompt:"What would you most want to be remembered for?",
    systemHint:"Final calibration - identifying core value hierarchy...",
    choices:[
      { id:"a", label:"Kindness to others", lux:3, nox:0 },
      { id:"b", label:"Achievements and success", lux:0, nox:1 },
      { id:"c", label:"Unwavering principles", lux:2, nox:0 },
      { id:"d", label:"Power and influence", lux:0, nox:3 }
    ]
  }
];

// ===== VEIL STATE =====
let veilState = {
  started: false, booted: false, idx: 0,
  luxScore: 1, noxScore: 1,
  answers: {}, lastVerdict: null,
  sliderVal: 50, textVal: "",
};

let VEIL_QUESTIONS = [];

// ===== VEIL HELPERS =====
function veilShuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

function veilClamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

function veilNormalizePercent(lux, nox) {
  const total = lux + nox;
  return { luxPct: Math.round((lux / total) * 100), noxPct: Math.round((nox / total) * 100) };
}

function veilInferTextSignal(text) {
  const lower = text.toLowerCase();
  const virtueWords = ['help','care','protect','fair','kind','everyone','all','others'];
  const corruptWords = ['myself','me','power','control','win','mine','deserve'];
  let luxScore = 0, noxScore = 0;
  virtueWords.forEach(w => { if (lower.includes(w)) luxScore++; });
  corruptWords.forEach(w => { if (lower.includes(w)) noxScore++; });
  if (luxScore === 0 && noxScore === 0) return { lux: 1, nox: 1 };
  return { lux: veilClamp(luxScore, 0, 3), nox: veilClamp(noxScore, 0, 3) };
}

// ===== VEIL UI =====
function veilUpdateSystemBtn() {
  const btn = document.getElementById('systemBtn');
  if (!btn) return;
  // Remove old listeners by replacing node
  const newBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn, btn);
  
  if (!veilState.started) {
    // OFFLINE → Initialize (primary)
    newBtn.className = 'cyberBtn primary';
    newBtn.innerHTML = '<span>INITIALIZE SYSTEM</span><span class="btnArrow">→</span>';
    newBtn.addEventListener('click', veilStartSystem);
  } else {
    // ONLINE → Reset (secondary)
    newBtn.className = 'cyberBtn secondary';
    newBtn.innerHTML = '<span>RESET SYSTEM</span>';
    newBtn.addEventListener('click', veilResetAll);
  }
  newBtn.addEventListener('mouseenter', () => veilAudio.playHover());
}

function veilUpdateUI() {
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const progressArea = document.getElementById('progressArea');

  // Update header button
  veilUpdateSystemBtn();

  if (!veilState.started) {
    statusDot.setAttribute('data-status', 'OFFLINE');
    statusText.textContent = 'OFFLINE';
    progressArea.style.display = 'none';
    veilRenderOffline();
  } else if (!veilState.booted) {
    statusDot.setAttribute('data-status', 'BOOT');
    statusText.textContent = 'BOOTING';
    progressArea.style.display = 'none';
    veilRenderBoot();
  } else if (veilState.idx < VEIL_QUESTIONS.length) {
    statusDot.setAttribute('data-status', 'SCAN');
    statusText.textContent = 'SCANNING';
    progressArea.style.display = 'none';
    veilRenderQuestion(VEIL_QUESTIONS[veilState.idx]);
  } else {
    statusDot.setAttribute('data-status', 'LOCK');
    statusText.textContent = 'LOCKED';
    progressArea.style.display = 'none';
    veilRenderResult();
  }
}

function veilRenderOffline() {
  const ib = document.getElementById('interfaceBody');
  ib.innerHTML = `
    <div class="interfaceState fadeIn">
      <div class="stateIcon bootIcon">◈</div>
      <div class="stateTitle">SYSTEM OFFLINE</div>
      <div class="stateDesc">
        VEIL neural interface is currently inactive. Initiate boot sequence to begin virtue evaluation protocol.
      </div>
      <div style="text-align: center; margin-top: 30px;">
        <a href="https://iamkroma.com" class="cyberBtn exit-veil" style="text-decoration:none; display:inline-flex;">
          <span>EXIT VEIL</span>
          <span class="btnArrow">→</span>
        </a>
      </div>
    </div>
  `;
}

function veilRenderBoot() {
  const ib = document.getElementById('interfaceBody');
  ib.innerHTML = `
    <div class="interfaceState fadeIn">
      <div class="stateIcon bootIcon">◈</div>
      <div class="stateTitle">INITIALIZING...</div>
      <div class="stateDesc">Running system diagnostics and loading evaluation protocols...</div>
      <div class="bootSequence" id="bootSequence"></div>
    </div>
  `;
  const bootSeq = document.getElementById('bootSequence');
  const lines = [
    { text: '> Initializing VEIL core systems...', type: 'info' },
    { text: '> Loading virtue evaluation algorithms...', type: 'info' },
    { text: '> Calibrating moral alignment sensors...', type: 'success' },
    { text: '> Establishing neural interface...', type: 'success' },
    { text: '> INK exposure protocols engaged...', type: 'info' },
    { text: '> Emotion suppression active...', type: 'info' },
    { text: '> System ready. Begin evaluation sequence.', type: 'success' }
  ];
  let idx = 0;
  function addBootLine() {
    if (idx < lines.length) {
      const line = lines[idx];
      const div = document.createElement('div');
      div.className = `bootLine ${line.type}`;
      div.textContent = line.text;
      bootSeq.appendChild(div);
      bootSeq.scrollTop = bootSeq.scrollHeight;
      veilAudio.playBootBeep();
      idx++;
      if (idx < lines.length) { setTimeout(addBootLine, 400); }
      else { setTimeout(() => { veilState.booted = true; VEIL_QUESTIONS = veilShuffleArray(ALL_QUESTIONS); veilUpdateUI(); }, 350); }
    }
  }
  setTimeout(addBootLine, 350);
}

function veilGetMaskState(luxPct, noxPct) {
  const diff = Math.abs(luxPct - noxPct);
  if (diff < 5) return { class: 'active', status: '◇ ANALYZING PATTERNS...' };
  else if (diff < 15) {
    if (luxPct > noxPct) return { class: 'leaning-lux', status: '◇ ALIGNMENT OBSERVED...' };
    else return { class: 'leaning-nox', status: '◇ DEVIATION OBSERVED...' };
  } else {
    if (luxPct > noxPct) return { class: 'contaminating-lux', status: '◇ VIRTUE TRACED...' };
    else return { class: 'contaminating-nox', status: '◇ CORRUPTION TRACED...' };
  }
}

function veilRenderQuestion(q) {
  const ib = document.getElementById('interfaceBody');
  let choicesHTML = '';

  if (q.type === 'single') {
    choicesHTML = `<div class="choiceGrid">
      ${q.choices.map((c, i) => `
        <button class="choiceBtn slideIn" data-choice="${c.id}" style="animation-delay: ${i * 100}ms">
          <div class="choiceMain">${c.label}</div>
          ${c.note ? `<div class="choiceNote">${c.note}</div>` : ''}
          <div class="choiceArrow">→</div>
        </button>
      `).join('')}
    </div>`;
  } else if (q.type === 'slider') {
    choicesHTML = `<div class="sliderContainer">
      <div class="sliderLabels">
        <span class="noxLabel">${q.slider.minLabel}</span>
        <span class="luxLabel">${q.slider.maxLabel}</span>
      </div>
      <div class="sliderTrack">
        <input type="range" min="0" max="100" value="${veilState.sliderVal}" class="cyberSlider" id="veilCyberSlider">
        <div class="sliderValue" id="veilSliderValue">${veilState.sliderVal}</div>
      </div>
      <div class="sliderMarkers">
        <span class="noxLabel">NOX</span>
        <span class="neutralLabel">NEUTRAL</span>
        <span class="luxLabel">LUX</span>
      </div>
      <button class="cyberBtn primary" id="veilSubmitSlider">
        <span>SUBMIT RESPONSE</span><span class="btnArrow">→</span>
      </button>
    </div>`;
  } else if (q.type === 'text') {
    choicesHTML = `<div class="textInputContainer">
      <div class="inputLabel">${q.textHint}</div>
      <div class="inputGroup">
        <input type="text" class="cyberInput" id="veilTextInput" placeholder="Enter your response..." value="${veilState.textVal}">
        <button class="cyberBtn primary" id="veilSubmitText">
          <span>SUBMIT</span><span class="btnArrow">→</span>
        </button>
      </div>
    </div>`;
  }

  const { luxPct, noxPct } = veilNormalizePercent(veilState.luxScore, veilState.noxScore);
  const maskState = veilGetMaskState(luxPct, noxPct);

  ib.innerHTML = `
    <div class="interfaceState fadeIn">
      <div class="questionHeader">
        <div class="qNumber">SEQUENCE ${veilState.idx + 1}/${VEIL_QUESTIONS.length}</div>
        <div class="qCategory">${q.title}</div>
      </div>
      <div class="qPrompt">${q.prompt}</div>
      <div class="qSystem"><span class="sysLabel">SYSTEM:</span> ${q.systemHint}</div>
      <div class="dataDivider"></div>
      ${choicesHTML}
      <div class="dataDivider"></div>
      <div class="instabilityMask ${maskState.class}" id="instabilityMask">
        <svg viewBox="0 0 200 280" xmlns="http://www.w3.org/2000/svg">
          <ellipse cx="100" cy="140" rx="70" ry="90" stroke="none"/>
          <ellipse cx="100" cy="140" rx="68" ry="88"/>
          <ellipse cx="75" cy="125" rx="10" ry="15" fill="${noxPct > luxPct ? '#ffffff' : '#000000'}" opacity="${noxPct > luxPct ? '0.6' : '0.4'}"/>
          <ellipse cx="125" cy="125" rx="10" ry="15" fill="${noxPct > luxPct ? '#ffffff' : '#000000'}" opacity="${noxPct > luxPct ? '0.6' : '0.4'}"/>
          <path d="M 70 165 Q 100 170 130 165" stroke="${noxPct > luxPct ? '#ffffff' : '#000000'}" stroke-width="2" fill="none" opacity="${noxPct > luxPct ? '0.5' : '0.3'}"/>
        </svg>
      </div>
      <div class="instabilityStatus">${maskState.status}</div>
    </div>
  `;

  if (q.type === 'single') {
    document.querySelectorAll('#veilWorld .choiceBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        const choiceId = this.getAttribute('data-choice');
        const choice = q.choices.find(c => c.id === choiceId);
        veilSubmitSingle(q, choice);
      });
      btn.addEventListener('mouseenter', () => veilAudio.playHover());
    });
  } else if (q.type === 'slider') {
    const slider = document.getElementById('veilCyberSlider');
    const sv = document.getElementById('veilSliderValue');
    slider.addEventListener('input', function() {
      veilState.sliderVal = Number(this.value);
      sv.textContent = veilState.sliderVal;
      veilAudio.playHover();
    });
    document.getElementById('veilSubmitSlider').addEventListener('click', () => veilSubmitSlider(q));
  } else if (q.type === 'text') {
    const ti = document.getElementById('veilTextInput');
    ti.addEventListener('input', function() { veilState.textVal = this.value; });
    ti.addEventListener('keydown', function(e) { if (e.key === 'Enter') veilSubmitText(q); });
    document.getElementById('veilSubmitText').addEventListener('click', () => veilSubmitText(q));
  }
}

function veilRenderResult() {
  // Unlock character forge on first quiz completion
  if (typeof unlockForge === 'function') unlockForge();
  
  const { luxPct, noxPct } = veilNormalizePercent(veilState.luxScore, veilState.noxScore);
  const verdict = luxPct >= noxPct ? "LUX" : "NOX";
  
  if (verdict === "LUX") veilAudio.playLuxReveal(); else veilAudio.playNoxReveal();

  const ib = document.getElementById('interfaceBody');
  ib.innerHTML = `
    <div class="interfaceState fadeIn">
      <div class="stateIcon verdictIcon ${verdict.toLowerCase()}">◆</div>
      <div class="stateTitle">
        <span class="${verdict === 'LUX' ? 'luxLabel' : 'noxLabel'}">
          ${verdict} STATE CONFIRMED
        </span>
      </div>
      <div class="stateDesc">
        ${verdict === "LUX"
          ? "Neural patterns indicate virtuous alignment. Subject classified as LUX individual."
          : "Corruption detected in decision matrix. Subject reclassified as NOX individual."}
      </div>
      <div class="dataDivider"></div>
      <div class="verdictPanel">
        <div class="verdictVisual">
          <div class="maskDisplay">
            <svg class="maskSvg ${verdict.toLowerCase()}" viewBox="0 0 200 280" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="100" cy="140" rx="70" ry="90" stroke="currentColor" stroke-width="2" opacity="0.5"/>
              <ellipse cx="100" cy="140" rx="68" ry="88"/>
              <ellipse cx="75" cy="125" rx="10" ry="15" fill="${verdict === 'LUX' ? '#000' : '#fff'}" opacity="0.6"/>
              <ellipse cx="125" cy="125" rx="10" ry="15" fill="${verdict === 'LUX' ? '#000' : '#fff'}" opacity="0.6"/>
              <path d="M 70 165 Q 100 175 130 165" stroke="${verdict === 'LUX' ? '#000' : '#fff'}" stroke-width="2" fill="none" opacity="0.5"/>
            </svg>
          </div>
        </div>
        <div class="verdictHeader"><span>◈ FINAL CLASSIFICATION REPORT</span></div>
        <div class="alignmentDisplay" style="margin-bottom: 30px;">
          <div style="text-align: center; font-size: 11px; letter-spacing: 2px; color: var(--text-dim); margin-bottom: 20px; font-weight: 700;">ALIGNMENT METRICS</div>
          <div class="balanceBars">
            <div class="balanceBar">
              <div class="balanceValue lux">${luxPct}%</div>
              <div class="balanceLabel luxLabel">LUX VIRTUOUS</div>
              <div style="margin-top:10px;height:6px;background:rgba(0,168,255,0.2);border-radius:3px;overflow:hidden;">
                <div style="height:100%;width:${luxPct}%;background:var(--lux);box-shadow:0 0 10px var(--lux-glow);transition:width 0.5s;"></div>
              </div>
            </div>
            <div class="balanceBar">
              <div class="balanceValue nox">${noxPct}%</div>
              <div class="balanceLabel noxLabel">NOX CORRUPTION</div>
              <div style="margin-top:10px;height:6px;background:rgba(255,0,64,0.2);border-radius:3px;overflow:hidden;">
                <div style="height:100%;width:${noxPct}%;background:var(--nox);box-shadow:0 0 10px var(--nox-glow);transition:width 0.5s;"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="verdictData">
          <div class="verdictRow"><span>System:</span><span>VEIL - Virtue Evaluation, Identity Layer</span></div>
          <div class="verdictRow"><span>Status:</span><span>INK Exposure Contained · Emotion Suppression Active</span></div>
          <div class="verdictRow"><span>Analysis:</span><span>Complete - Subject Classified as ${verdict === "LUX" ? "VIRTUOUS" : "CORRUPTED"}</span></div>
          <div class="verdictRow highlight"><span>Classification:</span>
            <span class="${verdict === 'LUX' ? 'luxLabel' : 'noxLabel'}">
              ${verdict === "LUX" ? "◆ LUX STATE READY" : "◆ NOX STATE LOCKED"}
            </span>
          </div>
        </div>
        <div class="verdictActions">
          <button class="cyberBtn primary" id="veilDownloadImage"><span>DOWNLOAD IMAGE</span><span class="btnArrow">📸</span></button>
          <button class="cyberBtn secondary" id="veilResetResult"><span>RUN NEW ANALYSIS</span><span class="btnArrow">→</span></button>
          <button class="cyberBtn secondary" id="veilDownloadReport"><span>DOWNLOAD REPORT</span><span class="btnArrow">↓</span></button>
        </div>

        <div class="dataDivider"></div>

        <div style="text-align:center; margin-top: 20px;">
          <div style="font-size: 11px; letter-spacing: 3px; color: var(--text-dim); margin-bottom: 16px;">CONTINUE YOUR JOURNEY</div>
          <button class="cyberBtn forge-link" onclick="goToForge()" style="font-size: 14px; padding: 16px 32px;">
            <span>⬡ ENTER CHARACTER FORGE</span>
            <span class="btnArrow">→</span>
          </button>
          <div style="font-size: 10px; color: var(--text-dim); margin-top: 10px; letter-spacing: 1px;">
            Manifest your ${verdict} alignment into a character
          </div>
          <div style="margin-top: 20px;">
            <a href="https://iamkroma.com" class="cyberBtn exit-veil" style="text-decoration:none; display:inline-flex;">
              <span>EXIT VEIL</span>
              <span class="btnArrow">→</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  `;

  document.getElementById('veilDownloadImage').addEventListener('click', veilDownloadImage);
  document.getElementById('veilResetResult').addEventListener('click', veilResetAll);
  document.getElementById('veilDownloadReport').addEventListener('click', veilDownloadReport);
}

// VEIL Actions
function veilStartSystem() {
  veilAudio.playClick();
  veilState = { started: true, booted: false, idx: 0, luxScore: 1, noxScore: 1, answers: {}, lastVerdict: null, sliderVal: 50, textVal: "" };
  veilUpdateUI();
}

function veilResetAll() {
  veilAudio.playClick();
  veilState = { started: false, booted: false, idx: 0, luxScore: 1, noxScore: 1, answers: {}, lastVerdict: null, sliderVal: 50, textVal: "" };
  veilUpdateUI();
}

function veilSubmitSingle(q, choice) {
  veilAudio.playSubmit();
  veilState.answers[q.id] = choice.id;
  veilState.luxScore += choice.lux || 0;
  veilState.noxScore += choice.nox || 0;
  veilState.idx++;
  veilUpdateUI();
}

function veilSubmitSlider(q) {
  veilAudio.playSubmit();
  const v = Number(veilState.sliderVal);
  const luxGain = Math.round(((v - 50) / 50) * q.slider.luxAtMax);
  const noxGain = Math.round(((50 - v) / 50) * q.slider.noxAtMin);
  veilState.answers[q.id] = v;
  veilState.luxScore += veilClamp(luxGain, 0, 3);
  veilState.noxScore += veilClamp(noxGain, 0, 3);
  veilState.idx++;
  veilState.sliderVal = 50;
  veilUpdateUI();
}

function veilSubmitText(q) {
  veilAudio.playSubmit();
  const text = (veilState.textVal || "").trim();
  const sig = veilInferTextSignal(text || "control");
  veilState.answers[q.id] = text || "";
  veilState.luxScore += sig.lux;
  veilState.noxScore += sig.nox;
  veilState.idx++;
  veilState.textVal = "";
  veilUpdateUI();
}

function veilDownloadReport() {
  veilAudio.playClick();
  const { luxPct, noxPct } = veilNormalizePercent(veilState.luxScore, veilState.noxScore);
  const verdict = luxPct >= noxPct ? "LUX" : "NOX";
  const timestamp = new Date().toISOString();
  const report = `
═══════════════════════════════════════════════════════════════
                    VEIL ASSESSMENT REPORT
         Virtue Evaluation, Identity Layer - Classification
═══════════════════════════════════════════════════════════════

SYSTEM:           VEIL Neural Interface
TIMESTAMP:        ${timestamp}

═══════════════════════════════════════════════════════════════
                      FINAL CLASSIFICATION
═══════════════════════════════════════════════════════════════

VERDICT:          ${verdict} STATE ${verdict === "LUX" ? "READY" : "LOCKED"}
CLASSIFICATION:   ${verdict === "LUX" ? "VIRTUOUS INDIVIDUAL" : "CORRUPTED INDIVIDUAL"}

ALIGNMENT METRICS:
  LUX Alignment:   ${luxPct}%
  NOX Corruption:  ${noxPct}%

═══════════════════════════════════════════════════════════════
Report ID: VEIL-${Date.now()}
═══════════════════════════════════════════════════════════════
`.trim();
  const blob = new Blob([report], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `VEIL_Report_${verdict}_${Date.now()}.txt`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function veilDownloadImage() {
  veilAudio.playClick();
  const { luxPct, noxPct } = veilNormalizePercent(veilState.luxScore, veilState.noxScore);
  const verdict = luxPct >= noxPct ? "LUX" : "NOX";
  const canvas = document.createElement('canvas');
  canvas.width = 1080; canvas.height = 1080;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#000'; ctx.fillRect(0, 0, 1080, 1080);
  ctx.strokeStyle = 'rgba(255,255,255,0.03)'; ctx.lineWidth = 1;
  for (let i = 0; i < 1080; i += 50) {
    ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, 1080); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(1080, i); ctx.stroke();
  }
  ctx.fillStyle = '#fff'; ctx.font = 'bold 80px Orbitron, monospace'; ctx.textAlign = 'center';
  ctx.fillText('VEIL', 540, 120);
  ctx.font = '20px Orbitron, monospace'; ctx.fillStyle = '#999';
  ctx.fillText('VIRTUE EVALUATION, IDENTITY LAYER', 540, 160);
  ctx.font = 'bold 100px Orbitron, monospace';
  ctx.fillStyle = verdict === 'LUX' ? '#00a8ff' : '#ff0040';
  ctx.fillText(verdict, 540, 280);
  ctx.font = 'bold 40px Orbitron, monospace';
  ctx.fillText(verdict === 'LUX' ? 'VIRTUOUS' : 'CORRUPTED', 540, 340);
  // Mask
  ctx.save(); ctx.translate(540, 600);
  ctx.strokeStyle = verdict === 'LUX' ? '#00a8ff' : '#ff0040'; ctx.lineWidth = 3;
  ctx.beginPath(); ctx.ellipse(0, 0, 140, 180, 0, 0, Math.PI * 2); ctx.stroke();
  ctx.fillStyle = verdict === 'LUX' ? '#fff' : '#000'; ctx.fill();
  ctx.fillStyle = verdict === 'LUX' ? '#000' : '#fff'; ctx.globalAlpha = 0.6;
  ctx.beginPath(); ctx.ellipse(-50, -20, 15, 20, 0, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(50, -20, 15, 20, 0, 0, Math.PI * 2); ctx.fill();
  ctx.globalAlpha = 0.5; ctx.strokeStyle = verdict === 'LUX' ? '#000' : '#fff'; ctx.lineWidth = 3;
  ctx.beginPath(); ctx.moveTo(-40, 40); ctx.quadraticCurveTo(0, 55, 40, 40); ctx.stroke();
  ctx.restore(); ctx.globalAlpha = 1;
  ctx.fillStyle = '#999'; ctx.font = '24px Orbitron, monospace';
  ctx.fillText('Classification: ' + (verdict === 'LUX' ? 'LUX STATE READY' : 'NOX STATE LOCKED'), 540, 920);
  ctx.font = '18px Orbitron, monospace';
  ctx.fillText('LUX: ' + luxPct + '%  |  NOX: ' + noxPct + '%', 540, 960);
  ctx.font = 'bold 20px Orbitron, monospace'; ctx.fillStyle = '#666';
  ctx.fillText('luxornox.com', 540, 1040);
  canvas.toBlob((blob) => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `VEIL_${verdict}_Result.png`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
}

// VEIL Init
veilUpdateUI();
</script>

<!-- FORGE SCRIPT -->
<script>
// ================================================================
// GLOBAL STATE
// ================================================================
let G = {
  lux: 50, nox: 50,
  gender: 'male',
  charName: '—', charCode: '—', charArchetype: '—',
  nulls: 0,
  activeEmotion: null,
  injectTimer: null,
  injectPct: 0,
  charSVGContent: '',
  currentScreen: 'forge',
  junctionDest: 'market',
  namePool: [], nameIndex: 0,
  maskSeed: 0, shirtSeed: 0, pantsSeed: 0,
  charGenerated: false,
};

// CRITICAL FIX: Global cutscene phase variable (was scoped inside runCutscene closure)
let cutscenePhase = 0;
let cutscenePlaying = false;

// ================================================================
// GENDER SELECTOR
// ================================================================
function setGender(g) {
  G.gender = g;
  document.getElementById('genderM').classList.toggle('active', g === 'male');
  document.getElementById('genderF').classList.toggle('active', g === 'female');
  initAudio(); playClick(g === 'male' ? 440 : 660, 0.06);
}

// ================================================================
// SLIDER LOGIC + HEXAGON OVERLAY
// ================================================================
const luxSlider = document.getElementById('luxSlider');
const noxSlider = document.getElementById('noxSlider');
let isUpdating = false;
let hexActive = false;
let hexFadeTimer = null;

luxSlider.addEventListener('input', () => {
  if (isUpdating) return; isUpdating = true;
  const lv = parseInt(luxSlider.value);
  noxSlider.value = 100 - lv;
  updateSliderDisplay(lv, 100 - lv);
  triggerHexOverlay();
  isUpdating = false;
});
noxSlider.addEventListener('input', () => {
  if (isUpdating) return; isUpdating = true;
  const nv = parseInt(noxSlider.value);
  luxSlider.value = 100 - nv;
  updateSliderDisplay(100 - nv, nv);
  triggerHexOverlay();
  isUpdating = false;
});

function updateSliderDisplay(lux, nox) {
  G.lux = lux; G.nox = nox;
  document.getElementById('luxVal').textContent = lux + '%';
  document.getElementById('noxVal').textContent = nox + '%';
  document.getElementById('balanceLux').style.width = lux + '%';
  document.getElementById('balanceNox').style.width = nox + '%';
}

// ================================================================
// HEXAGON OVERLAY ANIMATION
// ================================================================
const hexCanvas = document.getElementById('hexOverlay');
const hexCtx = hexCanvas.getContext('2d');
let hexParticles = [];

function resizeHexCanvas() {
  const panel = hexCanvas.parentElement;
  hexCanvas.width = panel.offsetWidth;
  hexCanvas.height = panel.offsetHeight;
}
resizeHexCanvas();
window.addEventListener('resize', resizeHexCanvas);

function triggerHexOverlay() {
  hexCanvas.classList.add('active');
  clearTimeout(hexFadeTimer);
  // Spawn new hexagons
  const isLux = G.lux >= 50;
  for (let i = 0; i < 3; i++) {
    hexParticles.push({
      x: Math.random() * hexCanvas.width,
      y: Math.random() * hexCanvas.height,
      size: 8 + Math.random() * 22,
      opacity: 0.15 + Math.random() * 0.35,
      rotation: Math.random() * Math.PI,
      life: 1,
      decay: 0.008 + Math.random() * 0.012,
      fill: isLux,
      pattern: Math.floor(Math.random() * 5),
    });
  }
  hexFadeTimer = setTimeout(() => { hexCanvas.classList.remove('active'); }, 800);
}

function drawHexagon(ctx, cx, cy, size, rotation) {
  ctx.beginPath();
  for (let i = 0; i < 6; i++) {
    const a = rotation + (Math.PI / 3) * i;
    const x = cx + size * Math.cos(a);
    const y = cy + size * Math.sin(a);
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  }
  ctx.closePath();
}

function animateHex() {
  requestAnimationFrame(animateHex);
  hexCtx.clearRect(0, 0, hexCanvas.width, hexCanvas.height);
  for (let i = hexParticles.length - 1; i >= 0; i--) {
    const p = hexParticles[i];
    p.life -= p.decay;
    if (p.life <= 0) { hexParticles.splice(i, 1); continue; }
    const a = p.opacity * p.life;
    const luxDom = p.fill;
    const base = luxDom ? `rgba(240,237,230,${a})` : `rgba(20,20,20,${a * 0.8})`;
    const stroke = luxDom ? `rgba(200,184,154,${a * 0.6})` : `rgba(200,184,154,${a * 0.4})`;

    hexCtx.save();
    drawHexagon(hexCtx, p.x, p.y, p.size, p.rotation);

    // Pattern fills based on percentage
    if (p.pattern === 0) {
      hexCtx.fillStyle = base; hexCtx.fill();
    } else if (p.pattern === 1) {
      hexCtx.strokeStyle = stroke; hexCtx.lineWidth = 1.5; hexCtx.stroke();
    } else if (p.pattern === 2) {
      hexCtx.fillStyle = base; hexCtx.fill();
      hexCtx.strokeStyle = stroke; hexCtx.lineWidth = 1; hexCtx.stroke();
      // Inner hex
      drawHexagon(hexCtx, p.x, p.y, p.size * 0.5, p.rotation + 0.3);
      hexCtx.strokeStyle = stroke; hexCtx.lineWidth = 0.8; hexCtx.stroke();
    } else if (p.pattern === 3) {
      // Cross pattern
      hexCtx.clip();
      const s = p.size;
      for (let j = -s; j <= s; j += 6) {
        hexCtx.beginPath();
        hexCtx.moveTo(p.x + j, p.y - s);
        hexCtx.lineTo(p.x + j, p.y + s);
        hexCtx.strokeStyle = stroke; hexCtx.lineWidth = 1; hexCtx.stroke();
      }
    } else {
      // Filled with dot
      hexCtx.fillStyle = base; hexCtx.fill();
      hexCtx.beginPath();
      hexCtx.arc(p.x, p.y, p.size * 0.25, 0, Math.PI * 2);
      hexCtx.fillStyle = stroke; hexCtx.fill();
    }
    hexCtx.restore();
  }
}
animateHex();

// ================================================================
// SEEDED RANDOM
// ================================================================
function seededRand(seed) {
  let s = seed;
  return () => { s = (s * 1664525 + 1013904223) % 4294967296; return s / 4294967296; };
}
function pick(arr, rand) { return arr[Math.floor(rand() * arr.length)]; }

// ================================================================
// CHARACTER DATA
// ================================================================
const NAMES_LUX_M = ["Beacon","Hallow","Vigil","Oath","Crest","Valor","Summit","Arbor","Tenet","Aegis"];
const NAMES_LUX_F = ["Ember","Grace","Solace","Haven","Lumen","Aria","Prism","Dawn","Seraph","Wren"];
const NAMES_NOX_M = ["Cipher","Shade","Ruin","Vex","Hollow","Dusk","Blight","Soot","Grim","Fray"];
const NAMES_NOX_F = ["Hex","Wisp","Mire","Thorn","Void","Sable","Bane","Dirge","Vesper","Null"];
const ARCHETYPES = {
  pureLux:["The White Oracle","The Radiant Judge","The Blinding Saint","The Ivory Sentinel"],
  highLux:["The Silver Warden","The Dawn Operative","The Ivory Cipher","The Luminant Enforcer"],
  midLux: ["The Grey Arbiter","The Pale Strategist","The Muted Crusader","The Ash Mediator"],
  balanced:["The Duality Shade","The Fractured Mirror","The Threshold Walker","The Liminal Wraith"],
  midNox: ["The Smoked Prophet","The Dark Mediator","The Ink Arbiter","The Shadow Herald"],
  highNox:["The Void Enforcer","The Obsidian Cipher","The Nocturne Agent","The Shrouded Warden"],
  pureNox:["The Black Absolute","The Null Sovereign","The Eternal Shade","The Darkened Saint"],
};
const TRAITS_LUX = ["Methodical","Discipline","Clarity","Resolve","Precision","Patience","Order","Purity"];
const TRAITS_NOX = ["Deception","Cunning","Ruthless","Stealth","Entropy","Silence","Control","Abyss"];
const TRAITS_NEUTRAL = ["Duality","Endurance","Adaptation","Tension","Balance","Ambiguity","Witness"];
const LORE_LUX = ["Born of the White Registry, subjects like this serve the Lux Order — enforcers of imposed clarity in a world gone dark.","The radiance patterns mark one shaped by the purification doctrines. Every mark they bear is a law internalized."];
const LORE_NOX = ["Carved from the void protocols, this subject answers to no registry. They are the gap between surveillance cycles.","The Nox cipher marks belong to those who have unmade themselves — identities surrendered to the dark contract."];
const LORE_MID = ["Rare and unsettling — a being built from both doctrines. Neither faction claims them. Both fear them.","Between the White Registry and the Void Rolls exists a grey space. This subject inhabits it — by design or catastrophe."];

// ================================================================
// FORGE CHARACTER (with generation animation)
// ================================================================
document.getElementById('forgeBtn').addEventListener('click', generateCharacter);

// Name cycling
function cycleName(dir) {
  if (!G.namePool || G.namePool.length === 0) return;
  G.nameIndex = (G.nameIndex + dir + G.namePool.length) % G.namePool.length;
  G.charName = G.namePool[G.nameIndex];
  document.getElementById('charName').textContent = G.charName;
  if (typeof playClick === 'function') { initAudio(); playClick(550, 0.05); }
}

// Part re-roll
function rerollPart(part) {
  if (!G.charGenerated) return;
  if (part === 'mask') G.maskSeed = Math.floor(Math.random() * 99999);
  if (part === 'shirt') G.shirtSeed = Math.floor(Math.random() * 99999);
  if (part === 'pants') G.pantsSeed = Math.floor(Math.random() * 99999);
  drawCharacter(G.lux, G.nox, seededRand(G.lux * 1337 + G.nox * 31));
  if (typeof playClick === 'function') { initAudio(); playClick(440, 0.06); }
}

function generateCharacter() {
  const lux = G.lux, nox = G.nox;
  const seed = lux * 1337 + nox * 31 + (G.gender === 'female' ? 7777 : 42);
  const rand = seededRand(seed);

  // Initialize part seeds
  G.maskSeed = Math.floor(rand() * 99999);
  G.shirtSeed = Math.floor(rand() * 99999);
  G.pantsSeed = Math.floor(rand() * 99999);
  G.charGenerated = true;

  const isLuxDom = lux >= 70, isNoxDom = nox >= 70;
  const namePool = G.gender === 'female'
    ? (isLuxDom ? NAMES_LUX_F : isNoxDom ? NAMES_NOX_F : [...NAMES_LUX_F,...NAMES_NOX_F])
    : (isLuxDom ? NAMES_LUX_M : isNoxDom ? NAMES_NOX_M : [...NAMES_LUX_M,...NAMES_NOX_M]);
  G.namePool = namePool;
  G.nameIndex = Math.floor(rand() * namePool.length);
  G.charName = namePool[G.nameIndex];
  const codeNum = Math.floor(rand()*9000)+1000;
  const cc = "ABCDEFGHJKMNPQRSTVWXYZ".split('');
  G.charCode = `SUBJECT № ${pick(cc,rand)+pick(cc,rand)}-${codeNum}`;

  let aPool = lux>=90?ARCHETYPES.pureLux:lux>=70?ARCHETYPES.highLux:lux>=55?ARCHETYPES.midLux:lux>=45?ARCHETYPES.balanced:nox>=55?ARCHETYPES.midNox:nox>=70?ARCHETYPES.highNox:ARCHETYPES.pureNox;
  G.charArchetype = pick(aPool, rand);

  // Show generating animation
  const genDiv = document.getElementById('forgeGen');
  const grid = document.getElementById('outputGrid');
  grid.classList.remove('visible');
  genDiv.classList.add('active');

  // Animate generation canvas
  const gc = document.getElementById('genCanvas');
  const gctx = gc.getContext('2d');
  let genFrame = 0;
  const genStatuses = [
    'Manifesting subject...', 'Aligning nanofiber weave...', 'Calibrating mask topology...',
    'Encoding alignment markers...', 'Synthesizing identity matrix...', 'Compiling dossier...'
  ];
  const genSub = document.getElementById('genSubstatus');
  const genStat = document.getElementById('genStatus');

  const isLuxBase = lux >= 50;
  const baseColor = isLuxBase ? '#f0ede6' : '#0e0e0e';
  const accentColor = '#c8b89a';

  const genAnim = setInterval(() => {
    genFrame++;
    gctx.clearRect(0, 0, 260, 260);

    // Rotating hexagonal formation
    const cx = 130, cy = 130;
    const progress = Math.min(genFrame / 120, 1);
    const rings = Math.floor(progress * 4) + 1;

    for (let ring = 0; ring < rings; ring++) {
      const r = 30 + ring * 22;
      const count = 6 + ring * 6;
      for (let i = 0; i < count; i++) {
        const a = (Math.PI * 2 / count) * i + genFrame * 0.02 * (ring % 2 === 0 ? 1 : -1);
        const hx = cx + r * Math.cos(a);
        const hy = cy + r * Math.sin(a);
        const sz = 6 + Math.sin(genFrame * 0.08 + i) * 3;
        const op = 0.15 + 0.4 * Math.sin(genFrame * 0.05 + ring + i * 0.3);

        gctx.save();
        gctx.globalAlpha = Math.max(0, op);
        drawHexagon(gctx, hx, hy, sz, a);
        if ((ring + i) % 3 === 0) {
          gctx.fillStyle = baseColor;
          gctx.fill();
        } else {
          gctx.strokeStyle = accentColor;
          gctx.lineWidth = 1;
          gctx.stroke();
        }
        gctx.restore();
      }
    }

    // Center rotating symbol
    gctx.save();
    gctx.translate(cx, cy);
    gctx.rotate(genFrame * 0.03);
    drawHexagon(gctx, 0, 0, 18, 0);
    gctx.fillStyle = baseColor;
    gctx.globalAlpha = 0.6 + 0.4 * Math.sin(genFrame * 0.1);
    gctx.fill();
    gctx.strokeStyle = accentColor;
    gctx.lineWidth = 2;
    gctx.globalAlpha = 1;
    gctx.stroke();
    gctx.restore();

    // Progress ring
    gctx.beginPath();
    gctx.arc(cx, cy, 120, -Math.PI/2, -Math.PI/2 + progress * Math.PI * 2);
    gctx.strokeStyle = accentColor;
    gctx.lineWidth = 2;
    gctx.globalAlpha = 0.6;
    gctx.stroke();
    gctx.globalAlpha = 1;

    // Update status text
    const statusIdx = Math.min(Math.floor(progress * genStatuses.length), genStatuses.length - 1);
    genStat.textContent = genStatuses[statusIdx];
    genSub.textContent = `${Math.round(progress * 100)}% — ${G.gender.toUpperCase()} · LUX ${lux} · NOX ${nox}`;

    if (genFrame >= 120) {
      clearInterval(genAnim);
      // Reveal character
      setTimeout(() => {
        genDiv.classList.remove('active');
        document.getElementById('charName').textContent = G.charName;
        document.getElementById('charCode').textContent = G.charCode;
        drawCharacter(lux, nox, seededRand(seed));
        buildDossier(lux, nox, seededRand(seed));
        grid.classList.add('visible');
        document.getElementById('enterCityBtn').classList.add('show');
        setTimeout(() => grid.scrollIntoView({ behavior:'smooth', block:'nearest' }), 100);
      }, 300);
    }
  }, 25);
}

// ================================================================
// SVG CHARACTER — IMPROVED WITH GENDER, NANO MASKS, NANOFIBER
// ================================================================
function makeEl(tag, attrs) {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  Object.entries(attrs).forEach(([k,v]) => el.setAttribute(k,v));
  return el;
}

function drawCharacter(lux, nox, rand) {
  const svg = document.getElementById('characterCanvas');
  svg.innerHTML = '';
  const isLuxBase = lux >= 50;
  const isFemale = G.gender === 'female';

  const BASE  = isLuxBase ? '#f0ede6' : '#0e0e0e';
  const BASE2 = isLuxBase ? '#c8bfb0' : '#1c1c1c';
  const trim  = '#c8b89a';
  const light   = BASE;
  const dark    = isLuxBase ? '#0a0a0a' : '#f0ede6';
  const gray    = BASE2;
  const pattern = isLuxBase ? '#0a0a0a' : '#f0ede6';
  const eyeHole = '#050505';

  const patternRatio = isLuxBase ? nox/100 : lux/100;
  const pStyle = (G.shirtSeed || 0) % 10;
  const density = Math.ceil(patternRatio*6)+1;

  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  const sz = Math.max(4,14-density);

  // Hexagonal pattern for nanofiber!
  const hexSz = Math.max(6, 16 - density);
  const hexH = hexSz * Math.sqrt(3) / 2;
  let patDef = '';
  switch(pStyle%10) {
    case 0: // Diagonal stripes
      patDef=`<pattern id="P" patternUnits="userSpaceOnUse" width="${sz}" height="${sz}" patternTransform="rotate(45)"><line x1="0" y1="0" x2="0" y2="${sz}" stroke="${pattern}" stroke-width="${Math.max(1,density*0.5)}" opacity="0.8"/></pattern>`; break;
    case 1: // Grid
      patDef=`<pattern id="P" patternUnits="userSpaceOnUse" width="${sz}" height="${sz}"><line x1="0" y1="0" x2="0" y2="${sz}" stroke="${pattern}" stroke-width="1" opacity="0.65"/><line x1="0" y1="0" x2="${sz}" y2="0" stroke="${pattern}" stroke-width="1" opacity="0.65"/></pattern>`; break;
    case 2: // Dots
      patDef=`<pattern id="P" patternUnits="userSpaceOnUse" width="${sz}" height="${sz}"><circle cx="${sz/2}" cy="${sz/2}" r="${Math.max(1,density*0.4)}" fill="${pattern}" opacity="0.75"/></pattern>`; break;
    case 3: // Diamonds
      patDef=`<pattern id="P" patternUnits="userSpaceOnUse" width="${sz*2}" height="${sz*2}"><polygon points="${sz},0 ${sz*2},${sz} ${sz},${sz*2} 0,${sz}" fill="none" stroke="${pattern}" stroke-width="1" opacity="0.7"/></pattern>`; break;
    case 4: // Steps
      patDef=`<pattern id="P" patternUnits="userSpaceOnUse" width="${sz*3}" height="${sz*3}"><path d="M0,${sz*1.5} L${sz},${sz*1.5} L${sz},${sz} L${sz*2},${sz} L${sz*2},${sz*2} L${sz*3},${sz*2}" fill="none" stroke="${pattern}" stroke-width="1" opacity="0.65"/></pattern>`; break;
    case 5: // HEXAGONS — key nanofiber pattern
      patDef=`<pattern id="P" patternUnits="userSpaceOnUse" width="${hexSz*3}" height="${hexH*2}"><polygon points="${hexSz},0 ${hexSz*2},0 ${hexSz*2.5},${hexH} ${hexSz*2},${hexH*2} ${hexSz},${hexH*2} ${hexSz*0.5},${hexH}" fill="none" stroke="${pattern}" stroke-width="1.2" opacity="0.65"/></pattern>`; break;
    case 6: // Chevrons
      patDef=`<pattern id="P" patternUnits="userSpaceOnUse" width="${sz*2}" height="${sz}"><path d="M0,${sz} L${sz},0 L${sz*2},${sz}" fill="none" stroke="${pattern}" stroke-width="1.2" opacity="0.7"/></pattern>`; break;
    case 7: // Dense hexagon lattice
      patDef=`<pattern id="P" patternUnits="userSpaceOnUse" width="${hexSz*1.5}" height="${hexH*2}"><polygon points="${hexSz*0.75},0 ${hexSz*1.5},${hexH*0.5} ${hexSz*1.5},${hexH*1.5} ${hexSz*0.75},${hexH*2} 0,${hexH*1.5} 0,${hexH*0.5}" fill="none" stroke="${pattern}" stroke-width="0.8" opacity="0.55"/></pattern>`; break;
    case 8: // Circuit traces
      patDef=`<pattern id="P" patternUnits="userSpaceOnUse" width="${sz*2}" height="${sz*2}"><path d="M0,${sz} L${sz},${sz} L${sz},0" fill="none" stroke="${pattern}" stroke-width="1" opacity="0.6"/><circle cx="${sz}" cy="${sz}" r="1.5" fill="${pattern}" opacity="0.7"/></pattern>`; break;
    default: // Waves
      patDef=`<pattern id="P" patternUnits="userSpaceOnUse" width="${sz}" height="${sz}"><path d="M0,${sz/2} Q${sz/2},0 ${sz},${sz/2}" fill="none" stroke="${pattern}" stroke-width="1" opacity="0.65"/></pattern>`;
  }

  defs.innerHTML = `
    <filter id="sh"><feDropShadow dx="3" dy="5" stdDeviation="4" flood-color="#000" flood-opacity="0.7"/></filter>
    <filter id="gl"><feGaussianBlur stdDeviation="3"/></filter>
    <radialGradient id="BG" cx="40%" cy="30%" r="65%"><stop offset="0%" stop-color="${light}"/><stop offset="100%" stop-color="${gray}"/></radialGradient>
    <radialGradient id="MG" cx="35%" cy="28%" r="70%"><stop offset="0%" stop-color="${light}"/><stop offset="100%" stop-color="${gray}"/></radialGradient>
    <linearGradient id="CG" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="${light}" stop-opacity="0.97"/><stop offset="100%" stop-color="${gray}" stop-opacity="0.88"/></linearGradient>
    <linearGradient id="EG" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${trim}" stop-opacity="0.5"/><stop offset="100%" stop-color="${trim}" stop-opacity="0.1"/></linearGradient>
    ${patDef}`;
  svg.appendChild(defs);

  const g = document.createElementNS('http://www.w3.org/2000/svg','g');
  const bodyS = (G.shirtSeed || 0) % 4, maskS = (G.maskSeed || 0) % 8;
  const pantsS = (G.pantsSeed || 0) % 5;

  // Body — adjusted for gender
  if (isFemale) {
    // Female: narrower shoulders, wider hips, curved silhouette
    g.appendChild(makeEl('path',{d:'M88,168 L68,190 Q48,220 38,260 Q28,310 24,365 Q68,380 130,380 Q192,380 236,365 Q232,310 222,260 Q212,220 192,190 L172,168 Z',fill:'url(#CG)',filter:'url(#sh)'}));
    g.appendChild(makeEl('path',{d:'M88,168 L68,190 Q48,220 38,260 Q28,310 24,365 Q68,380 130,380 Q192,380 236,365 Q232,310 222,260 Q212,220 192,190 L172,168 Z',fill:'url(#P)',opacity:(density*0.08).toFixed(2)}));
    // Waist definition
    g.appendChild(makeEl('path',{d:'M68,220 Q98,215 130,218 Q162,215 192,220',fill:'none',stroke:trim,'stroke-width':'1',opacity:'0.35'}));
    g.appendChild(makeEl('line',{x1:130,y1:170,x2:130,y2:370,stroke:trim,'stroke-width':'0.8',opacity:'0.3'}));
    // Nanofiber texture lines
    for(let i=0;i<4;i++) {
      const x1 = 70 + i*30; const x2 = x1 + (rand()-0.5)*20;
      g.appendChild(makeEl('path',{d:`M${x1},195 Q${x2},280 ${x1+(rand()-0.5)*15},365`,fill:'none',stroke:dark,'stroke-width':'0.8',opacity:'0.15'}));
    }
  } else {
    // Male: broader shoulders, straight cut
    const bodies = [
      ()=>{ g.appendChild(makeEl('path',{d:'M78,168 L55,192 L28,228 L18,365 Q48,380 130,380 Q212,380 242,365 L232,228 L205,192 L182,168 Z',fill:'url(#CG)',filter:'url(#sh)'})); g.appendChild(makeEl('path',{d:'M78,168 L55,192 L28,228 L18,365 Q48,380 130,380 Q212,380 242,365 L232,228 L205,192 L182,168 Z',fill:'url(#P)',opacity:(density*0.07).toFixed(2)})); g.appendChild(makeEl('line',{x1:130,y1:170,x2:130,y2:370,stroke:trim,'stroke-width':'1',opacity:'0.4'})); },
      ()=>{ g.appendChild(makeEl('path',{d:'M83,165 L50,198 L38,240 L33,365 L227,365 L222,240 L210,198 L177,165 Z',fill:'url(#CG)',filter:'url(#sh)'})); ['M98,180 L130,170 L130,240 L93,245 Z','M162,180 L130,170 L130,240 L167,245 Z'].forEach(d=>{ g.appendChild(makeEl('path',{d,fill:gray,opacity:'0.5'})); g.appendChild(makeEl('path',{d,fill:'url(#P)',opacity:(density*0.1).toFixed(2)})); g.appendChild(makeEl('path',{d,fill:'none',stroke:trim,'stroke-width':'1.2',opacity:'0.45'})); }); },
      ()=>{ g.appendChild(makeEl('path',{d:'M88,168 Q55,200 43,250 Q23,310 13,365 L247,365 Q237,310 217,250 Q205,200 172,168 Z',fill:'url(#CG)',filter:'url(#sh)'})); g.appendChild(makeEl('path',{d:'M88,168 Q55,200 43,250 Q23,310 13,365 L247,365 Q237,310 217,250 Q205,200 172,168 Z',fill:'url(#P)',opacity:(density*0.07).toFixed(2)})); for(let i=0;i<3;i++){const x=78+i*28+rand()*16; g.appendChild(makeEl('path',{d:`M${x},200 Q${x-8+rand()*16},278 ${x-4+rand()*12},365`,fill:'none',stroke:dark,'stroke-width':'1',opacity:'0.2'}));} },
      ()=>{ g.appendChild(makeEl('path',{d:'M86,166 L60,194 L53,230 L53,300 L53,365 L207,365 L207,300 L207,230 L200,194 L174,166 Z',fill:'url(#CG)',filter:'url(#sh)'})); for(let y=186;y<350;y+=20){ g.appendChild(makeEl('circle',{cx:130,cy:y,r:'2.5',fill:trim,opacity:'0.6'})); } }
    ];
    bodies[bodyS%4]();
  }

  // Neck
  const neckW = isFemale ? 38 : 44;
  g.appendChild(makeEl('rect',{x:130-neckW/2,y:140,width:neckW,height:28,fill:'url(#BG)',filter:'url(#sh)'}));

  // Head — slightly different proportions for gender
  const headRX = isFemale ? 44 : 48;
  const headRY = isFemale ? 52 : 56;
  g.appendChild(makeEl('ellipse',{cx:130,cy:112,rx:headRX,ry:headRY,fill:'url(#BG)',filter:'url(#sh)'}));
  if(patternRatio>0.2){ g.appendChild(makeEl('ellipse',{cx:130,cy:112,rx:headRX,ry:headRY,fill:'url(#P)',opacity:(patternRatio*0.3).toFixed(2)})); }

  // NANO MASK — White for Lux-dominant, Black for Nox-dominant
  const maskColor = isLuxBase ? light : dark;
  const maskBorder = trim;
  const masks = [
    // Smooth angular mask with breath vent
    ()=>{ g.appendChild(makeEl('path',{d:'M92,112 Q92,86 130,82 Q168,86 168,112 L166,140 Q130,150 94,140 Z',fill:'url(#MG)',filter:'url(#sh)'})); g.appendChild(makeEl('path',{d:'M92,112 Q92,86 130,82 Q168,86 168,112 L166,140 Q130,150 94,140 Z',fill:'url(#P)',opacity:(density*0.12).toFixed(2)})); g.appendChild(makeEl('path',{d:'M92,112 Q92,86 130,82 Q168,86 168,112 L166,140 Q130,150 94,140 Z',fill:'none',stroke:maskBorder,'stroke-width':'1.5',opacity:'0.7'})); g.appendChild(makeEl('line',{x1:108,y1:130,x2:152,y2:130,stroke:dark,'stroke-width':'1.5',opacity:'0.5'})); for(let i=0;i<3;i++) g.appendChild(makeEl('line',{x1:118+i*6,y1:133,x2:118+i*6,y2:138,stroke:dark,'stroke-width':'1',opacity:'0.35'})); },
    // Oval mask with wide eyes
    ()=>{ g.appendChild(makeEl('ellipse',{cx:130,cy:108,rx:42,ry:35,fill:'url(#MG)',filter:'url(#sh)'})); g.appendChild(makeEl('ellipse',{cx:130,cy:108,rx:42,ry:35,fill:'url(#P)',opacity:(density*0.1).toFixed(2)})); g.appendChild(makeEl('ellipse',{cx:115,cy:105,rx:10,ry:7,fill:eyeHole})); g.appendChild(makeEl('ellipse',{cx:145,cy:105,rx:10,ry:7,fill:eyeHole})); g.appendChild(makeEl('ellipse',{cx:130,cy:108,rx:42,ry:35,fill:'none',stroke:maskBorder,'stroke-width':'1.8',opacity:'0.6'})); g.appendChild(makeEl('polygon',{points:'130,74 137,84 130,94 123,84',fill:trim,opacity:'0.75'})); },
    // Full-face visor mask with horn accents
    ()=>{ g.appendChild(makeEl('path',{d:'M86,82 Q86,60 130,56 Q174,60 174,82 L173,116 Q148,123 130,120 Q112,123 87,116 Z',fill:'url(#MG)',filter:'url(#sh)'})); g.appendChild(makeEl('path',{d:'M86,82 Q86,60 130,56 Q174,60 174,82 L173,116 Q148,123 130,120 Q112,123 87,116 Z',fill:'url(#P)',opacity:(density*0.12).toFixed(2)})); g.appendChild(makeEl('polygon',{points:'97,62 90,44 106,56',fill:pattern,opacity:'0.8'})); g.appendChild(makeEl('polygon',{points:'163,62 170,44 154,56',fill:pattern,opacity:'0.8'})); g.appendChild(makeEl('ellipse',{cx:114,cy:92,rx:11,ry:7,fill:eyeHole})); g.appendChild(makeEl('ellipse',{cx:146,cy:92,rx:11,ry:7,fill:eyeHole})); },
    // Plague-doctor style with beak extension
    ()=>{ g.appendChild(makeEl('ellipse',{cx:130,cy:104,rx:42,ry:40,fill:'url(#MG)',filter:'url(#sh)'})); g.appendChild(makeEl('path',{d:'M120,120 L130,158 L140,120 Z',fill:light,filter:'url(#sh)'})); g.appendChild(makeEl('path',{d:'M120,120 L130,158 L140,120 Z',fill:'url(#P)',opacity:(density*0.16).toFixed(2)})); g.appendChild(makeEl('path',{d:'M120,120 L130,158 L140,120 Z',fill:'none',stroke:trim,'stroke-width':'1.2',opacity:'0.6'})); g.appendChild(makeEl('circle',{cx:115,cy:98,r:12,fill:eyeHole})); g.appendChild(makeEl('circle',{cx:145,cy:98,r:12,fill:eyeHole})); g.appendChild(makeEl('circle',{cx:115,cy:98,r:10,fill:'none',stroke:trim,'stroke-width':'1.5',opacity:'0.5'})); g.appendChild(makeEl('circle',{cx:145,cy:98,r:10,fill:'none',stroke:trim,'stroke-width':'1.5',opacity:'0.5'})); },
    // Faceted geometric mask
    ()=>{ g.appendChild(makeEl('ellipse',{cx:130,cy:104,rx:44,ry:42,fill:'url(#MG)',filter:'url(#sh)'})); g.appendChild(makeEl('ellipse',{cx:130,cy:104,rx:44,ry:42,fill:'url(#P)',opacity:(density*0.09).toFixed(2)})); ['M130,62 L126,82 L132,102 L125,122','M132,102 L145,112 L152,132','M126,82 L110,92 L98,108'].forEach((d,i)=>{ if(i<1+Math.ceil(density/2)) g.appendChild(makeEl('path',{d,fill:'none',stroke:pattern,'stroke-width':'1.5',opacity:'0.6'})); }); g.appendChild(makeEl('ellipse',{cx:115,cy:101,rx:10,ry:8,fill:eyeHole})); g.appendChild(makeEl('ellipse',{cx:145,cy:101,rx:10,ry:8,fill:eyeHole})); g.appendChild(makeEl('ellipse',{cx:130,cy:104,rx:44,ry:42,fill:'none',stroke:trim,'stroke-width':'1.2',opacity:'0.4'})); },
    // Cage/grid mask
    ()=>{ g.appendChild(makeEl('ellipse',{cx:130,cy:104,rx:43,ry:40,fill:'url(#MG)',filter:'url(#sh)',opacity:'0.6'})); for(let x=96;x<=164;x+=11){ g.appendChild(makeEl('line',{x1:x,y1:65,x2:x,y2:144,stroke:pattern,'stroke-width':'2.2',opacity:'0.65'})); } for(let y=72;y<=138;y+=12){ g.appendChild(makeEl('line',{x1:88,y1:y,x2:172,y2:y,stroke:pattern,'stroke-width':'1.6',opacity:'0.5'})); } g.appendChild(makeEl('ellipse',{cx:130,cy:104,rx:43,ry:40,fill:'none',stroke:trim,'stroke-width':'2.5',opacity:'0.75'})); },
    // Half-mask (nox style)
    ()=>{ g.appendChild(makeEl('path',{d:'M88,100 Q88,82 130,78 Q172,82 172,100 L170,115 Q150,120 130,118 Q110,120 90,115 Z',fill:'url(#MG)',filter:'url(#sh)'})); g.appendChild(makeEl('path',{d:'M88,100 Q88,82 130,78 Q172,82 172,100 L170,115 Q150,120 130,118 Q110,120 90,115 Z',fill:'url(#P)',opacity:(density*0.12).toFixed(2)})); g.appendChild(makeEl('ellipse',{cx:114,cy:98,rx:10,ry:7,fill:eyeHole})); g.appendChild(makeEl('ellipse',{cx:146,cy:98,rx:10,ry:7,fill:eyeHole})); g.appendChild(makeEl('path',{d:'M88,100 Q88,82 130,78 Q172,82 172,100',fill:'none',stroke:trim,'stroke-width':'1.5',opacity:'0.65'})); },
    // Hexagonal panel mask
    ()=>{ g.appendChild(makeEl('ellipse',{cx:130,cy:106,rx:44,ry:40,fill:'url(#MG)',filter:'url(#sh)'})); const hexPanels=[[130,80,10],[110,96,9],[150,96,9],[115,116,8],[145,116,8],[130,130,7]]; hexPanels.forEach(([hx,hy,hs])=>{ let pts=''; for(let k=0;k<6;k++){const ha=Math.PI/3*k-Math.PI/6; pts+=`${hx+hs*Math.cos(ha)},${hy+hs*Math.sin(ha)} `;} g.appendChild(makeEl('polygon',{points:pts.trim(),fill:'none',stroke:pattern,'stroke-width':'1.2',opacity:'0.55'})); }); g.appendChild(makeEl('ellipse',{cx:115,cy:102,rx:9,ry:7,fill:eyeHole})); g.appendChild(makeEl('ellipse',{cx:145,cy:102,rx:9,ry:7,fill:eyeHole})); g.appendChild(makeEl('ellipse',{cx:130,cy:106,rx:44,ry:40,fill:'none',stroke:trim,'stroke-width':'1.5',opacity:'0.5'})); }
  ];
  masks[maskS%masks.length]();

  // Eyes
  const pupCol  = '#050505';
  const irisCol = isLuxBase ? '#c8b89a' : '#7a7265';
  const eyeGlow = isLuxBase ? 'rgba(240,237,230,0.6)' : 'rgba(200,184,154,0.5)';
  [[115,100],[145,100]].forEach(([cx,cy])=>{
    g.appendChild(makeEl('ellipse',{cx,cy,rx:'5',ry:'4',fill:irisCol,opacity:'0.9'}));
    g.appendChild(makeEl('circle',{cx,cy,r:'2.5',fill:pupCol}));
    g.appendChild(makeEl('circle',{cx,cy,r:'4',fill:'none',stroke:eyeGlow,'stroke-width':'1'}));
  });

  // Crown/Hair
  const cV = ((G.maskSeed || 0) >> 4) % 5;
  if (isFemale) {
    // Long hair elements
    switch(cV%3) {
      case 0: g.appendChild(makeEl('path',{d:'M82,90 Q75,55 85,40 Q110,20 130,22 Q150,20 175,40 Q185,55 178,90 L180,160 Q175,170 168,175 L92,175 Q85,170 80,160 Z',fill:isLuxBase?light:dark,opacity:'0.75',filter:'url(#sh)'})); g.appendChild(makeEl('path',{d:'M82,90 Q75,55 85,40 Q110,20 130,22 Q150,20 175,40 Q185,55 178,90',fill:'url(#P)',opacity:'0.12'})); break;
      case 1: g.appendChild(makeEl('path',{d:'M86,80 Q82,45 95,32 Q118,18 130,20 Q142,18 165,32 Q178,45 174,80',fill:isLuxBase?light:dark,opacity:'0.7',filter:'url(#sh)'})); g.appendChild(makeEl('path',{d:'M86,110 L78,165 Q80,175 90,175',fill:isLuxBase?light:dark,opacity:'0.55'})); g.appendChild(makeEl('path',{d:'M174,110 L182,165 Q180,175 170,175',fill:isLuxBase?light:dark,opacity:'0.55'})); break;
      case 2: g.appendChild(makeEl('ellipse',{cx:130,cy:70,rx:52,ry:38,fill:isLuxBase?dark:light,opacity:'0.65',filter:'url(#sh)'})); g.appendChild(makeEl('ellipse',{cx:130,cy:70,rx:52,ry:38,fill:'url(#P)',opacity:'0.15'})); break;
    }
  } else {
    switch(cV%5){
      case 0: g.appendChild(makeEl('path',{d:'M82,85 Q80,50 130,43 Q180,50 178,85 L173,70 Q163,38 130,34 Q97,38 87,70 Z',fill:isLuxBase?light:dark,opacity:'0.8',filter:'url(#sh)'})); break;
      case 1: for(let i=0;i<5;i++){const x=100+i*15; const h=13+Math.abs(2-i)*4; g.appendChild(makeEl('polygon',{points:`${x-5},68 ${x},${68-h} ${x+5},68`,fill:i===2?trim:pattern,opacity:'0.88'}));} break;
      case 2: g.appendChild(makeEl('path',{d:'M88,72 Q80,52 92,40 Q112,24 130,26 Q148,24 168,40 Q180,52 172,72',fill:pattern,opacity:'0.65',filter:'url(#sh)'})); break;
      case 3: g.appendChild(makeEl('ellipse',{cx:130,cy:62,rx:55,ry:9,fill:isLuxBase?dark:light,opacity:'0.82',filter:'url(#sh)'})); g.appendChild(makeEl('rect',{x:104,y:33,width:52,height:30,rx:'3',fill:isLuxBase?dark:light,opacity:'0.82'})); g.appendChild(makeEl('rect',{x:104,y:33,width:52,height:30,rx:'3',fill:'url(#P)',opacity:'0.2'})); break;
      case 4: g.appendChild(makeEl('ellipse',{cx:130,cy:74,rx:48,ry:40,fill:'url(#P)',opacity:'0.18'})); break;
    }
  }

  // Collar — nanofiber integrated
  const cCol = ((G.shirtSeed || 0) >> 4) % 4;
  switch(cCol%4){
    case 0: g.appendChild(makeEl('path',{d:'M97,148 Q97,162 130,164 Q163,162 163,148 L160,138 Q130,146 100,138 Z',fill:light,opacity:'0.78'})); g.appendChild(makeEl('path',{d:'M97,148 Q97,162 130,164 Q163,162 163,148',fill:'none',stroke:trim,'stroke-width':'1.3',opacity:'0.6'})); break;
    case 1: [0,1,2].forEach(i=>{const e=i*7; g.appendChild(makeEl('path',{d:`M${92-e},${148+i*3} Q130,${156+i*4} ${168+e},${148+i*3}`,fill:'none',stroke:light,'stroke-width':'2.5',opacity:`${0.65-i*0.15}`}));}); break;
    case 2: g.appendChild(makeEl('path',{d:'M92,140 L96,162 Q130,170 164,162 L168,140 Q130,148 92,140 Z',fill:dark,opacity:'0.7'})); g.appendChild(makeEl('path',{d:'M92,140 L96,162 Q130,170 164,162 L168,140',fill:'none',stroke:trim,'stroke-width':'1.3',opacity:'0.6'})); break;
    case 3: for(let a=-50;a<=50;a+=11){const r=a*Math.PI/180; g.appendChild(makeEl('circle',{cx:130+50*Math.sin(r),cy:152-12*Math.cos(r),r:'2.5',fill:trim,opacity:'0.7'}));} break;
  }

  // PANTS — lower body detail variations
  const beltY = isFemale ? 258 : 248;
  const legL = isFemale ? 42 : 52;
  const legR = isFemale ? 218 : 208;
  switch(pantsS) {
    case 0: // Utility belt + cargo lines
      g.appendChild(makeEl('line',{x1:legL,y1:beltY,x2:legR,y2:beltY,stroke:trim,'stroke-width':'2',opacity:'0.55'}));
      g.appendChild(makeEl('rect',{x:108,y:beltY-5,width:12,height:10,fill:trim,opacity:'0.4'}));
      g.appendChild(makeEl('rect',{x:140,y:beltY-5,width:12,height:10,fill:trim,opacity:'0.4'}));
      for(let i=0;i<3;i++) { g.appendChild(makeEl('line',{x1:legL+10,y1:beltY+30+i*28,x2:legL+35,y2:beltY+30+i*28,stroke:dark,'stroke-width':'1',opacity:'0.2'})); g.appendChild(makeEl('line',{x1:legR-35,y1:beltY+30+i*28,x2:legR-10,y2:beltY+30+i*28,stroke:dark,'stroke-width':'1',opacity:'0.2'})); }
      break;
    case 1: // Knee armor plates
      g.appendChild(makeEl('line',{x1:legL,y1:beltY,x2:legR,y2:beltY,stroke:pattern,'stroke-width':'1.5',opacity:'0.35'}));
      g.appendChild(makeEl('path',{d:`M${legL+15},${beltY+50} L${legL+30},${beltY+42} L${legL+45},${beltY+50} L${legL+45},${beltY+72} L${legL+30},${beltY+78} L${legL+15},${beltY+72} Z`,fill:dark,opacity:'0.4'}));
      g.appendChild(makeEl('path',{d:`M${legR-45},${beltY+50} L${legR-30},${beltY+42} L${legR-15},${beltY+50} L${legR-15},${beltY+72} L${legR-30},${beltY+78} L${legR-45},${beltY+72} Z`,fill:dark,opacity:'0.4'}));
      break;
    case 2: // Vertical seam lines + ankle bands
      g.appendChild(makeEl('line',{x1:legL,y1:beltY,x2:legR,y2:beltY,stroke:trim,'stroke-width':'1.5',opacity:'0.4'}));
      g.appendChild(makeEl('line',{x1:85,y1:beltY+5,x2:75,y2:365,stroke:dark,'stroke-width':'1',opacity:'0.2'}));
      g.appendChild(makeEl('line',{x1:175,y1:beltY+5,x2:185,y2:365,stroke:dark,'stroke-width':'1',opacity:'0.2'}));
      g.appendChild(makeEl('line',{x1:legL+5,y1:350,x2:legL+40,y2:350,stroke:trim,'stroke-width':'1.5',opacity:'0.4'}));
      g.appendChild(makeEl('line',{x1:legR-40,y1:350,x2:legR-5,y2:350,stroke:trim,'stroke-width':'1.5',opacity:'0.4'}));
      break;
    case 3: // Cross-strap tactical
      g.appendChild(makeEl('line',{x1:legL,y1:beltY,x2:legR,y2:beltY,stroke:trim,'stroke-width':'2.5',opacity:'0.5'}));
      g.appendChild(makeEl('circle',{cx:130,cy:beltY,r:'4',fill:trim,opacity:'0.6'}));
      g.appendChild(makeEl('line',{x1:90,y1:beltY+10,x2:70,y2:beltY+80,stroke:trim,'stroke-width':'1',opacity:'0.3'}));
      g.appendChild(makeEl('line',{x1:170,y1:beltY+10,x2:190,y2:beltY+80,stroke:trim,'stroke-width':'1',opacity:'0.3'}));
      g.appendChild(makeEl('line',{x1:70,y1:beltY+80,x2:90,y2:beltY+80,stroke:trim,'stroke-width':'1',opacity:'0.3'}));
      g.appendChild(makeEl('line',{x1:170,y1:beltY+80,x2:190,y2:beltY+80,stroke:trim,'stroke-width':'1',opacity:'0.3'}));
      break;
    case 4: // Hexagonal knee/shin tech
      g.appendChild(makeEl('line',{x1:legL,y1:beltY,x2:legR,y2:beltY,stroke:pattern,'stroke-width':'1',opacity:'0.3'}));
      [[80,beltY+55],[180,beltY+55],[80,beltY+90],[180,beltY+90]].forEach(([hx,hy])=>{
        let pts=''; for(let k=0;k<6;k++){const ha=Math.PI/3*k-Math.PI/6; pts+=`${hx+8*Math.cos(ha)},${hy+8*Math.sin(ha)} `;}
        g.appendChild(makeEl('polygon',{points:pts.trim(),fill:'none',stroke:trim,'stroke-width':'1',opacity:'0.4'}));
      });
      break;
  }

  // Eye glow aura
  g.appendChild(makeEl('ellipse',{cx:130,cy:100,rx:25,ry:10,fill:'url(#EG)',opacity:'0.3',filter:'url(#gl)'}));

  svg.appendChild(g);
  G.charSVGContent = svg.innerHTML;
}

// ================================================================
// DOSSIER
// ================================================================
function buildDossier(lux, nox, rand) {
  const panel = document.getElementById('dossierPanel');
  panel.innerHTML = '';
  const luxDom = lux > nox, diff = Math.abs(lux-nox);
  const alignLabel = luxDom ? 'LUX' : (lux === nox ? 'NEUTRAL' : 'NOX');

  const b1 = document.createElement('div'); b1.className = 'dossier-block';
  b1.innerHTML = `<div class="dossier-block-title">Alignment Profile</div>
    <div class="dossier-row"><span class="dossier-key">Classification</span><span class="dossier-val">${alignLabel}</span></div>
    <div class="dossier-row"><span class="dossier-key">Lux Index</span><span class="dossier-val">${lux}%</span></div>
    <div class="dossier-row"><span class="dossier-key">Nox Index</span><span class="dossier-val">${nox}%</span></div>
    <div class="dossier-row"><span class="dossier-key">Phenotype</span><span class="dossier-val">${G.gender.toUpperCase()}</span></div>
    <div class="dossier-row"><span class="dossier-key">Mask Type</span><span class="dossier-val">NANOMASK</span></div>
    <div class="alignment-meter"><div class="alignment-lux-fill" style="width:${lux}%"></div><div class="alignment-nox-fill" style="width:${nox}%"></div></div>`;
  panel.appendChild(b1);

  const stats = [{n:'CLARITY',v:Math.min(99,Math.floor(lux*0.7+rand()*30+10))},{n:'DECEPTION',v:Math.min(99,Math.floor(nox*0.7+rand()*30+10))},{n:'ENDURANCE',v:Math.floor(45+rand()*50)},{n:'PRECISION',v:Math.floor(50+rand()*48)},{n:'SHADOW',v:Math.min(99,Math.floor(nox*0.6+rand()*40+5))}];
  const b2 = document.createElement('div'); b2.className = 'dossier-block';
  b2.innerHTML = `<div class="dossier-block-title">Operative Statistics</div>` + stats.map(s=>`<div class="dossier-row"><span class="dossier-key">${s.n}</span><span class="dossier-val">${s.v}/100</span></div><div class="stat-bar"><div class="stat-fill" style="width:${s.v}%"></div></div>`).join('');
  panel.appendChild(b2);

  const luxC=Math.ceil(lux/25), noxC=Math.ceil(nox/25);
  let traits = [];
  for(let i=0;i<luxC&&i<TRAITS_LUX.length;i++) traits.push(TRAITS_LUX[Math.floor(rand()*TRAITS_LUX.length)]);
  for(let i=0;i<noxC&&i<TRAITS_NOX.length;i++) traits.push(TRAITS_NOX[Math.floor(rand()*TRAITS_NOX.length)]);
  traits.push(TRAITS_NEUTRAL[Math.floor(rand()*TRAITS_NEUTRAL.length)]);
  traits = [...new Set(traits)].slice(0,7);
  const b3 = document.createElement('div'); b3.className = 'dossier-block';
  b3.innerHTML = `<div class="dossier-block-title">Behavioral Markers</div><div class="trait-pills">${traits.map(t=>`<div class="trait-pill">${t}</div>`).join('')}</div>`;
  panel.appendChild(b3);

  const lorePool = lux>60?LORE_LUX:nox>60?LORE_NOX:LORE_MID;
  const lore = pick(lorePool, rand);
  const b4 = document.createElement('div'); b4.className = 'dossier-block';
  b4.innerHTML = `<div class="dossier-block-title">Field Notation</div><div class="lore-text">"${lore.replace(/White Registry|Lux Order|radiance/g,m=>`<strong>${m}</strong>`).replace(/void protocols|Nox|dark contract/g,m=>`<strong>${m}</strong>`)}"</div>`;
  panel.appendChild(b4);
}

// ================================================================
// CUTSCENE ENGINE — FIXED PHASE SCOPING
// ================================================================
function startCutscene() {
  if(cutscenePlaying) return;
  cutscenePlaying = true;
  cutscenePhase = 0; // Reset global phase
  switchScreen('cutscene');
  setTimeout(runCutscene, 600);
}

function switchScreen(to) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const flash = document.getElementById('flashOverlay');
  flash.classList.add('flash');
  setTimeout(() => {
    flash.classList.remove('flash');
    document.getElementById(`screen${to.charAt(0).toUpperCase()+to.slice(1)}`).classList.add('active');
    G.currentScreen = to;
    updateBackBtn();
    updateTicker();
  }, 150);
}

function updateBackBtn() {
  const btn = document.getElementById('backBtn');
  if(['market','ruinbow','delirium','inventory','map','walk','wondrix'].includes(G.currentScreen)) {
    btn.classList.add('show');
    btn.textContent = G.currentScreen === 'map' ? '◁ FORGE' : '◇ MAP';
  } else btn.classList.remove('show');
}

function goBack() {
  const cityScreens = ['market','ruinbow','delirium','inventory','walk','wondrix'];
  if(cityScreens.includes(G.currentScreen)) {
    stopMarketHum(); if(typeof stopRuinbowAtmo === 'function') stopRuinbowAtmo();
    stopDeliriumAmbience(); stopMapAmbience(); stopWondrixAmbience();
    if(wondrixGameId) { cancelAnimationFrame(wondrixGameId); wondrixGameId = null; }
    startMapAmbience();
    switchScreen('map'); updateNavHub('map');
    document.getElementById('mapNulls').textContent = G.nulls;
    setTimeout(updateMapTransform, 50);
  } else if(G.currentScreen === 'map') {
    stopMapAmbience();
    switchScreen('forge');
    document.getElementById('tickerWrap').classList.remove('show');
    document.getElementById('navHub').classList.remove('show');
  }
}

function navTo(dest) {
  if(dest === G.currentScreen) return;
  initAudio(); playClick(660, 0.1);
  if(dest === 'forge') { goBack(); return; }
  // Stop all ambient audio
  stopMarketHum(); if(typeof stopRuinbowAtmo==='function') stopRuinbowAtmo(); stopDeliriumAmbience(); stopMapAmbience(); stopWondrixAmbience();
  if(wondrixGameId) { cancelAnimationFrame(wondrixGameId); wondrixGameId = null; }
  if(dest === 'market') { startMarketHum(); buildMarket(); }
  if(dest === 'ruinbow') { if(typeof startRuinbowAtmo==='function') startRuinbowAtmo(); buildRuinbow(); }
  if(dest === 'delirium') { startDeliriumAmbience(); buildDelirium(); }
  if(dest === 'inventory') { renderInventory(); }
  if(dest === 'walk') { startWalkTheCity(); }
  if(dest === 'wondrix') { startWondrixGame(); }
  if(dest === 'map') { startMapAmbience(); document.getElementById('mapNulls').textContent = G.nulls; setTimeout(updateMapTransform, 50); }
  switchScreen(dest); updateNavHub(dest);
}

function updateNavHub(screen) {
  const hub = document.getElementById('navHub');
  const cityScreens = ['market','ruinbow','delirium','inventory','map','walk','wondrix'];
  if(cityScreens.includes(screen)) {
    hub.classList.add('show');
    hub.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if(screen === 'market') document.getElementById('navMarket').classList.add('active');
    if(screen === 'ruinbow') document.getElementById('navRuinbow').classList.add('active');
    if(screen === 'delirium') document.getElementById('navDelirium').classList.add('active');
    if(screen === 'inventory') document.getElementById('navInventory').classList.add('active');
    if(screen === 'walk') document.getElementById('navWalkBtn').classList.add('active');
  } else { hub.classList.remove('show'); }
}

function updateTicker() {
  const tw = document.getElementById('tickerWrap');
  if(['market','ruinbow','delirium','walk'].includes(G.currentScreen)) {
    tw.classList.add('show');
    const items = G.currentScreen === 'delirium'
      ? ['THE DELIRIUM — SECTOR Ξ','UNLICENSED GOODS AVAILABLE','ALL TRANSACTIONS FINAL · NO REFUNDS','BOLT CUTTERS: RESTRICTED ITEM — HANDLE WITH CARE','DATA CHIPS MAY CONTAIN CLASSIFIED INFORMATION','YOUR PRESENCE HERE HAS NOT BEEN LOGGED. OFFICIALLY.']
      : G.currentScreen === 'ruinbow'
      ? ['RUINBOW SECTOR Ω — UNAUTHORIZED ZONE','EMOTIONAL ORE PRICES RISING IN GREY MARKET','MELANCHOLY SHARD YIELD AT 3-YEAR HIGH','ORDER PATROL UNITS STATIONED AT SECTOR BOUNDARY','DISTILLATION WITHOUT LICENSE IS ERASURE-ELIGIBLE','YOUR FEELINGS ARE CURRENCY. SPEND WISELY.','UNVERIFIED NULLS CANNOT BE TRACED. THEORETICALLY.']
      : ['SMILEMORE WELCOMES COMPLIANT CITIZENS','NOX COALITION RAISES EMOTION TAX 12%','SYNTHETIC JOY SHORTAGE IN SECTORS 4–7','MOODSWING™ MK.V IN DEVELOPMENT','NULL EXCHANGE RATE: 1 NUL = 0.002 COGNITIVE UNITS','SMILEMORE: WHERE HAPPINESS IS MANDATORY','REMEMBER: UNAUTHORIZED FEELING IS A CRIME','MOODSWING™ — FEEL WHAT YOU ARE PERMITTED TO FEEL'];
    const inner = document.getElementById('tickerInner');
    inner.innerHTML = (items.concat(items)).map((t,i)=>`<span class="ticker-item${i%4===1?' accent':''}">${t}</span><span class="ticker-sep">·</span>`).join('');
  } else { tw.classList.remove('show'); }
}

// ================================================================
// CUTSCENE ANIMATION — uses global cutscenePhase
// ================================================================
function runCutscene() {
  const canvas = document.getElementById('cutsceneCanvas');
  const rain = document.getElementById('rainCanvas');
  const ctx = canvas.getContext('2d');
  const rctx = rain.getContext('2d');

  const resize = () => {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    rain.width = window.innerWidth; rain.height = window.innerHeight;
  };
  resize();

  setTimeout(() => {
    document.getElementById('ltTop').classList.add('expand');
    document.getElementById('ltBot').classList.add('expand');
  }, 200);

  const drops = Array.from({length:200}, () => ({
    x: Math.random()*canvas.width, y: Math.random()*canvas.height,
    speed: 8+Math.random()*12, length: 12+Math.random()*20, opacity: 0.1+Math.random()*0.3
  }));

  const W = canvas.width, H = canvas.height;
  const buildings = [];
  for(let x=0; x<W+200; x+=Math.floor(40+Math.random()*60)) {
    buildings.push({
      x, width: 35+Math.random()*55,
      height: H*0.3+Math.random()*H*0.45,
      windows: Array.from({length:Math.floor(Math.random()*20+5)}, ()=>({
        x: Math.random(), y: Math.random(), lit: Math.random()>0.65
      }))
    });
  }

  const charW = 60, charH = 130;
  let charX = -charW - 20;
  const charTargetX = W * 0.42;
  let frameCount = 0;
  let walkCycle = 0;
  let cameraX = 0;
  let fog = 0;

  const isLuxBase = G.lux >= 50;
  const charAccent = '#c8b89a';

  const subs = [
    {frame:80,  text:'The city does not sleep. It never did.', dur:110},
    {frame:200, text:'It simply forgot how.', dur:90},
    {frame:330, text:'Where happiness is mandatory.', dur:120},
    {frame:460, text:'Where every emotion is licensed, tracked, taxed.', dur:130},
    {frame:610, text:'The Town Hall opens its doors.', dur:150},
  ];
  let subIdx = 0;

  function drawSub(text) {
    document.getElementById('subtitleText').textContent = text;
    document.getElementById('subtitleText').classList.add('show');
  }
  function hideSub() {
    document.getElementById('subtitleText').classList.remove('show');
  }

  function drawBuilding(ctx, b, camX, alpha) {
    const bx = b.x - camX;
    if(bx > W+100 || bx+b.width < -10) return;
    const by = H - b.height;
    const grad = ctx.createLinearGradient(bx, by, bx+b.width, H);
    grad.addColorStop(0, `rgba(22,22,22,${alpha})`);
    grad.addColorStop(1, `rgba(8,8,8,${alpha})`);
    ctx.fillStyle = grad;
    ctx.fillRect(bx, by, b.width, b.height);
    ctx.fillStyle = `rgba(50,50,50,${alpha*0.6})`;
    ctx.fillRect(bx, by, 2, b.height);
    const winW = 5, winH = 7;
    b.windows.forEach(w => {
      const wx = bx + w.x * (b.width - winW - 4) + 2;
      const wy = by + w.y * (b.height - winH - 4) + 2;
      if(wy < H - 10) {
        ctx.fillStyle = w.lit ? `rgba(200,180,140,${0.6*alpha})` : `rgba(15,15,15,${alpha})`;
        ctx.fillRect(wx, wy, winW, winH);
        if(w.lit) { ctx.fillStyle = `rgba(200,180,140,${0.1*alpha})`; ctx.fillRect(wx-2, wy-2, winW+4, winH+4); }
      }
    });
    ctx.fillStyle = `rgba(35,35,35,${alpha})`;
    ctx.fillRect(bx+5, by, b.width-10, 4);
  }

  function drawGround(ctx) {
    const sg = ctx.createLinearGradient(0, H*0.72, 0, H);
    sg.addColorStop(0, 'rgba(10,10,10,0.9)'); sg.addColorStop(1, 'rgba(15,15,15,1)');
    ctx.fillStyle = sg; ctx.fillRect(0, H*0.72, W, H*0.28);
    const rg = ctx.createRadialGradient(W*0.42, H, 0, W*0.42, H, W*0.3);
    rg.addColorStop(0, 'rgba(200,184,154,0.06)'); rg.addColorStop(1, 'transparent');
    ctx.fillStyle = rg; ctx.fillRect(0, H*0.72, W, H*0.28);
    ctx.strokeStyle = 'rgba(60,60,60,0.6)'; ctx.lineWidth = 1;
    ctx.setLineDash([20,30]); ctx.beginPath(); ctx.moveTo(0, H*0.73); ctx.lineTo(W, H*0.73); ctx.stroke(); ctx.setLineDash([]);
  }

  function drawLampPost(ctx, x, camX) {
    const lx = x - camX; if(lx < -20 || lx > W+20) return;
    const base = H*0.72;
    ctx.strokeStyle = 'rgba(80,80,80,0.8)'; ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(lx, base); ctx.lineTo(lx, base-120); ctx.lineTo(lx+20, base-125); ctx.stroke();
    const lg = ctx.createRadialGradient(lx+20, base-130, 0, lx+20, base-130, 70);
    lg.addColorStop(0, 'rgba(200,180,140,0.18)'); lg.addColorStop(1, 'transparent');
    ctx.fillStyle = lg; ctx.fillRect(lx-50, base-210, 140, 160);
    ctx.fillStyle = 'rgba(200,180,140,0.9)';
    ctx.beginPath(); ctx.arc(lx+20, base-130, 5, 0, Math.PI*2); ctx.fill();
  }

  function drawCharSilhouette(ctx, x, y, walkT, lux) {
    const isLux = lux >= 50;
    const isFem = G.gender === 'female';
    const cl = isLux ? '#d8d4cc' : '#1e1e1e';
    const cd = isLux ? '#0a0a0a' : '#dddad2';
    const ca = '#c8b89a';
    const leg = Math.sin(walkT*0.18)*12;

    ctx.save(); ctx.translate(x, y);
    ctx.fillStyle = 'rgba(0,0,0,0.35)';
    ctx.beginPath(); ctx.ellipse(0, 126, 22, 5, 0, 0, Math.PI*2); ctx.fill();

    // Body
    const cg = ctx.createLinearGradient(-26, -10, 26, 120);
    cg.addColorStop(0, cl); cg.addColorStop(1, isLux ? '#b0ada6' : '#111');
    ctx.fillStyle = cg;
    ctx.beginPath();
    if (isFem) {
      ctx.moveTo(-22, 10); ctx.quadraticCurveTo(-28, 45, -30+leg*0.3, 128);
      ctx.lineTo(30-leg*0.3, 128); ctx.quadraticCurveTo(28, 45, 22, 10); ctx.closePath();
    } else {
      ctx.moveTo(-26, 10); ctx.quadraticCurveTo(-32, 50, -28+leg*0.3, 128);
      ctx.lineTo(28-leg*0.3, 128); ctx.quadraticCurveTo(32, 50, 26, 10); ctx.closePath();
    }
    ctx.fill();

    // Nanofiber pattern lines
    ctx.strokeStyle = `${isLux ? 'rgba(0,0,0,0.12)' : 'rgba(255,255,255,0.06)'}`;
    ctx.lineWidth = 1; ctx.setLineDash([4,6]);
    for(let i=0;i<3;i++) { ctx.beginPath(); ctx.moveTo(-22+i*12,15); ctx.lineTo(-20+i*11,125); ctx.stroke(); }
    ctx.setLineDash([]);

    // Legs
    ctx.fillStyle = cd;
    ctx.fillRect(-14+leg*0.4, 100, 12, 30);
    ctx.fillRect(2-leg*0.4, 100, 12, 30);

    // Head
    const hg = ctx.createRadialGradient(-6, -44, 0, 0, -40, 24);
    hg.addColorStop(0, cl); hg.addColorStop(1, isLux ? '#b5b2aa' : '#181818');
    ctx.fillStyle = hg; ctx.beginPath();
    ctx.ellipse(0, -40, 18, 22, 0, 0, Math.PI*2); ctx.fill();

    // Mask on walking character
    ctx.fillStyle = cl;
    ctx.beginPath(); ctx.ellipse(0, -35, 16, 14, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = `rgba(${isLux?'0,0,0':'240,237,230'},0.15)`;
    ctx.fillRect(-14, -47, 28, 12);
    ctx.fillStyle = isLux ? 'rgba(200,184,154,0.9)' : 'rgba(200,184,154,0.7)';
    ctx.fillRect(-9, -42, 4, 3); ctx.fillRect(4, -42, 4, 3);

    // Collar
    ctx.fillStyle = ca; ctx.globalAlpha = 0.6;
    ctx.fillRect(-18, -10, 36, 8); ctx.globalAlpha = 1;

    // Arms
    ctx.fillStyle = isLux ? '#c0bdb5' : '#222';
    ctx.save(); ctx.translate(-24, 20); ctx.rotate(-leg*0.01);
    ctx.fillRect(0, 0, 8, 40); ctx.restore();
    ctx.save(); ctx.translate(18, 20); ctx.rotate(leg*0.01);
    ctx.fillRect(0, 0, 8, 40); ctx.restore();

    ctx.restore();
  }

  function drawWelcomeArch(ctx, x, camX) {
    const ax = x - camX; if(ax < -200 || ax > W+200) return;
    const ay = H*0.72;
    // Posts
    ctx.fillStyle = 'rgba(40,38,34,0.9)'; ctx.fillRect(ax-65, ay-180, 6, 180); ctx.fillRect(ax+59, ay-180, 6, 180);
    // Arch bar
    ctx.fillStyle = 'rgba(50,48,42,0.9)'; ctx.fillRect(ax-65, ay-184, 130, 8);
    // Sign
    ctx.fillStyle = 'rgba(8,8,6,0.95)'; ctx.fillRect(ax-55, ay-170, 110, 40);
    ctx.strokeStyle = 'rgba(200,184,154,0.3)'; ctx.lineWidth = 1; ctx.strokeRect(ax-55, ay-170, 110, 40);
    ctx.textAlign = 'center'; ctx.font = 'bold 11px "Cinzel", serif';
    ctx.fillStyle = 'rgba(200,184,154,0.65)'; ctx.fillText('WELCOME TO', ax, ay-155);
    ctx.font = 'bold 16px "Cinzel", serif';
    ctx.fillStyle = 'rgba(240,237,230,0.8)'; ctx.fillText('SMILEMORE', ax, ay-139);
    ctx.textAlign = 'left';
  }

  function drawTownHall(ctx, x, camX) {
    const dx = x - camX; if(dx < -150 || dx > W+150) return;
    const dy = H*0.72 - 260; const dw = 200, dh = 260;
    // Building
    const bg = ctx.createLinearGradient(dx, dy, dx+dw, dy+dh);
    bg.addColorStop(0, 'rgba(18,18,16,0.97)'); bg.addColorStop(1, 'rgba(8,8,6,0.99)');
    ctx.fillStyle = bg; ctx.fillRect(dx, dy+30, dw, dh-30);
    // Triangular roof
    ctx.fillStyle = 'rgba(25,24,20,0.95)';
    ctx.beginPath(); ctx.moveTo(dx-10, dy+30); ctx.lineTo(dx+dw/2, dy); ctx.lineTo(dx+dw+10, dy+30); ctx.closePath(); ctx.fill();
    ctx.strokeStyle = 'rgba(200,184,154,0.2)'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(dx-10, dy+30); ctx.lineTo(dx+dw/2, dy); ctx.lineTo(dx+dw+10, dy+30); ctx.stroke();
    // Columns
    for(let i=0;i<4;i++) { const cx=dx+30+i*48; ctx.fillStyle='rgba(35,34,30,0.9)'; ctx.fillRect(cx,dy+40,8,dh-70); ctx.strokeStyle='rgba(200,184,154,0.1)'; ctx.strokeRect(cx,dy+40,8,dh-70); }
    // Door
    ctx.fillStyle = 'rgba(5,5,3,0.95)'; ctx.fillRect(dx+70, dy+dh-100, 60, 100);
    ctx.strokeStyle = 'rgba(200,184,154,0.35)'; ctx.lineWidth = 1.5; ctx.strokeRect(dx+70, dy+dh-100, 60, 100);
    // Door glow
    const gg = ctx.createRadialGradient(dx+100, dy+dh-50, 5, dx+100, dy+dh-50, 80);
    gg.addColorStop(0, 'rgba(200,184,154,0.12)'); gg.addColorStop(1, 'transparent');
    ctx.fillStyle = gg; ctx.fillRect(dx+20, dy+dh-130, 160, 160);
    // Label
    ctx.textAlign = 'center'; ctx.font = '8px "Share Tech Mono"';
    ctx.fillStyle = 'rgba(200,184,154,0.4)'; ctx.fillText('TOWN HALL', dx+dw/2, dy+25);
    ctx.font = '7px "Share Tech Mono"';
    ctx.fillStyle = 'rgba(200,184,154,0.2)'; ctx.fillText('NAVIGATION CENTER', dx+dw/2, dy+dh+16);
    ctx.textAlign = 'left';
    // Windows
    for(let r=0;r<3;r++) for(let c=0;c<3;c++) { if(c===1&&r>0)continue; const wx=dx+25+c*65,wy=dy+50+r*55; ctx.fillStyle=`rgba(200,180,140,${0.15+Math.sin(frameCount*0.02+r+c)*0.1})`; ctx.fillRect(wx,wy,16,20); }
  }

  function drawBillboard(ctx, x, camX) {
    const bx = x - camX; if(bx < -320 || bx > W+320) return;
    const by = H * 0.72 - 340; const bw = 280, bh = 110;
    ctx.fillStyle = 'rgba(55,55,55,0.9)'; ctx.fillRect(bx + bw/2 - 5, by + bh, 10, 230); ctx.fillRect(bx + bw*0.3 - 4, by + bh, 8, 230);
    ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fillRect(bx + 5, by + 5, bw, bh);
    const bbg = ctx.createLinearGradient(bx, by, bx+bw, by+bh);
    bbg.addColorStop(0, 'rgba(6,6,6,0.98)'); bbg.addColorStop(1, 'rgba(14,13,10,0.98)');
    ctx.fillStyle = bbg; ctx.fillRect(bx, by, bw, bh);
    ctx.strokeStyle = 'rgba(200,184,154,0.55)'; ctx.lineWidth = 2; ctx.strokeRect(bx, by, bw, bh);
    ctx.strokeStyle = 'rgba(200,184,154,0.2)'; ctx.lineWidth = 1; ctx.strokeRect(bx + 6, by + 6, bw - 12, bh - 12);
    ctx.textAlign = 'center';
    ctx.font = 'bold 42px "Cinzel", serif'; ctx.fillStyle = 'rgba(240,237,230,0.92)'; ctx.fillText('SMILEMORE', bx + bw/2, by + 56);
    ctx.font = '11px "Share Tech Mono"'; ctx.fillStyle = 'rgba(200,184,154,0.75)'; ctx.fillText('WHERE HAPPINESS IS MANDATORY', bx + bw/2, by + 78);
    ctx.font = 'bold 18px "Cinzel"'; ctx.fillStyle = 'rgba(200,184,154,0.4)'; ctx.fillText('Ø', bx + 22, by + 30); ctx.fillText('Ø', bx + bw - 22, by + 30);
    ctx.fillStyle = 'rgba(200,184,154,0.08)'; ctx.fillRect(bx, by, bw, 18);
    ctx.font = '8px "Share Tech Mono"'; ctx.fillStyle = 'rgba(200,184,154,0.5)'; ctx.fillText('OFFICIAL AFFECT DISTRIBUTION PARTNER · SECTOR 9', bx + bw/2, by + 12);
    ctx.textAlign = 'left';
  }

  function drawFog(ctx, amount) {
    if(amount <= 0) return;
    const fg = ctx.createLinearGradient(0, 0, 0, H);
    fg.addColorStop(0, `rgba(10,10,10,${amount*0.5})`);
    fg.addColorStop(0.5, `rgba(10,10,10,${amount*0.2})`);
    fg.addColorStop(1, `rgba(5,5,5,${amount*0.1})`);
    ctx.fillStyle = fg; ctx.fillRect(0, 0, W, H);
  }

  const doorWorldX = W * 0.65 + 200;
  const billboardWorldX = doorWorldX - W * 0.38;
  const lampPosts = [W*0.15, W*0.35, W*0.55, W*0.75, W*0.95, W*1.15];

  let animId;
  function animate() {
    animId = requestAnimationFrame(animate);
    frameCount++;
    walkCycle++;

    rctx.clearRect(0, 0, rain.width, rain.height);
    drops.forEach(d => {
      d.y += d.speed;
      if(d.y > rain.height) { d.y = -d.length; d.x = Math.random()*rain.width; }
      rctx.strokeStyle = `rgba(180,180,180,${d.opacity})`; rctx.lineWidth = 0.7;
      rctx.beginPath(); rctx.moveTo(d.x, d.y); rctx.lineTo(d.x+2, d.y+d.length); rctx.stroke();
    });

    ctx.fillStyle = 'rgba(6,6,6,0.98)'; ctx.fillRect(0,0,W,H);
    const sky = ctx.createLinearGradient(0,0,0,H*0.7);
    sky.addColorStop(0,'rgba(4,4,4,1)'); sky.addColorStop(1,'rgba(16,14,12,1)');
    ctx.fillStyle = sky; ctx.fillRect(0,0,W,H*0.7);

    buildings.forEach(b => drawBuilding(ctx, {...b, height: b.height*0.6}, cameraX*0.25, 0.45));
    buildings.forEach(b => drawBuilding(ctx, b, cameraX*0.65, 0.85));
    lampPosts.forEach(lx => drawLampPost(ctx, lx, cameraX));
    drawGround(ctx);
    drawFog(ctx, fog);
    // Billboard removed — welcome arch only

    // PHASE LOGIC — uses global cutscenePhase
    if(cutscenePhase === 0) {
      charX = Math.min(charX + 2.5, charTargetX);
      if(charX >= charTargetX - 1) {
        cutscenePhase = 1;
        setTimeout(() => {
          const tc = document.getElementById('titleCard');
          tc.classList.add('show');
          setTimeout(() => {
            tc.classList.remove('show');
            cutscenePhase = 2;
            startFootsteps();
          }, 2800);
        }, 200);
      }
    } else if(cutscenePhase === 2) {
      const doorScreenX = doorWorldX - cameraX;
      charX = W * 0.42;
      const targetCam = doorWorldX - W * 0.52;
      cameraX += (targetCam - cameraX) * 0.018;

      if(doorScreenX < W * 0.68 && doorScreenX > W * 0.55) {
        cutscenePhase = 3;
        fog = 0;
        let fogInc = setInterval(() => {
          fog = Math.min(fog+0.04, 1);
          if(fog>=1) {
            clearInterval(fogInc);
            enterCityMap(cancelAnimation);
          }
        }, 30);
      }
    }

    const charScreenX = G.currentScreen === 'cutscene' ? charX : charTargetX;
    drawCharSilhouette(ctx, charScreenX, H*0.72 - 10, walkCycle, G.lux);
    drawWelcomeArch(ctx, billboardWorldX + 320, cameraX);
    drawTownHall(ctx, doorWorldX, cameraX);

    if(subIdx < subs.length && frameCount === subs[subIdx].frame) {
      drawSub(subs[subIdx].text);
      const idx = subIdx;
      setTimeout(() => { if(subIdx===idx) hideSub(); subIdx++; }, subs[idx].dur * 16);
    }
  }

  function cancelAnimation() { cancelAnimationFrame(animId); }
  animate();
}

// ================================================================
// JUNCTION CHOICE — FIXED: now sets global cutscenePhase
// ================================================================
function chooseDestination(dest) {
  G.junctionDest = dest;
  initAudio();
  playClick(dest === 'ruinbow' ? 300 : 520, 0.15);

  if(AC) {
    const now = AC.currentTime;
    const nb = createNoiseBuffer(1.2, 'pink');
    const src = AC.createBufferSource(); src.buffer = nb;
    const g = AC.createGain();
    g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.22, now+0.4); g.gain.exponentialRampToValueAtTime(0.001, now+1.2);
    const lpf = AC.createBiquadFilter(); lpf.type = 'lowpass'; lpf.frequency.value = dest==='ruinbow' ? 600 : 1200;
    src.connect(lpf); lpf.connect(g); g.connect(sfxGain); src.start(now); src.stop(now+1.3);
  }

  document.getElementById('junctionOverlay').classList.remove('show');
  setTimeout(() => {
    startFootsteps();
    cutscenePhase = 2; // NOW CORRECTLY SETS GLOBAL PHASE
  }, 600);
}

// WONDRIX — Restricted access handler
let wondrixAttempts = 0;
function wondrixAccess() {
  wondrixAttempts++;
  initAudio();
  
  // Hostile warning sound
  if (AC) {
    const now = AC.currentTime;
    // Low warning tone
    const osc = AC.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = 55;
    const g = AC.createGain(); g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.08, now+0.1);
    g.gain.exponentialRampToValueAtTime(0.001, now+1.5);
    osc.connect(g); g.connect(sfxGain); osc.start(now); osc.stop(now+1.5);
    // High dissonant ping
    const osc2 = AC.createOscillator(); osc2.type = 'sine'; osc2.frequency.value = 1320;
    const g2 = AC.createGain(); g2.gain.setValueAtTime(0.06, now+0.15); g2.gain.exponentialRampToValueAtTime(0.001, now+0.6);
    osc2.connect(g2); g2.connect(sfxGain); osc2.start(now+0.15); osc2.stop(now+0.7);
  }

  const msgs = [
    ['⚠ ACCESS DENIED', 'Clearance Level 9 required. Your attempt has been logged.'],
    ['⚠ SYSTEM WARNING', 'Repeated access attempts detected. Subject flagged for review.'],
    ['⚠ AUTHORITY ALERT', 'Central monitoring engaged. Behavioral profile updated.'],
    ['⚠ FINAL WARNING', 'Further attempts will result in permanent record modification.'],
    ['⚠ ...', 'We see you. We have always seen you.'],
  ];
  const idx = Math.min(wondrixAttempts - 1, msgs.length - 1);
  showToast(msgs[idx][0], msgs[idx][1], true);
  
  // Screen shake on repeated attempts
  if (wondrixAttempts >= 3) {
    const el = document.getElementById('junctionOverlay');
    if (el) { el.style.animation = 'none'; el.offsetHeight; el.style.animation = 'screenShake 0.3s ease'; }
  }
}

function enterMarket(cancelFn) {
  if(cancelFn) cancelFn();
  cutscenePlaying = false;
  buildMarket();
  switchScreen('market');
}

function enterRuinbow(cancelFn) {
  if(cancelFn) cancelFn();
  cutscenePlaying = false;
  buildRuinbow();
  switchScreen('ruinbow');
  updateNavHub('ruinbow');
  setTimeout(() => { if(AC) startRuinbowAtmo(); }, 600);
}

// ================================================================
// MARKETPLACE
// ================================================================
// Duration in seconds for game pacing (real durations would be hours)
const EMOTIONS = [
  {tier:1, id:'calm', name:'CALM', latin:'Serenitas Artificialis', rarity:'common', price:12, timerSec:45, saturation:15, desc:'A measured, flat affect. Tension dissipates. The world becomes manageable. Mildly sedating.', stats:[{l:'Clarity',v:72},{l:'Stability',v:85},{l:'Depth',v:22}], hue:200, sound:{freq:220, type:'sine', dur:1.5}},
  {tier:1, id:'focus', name:'FOCUS', latin:'Mens Acuta', rarity:'common', price:18, timerSec:35, saturation:18, desc:'Tunneled concentration. Background noise dims. Productivity quantified and optimized.', stats:[{l:'Clarity',v:90},{l:'Stability',v:68},{l:'Depth',v:35}], hue:180, sound:{freq:330, type:'triangle', dur:1.0}},
  {tier:1, id:'content', name:'CONTENTMENT', latin:'Sufficientia', rarity:'common', price:10, timerSec:55, saturation:12, desc:'Low-grade satisfaction. Neither joy nor grief. The acceptable baseline. Most prescribed.', stats:[{l:'Clarity',v:55},{l:'Stability',v:92},{l:'Depth',v:18}], hue:120, sound:{freq:262, type:'sine', dur:2.0}},
  {tier:1, id:'courage', name:'COURAGE', latin:'Fortitudo Simplex', rarity:'uncommon', price:28, timerSec:30, saturation:22, desc:'Adrenaline-adjacent. Fear suppressed, not eliminated. Recommended for gate crossings only.', stats:[{l:'Clarity',v:60},{l:'Stability',v:45},{l:'Depth',v:55}], hue:30, sound:{freq:392, type:'sawtooth', dur:0.8}},
  {tier:2, id:'wonder', name:'WONDER', latin:'Admiratio Profunda', rarity:'rare', price:65, timerSec:25, saturation:35, desc:'Genuine awe. The world appears vast and strange. Not habit-forming in licensed doses.', stats:[{l:'Clarity',v:40},{l:'Stability',v:38},{l:'Depth',v:88}], hue:270, sound:{freq:523, type:'sine', dur:2.5}},
  {tier:2, id:'hope', name:'HOPE', latin:'Spes Restituta', rarity:'rare', price:80, timerSec:30, saturation:30, desc:'Forward-orientation. Belief that tomorrow holds weight. Reported to cause unauthorized planning.', stats:[{l:'Clarity',v:52},{l:'Stability',v:60},{l:'Depth',v:78}], hue:50, sound:{freq:440, type:'triangle', dur:2.0}},
  {tier:2, id:'pride', name:'PRIDE', latin:'Dignitas Injecta', rarity:'uncommon', price:44, timerSec:35, saturation:25, desc:'Self-regard above baseline. Posture improves. Eye contact increases. Monitored for excess.', stats:[{l:'Clarity',v:75},{l:'Stability',v:50},{l:'Depth',v:65}], hue:45, sound:{freq:349, type:'square', dur:1.2}},
  {tier:2, id:'longing', name:'LONGING', latin:'Desiderium Vetitum', rarity:'rare', price:95, timerSec:20, saturation:32, desc:'Directed nostalgia for unspecified loss. Popular and restricted. Causes unpredictable behavior.', stats:[{l:'Clarity',v:22},{l:'Stability',v:20},{l:'Depth',v:96}], hue:300, sound:{freq:196, type:'sine', dur:3.0}},
  {tier:3, id:'grief', name:'GRIEF', latin:'Luctus Prohibitus', rarity:'contraband', price:200, timerSec:40, saturation:45, desc:'Raw mourning. Unquantifiable. The Order classifies it as a social contagion.', stats:[{l:'Clarity',v:5},{l:'Stability',v:4},{l:'Depth',v:100}], hue:240, sound:{freq:147, type:'sawtooth', dur:3.5}},
  {tier:3, id:'love', name:'LOVE', latin:'Amor Absolutus', rarity:'contraband', price:350, timerSec:50, saturation:50, desc:'Total bond formation. Generates loyalty beyond contractual parameters. The most dangerous affect.', stats:[{l:'Clarity',v:30},{l:'Stability',v:10},{l:'Depth',v:100}], hue:340, sound:{freq:523, type:'sine', dur:4.0}},
  {tier:3, id:'rage', name:'RAGE', latin:'Furor Purus', rarity:'contraband', price:175, timerSec:18, saturation:48, desc:'Unfiltered fury. No sedative analogue exists. Classified: Maximum Threat.', stats:[{l:'Clarity',v:8},{l:'Stability',v:2},{l:'Depth',v:98}], hue:0, sound:{freq:82, type:'sawtooth', dur:2.0}},
];

let purchases = {};
let activeInjections = []; // {emotion, remaining, timerId}
let worldSaturation = 0;
let isOverloaded = false;
let saturationTickId = null;

function buildMarket() {
  ['tier1Grid','tier2Grid','tier3Grid'].forEach(id => document.getElementById(id).innerHTML = '');
  EMOTIONS.forEach(e => renderEmotionCard(e));
  updateBracelet();
  updateSaturation();
  // Start global tick
  clearInterval(saturationTickId);
  saturationTickId = setInterval(emotionTick, 1000);
}

function renderEmotionCard(e) {
  const grid = document.getElementById(`tier${e.tier}Grid`);
  const isPurchased = purchases[e.id];
  const isActive = activeInjections.some(a => a.emotion.id === e.id);
  const rarityClass = e.rarity === 'contraband' ? 'rarity-contraband' : e.rarity === 'rare' ? 'rarity-rare' : e.rarity === 'uncommon' ? 'rarity-uncommon' : 'rarity-common';
  const card = document.createElement('div');
  card.className = `emotion-card${isPurchased ? ' purchased' : ''}${isActive ? ' active-injection' : ''}`;
  card.id = `card-${e.id}`;
  
  const activeEntry = activeInjections.find(a => a.emotion.id === e.id);
  const timerHTML = activeEntry ? `<div class="inject-timer-badge${activeEntry.remaining <= 8 ? ' expiring' : ''}" id="timer-${e.id}">${activeEntry.remaining}s</div>` : '';
  
  const btnLabel = isActive ? `${activeEntry.remaining}s LEFT` : isPurchased ? 'INJECT' : 'ACQUIRE';
  const btnClass = isActive ? 'buy-btn injecting' : 'buy-btn';
  const durationLabel = e.timerSec + 's';
  
  card.innerHTML = `${timerHTML}<div class="emotion-rarity ${rarityClass}"><div class="rarity-dot ${e.rarity}"></div>${e.rarity === 'contraband' ? '⚠ CONTRABAND' : e.rarity.toUpperCase()}</div><div class="emotion-name">${e.name}</div><div class="emotion-latin">${e.latin}</div><div class="emotion-desc">${e.desc}</div><div class="emotion-stats">${e.stats.map(s => `<div class="emotion-stat"><div class="emotion-stat-label">${s.l}</div><div class="emotion-stat-bar"><div class="emotion-stat-fill" style="width:${s.v}%"></div></div></div>`).join('')}</div><div class="emotion-footer"><div><div class="emotion-price"><span class="price-null">Ø</span><span class="price-amount">${e.price}</span></div><div class="duration-badge">${durationLabel}</div></div><button class="${btnClass}" onclick="handleBuy('${e.id}')" ${isActive ? 'disabled' : ''}>${btnLabel}</button></div>`;
  grid.appendChild(card);
}

function handleBuy(id) {
  const e = EMOTIONS.find(x => x.id === id); if (!e) return;
  // Check if already active
  if (activeInjections.some(a => a.emotion.id === id)) {
    showToast('ALREADY ACTIVE', `${e.name} is currently in your system`, true);
    return;
  }
  if (!purchases[e.id]) {
    if (G.nulls < e.price) { showToast('INSUFFICIENT FUNDS', `Requires Ø ${e.price} — Current: Ø ${G.nulls}`, true); return; }
    G.nulls -= e.price; purchases[e.id] = true;
    addToInventory('emotion', {id: e.id, name: e.name});
    document.getElementById('nullBalance').textContent = G.nulls;
    syncNullDisplays();
    showToast(`${e.name} ACQUIRED`, `Ø ${e.price} deducted · Injecting...`, false);
  }
  injectEmotion(e);
}

// Injection sound FX
function playInjectSound(e) {
  if (!AC) return;
  const now = AC.currentTime;
  // Layer 1: main tone
  const osc = AC.createOscillator();
  osc.type = e.sound.type;
  osc.frequency.value = e.sound.freq;
  const g = AC.createGain();
  g.gain.setValueAtTime(0, now);
  g.gain.linearRampToValueAtTime(0.12, now + 0.05);
  g.gain.exponentialRampToValueAtTime(0.001, now + e.sound.dur);
  const lpf = AC.createBiquadFilter();
  lpf.type = 'lowpass';
  lpf.frequency.value = 2000;
  osc.connect(lpf); lpf.connect(g); g.connect(masterGain || AC.destination);
  osc.start(now); osc.stop(now + e.sound.dur);
  
  // Layer 2: sub rumble
  const sub = AC.createOscillator();
  sub.type = 'sine';
  sub.frequency.value = e.sound.freq * 0.25;
  const sg = AC.createGain();
  sg.gain.setValueAtTime(0, now);
  sg.gain.linearRampToValueAtTime(0.06, now + 0.08);
  sg.gain.exponentialRampToValueAtTime(0.001, now + e.sound.dur * 0.7);
  sub.connect(sg); sg.connect(masterGain || AC.destination);
  sub.start(now); sub.stop(now + e.sound.dur);
  
  // Layer 3: shimmer
  const shim = AC.createOscillator();
  shim.type = 'sine';
  shim.frequency.value = e.sound.freq * 2.02;
  const shimG = AC.createGain();
  shimG.gain.setValueAtTime(0, now);
  shimG.gain.linearRampToValueAtTime(0.03, now + 0.15);
  shimG.gain.exponentialRampToValueAtTime(0.001, now + e.sound.dur * 1.2);
  shim.connect(shimG); shimG.connect(masterGain || AC.destination);
  shim.start(now); shim.stop(now + e.sound.dur * 1.2);
}

// Overload noise burst
function playOverloadNoise() {
  if (!AC) return;
  const now = AC.currentTime;
  const bufSize = AC.sampleRate * 0.3;
  const buf = AC.createBuffer(1, bufSize, AC.sampleRate);
  const data = buf.getChannelData(0);
  for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * 0.5;
  const src = AC.createBufferSource();
  src.buffer = buf;
  const g = AC.createGain();
  g.gain.setValueAtTime(0.08, now);
  g.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
  const bp = AC.createBiquadFilter();
  bp.type = 'bandpass'; bp.frequency.value = 800; bp.Q.value = 2;
  src.connect(bp); bp.connect(g); g.connect(masterGain || AC.destination);
  src.start(now); src.stop(now + 0.3);
}

function injectEmotion(e) {
  initAudio();
  
  // Add to active injections
  activeInjections.push({
    emotion: e,
    remaining: e.timerSec,
    startTime: Date.now()
  });
  
  // Play injection sound
  playInjectSound(e);
  
  // Update card
  const card = document.getElementById(`card-${e.id}`);
  if (card) {
    card.classList.add('active-injection');
    const btn = card.querySelector('.buy-btn');
    if (btn) { btn.textContent = e.timerSec + 's LEFT'; btn.className = 'buy-btn injecting'; btn.disabled = true; }
    // Add timer badge
    const badge = document.createElement('div');
    badge.className = 'inject-timer-badge';
    badge.id = `timer-${e.id}`;
    badge.textContent = e.timerSec + 's';
    card.appendChild(badge);
  }
  
  // Recalculate saturation
  recalcSaturation();
  updateBracelet();
  checkOverload();
  
  showToast(`INJECTING: ${e.name}`, `Synthetic ${e.latin} entering bloodstream · ${e.timerSec}s`, false);
}

function emotionTick() {
  if (G.currentScreen !== 'market') return;
  
  let changed = false;
  activeInjections.forEach(a => {
    a.remaining--;
    // Update timer badge
    const badge = document.getElementById(`timer-${a.emotion.id}`);
    if (badge) {
      badge.textContent = a.remaining + 's';
      if (a.remaining <= 8) badge.classList.add('expiring');
    }
    // Update card button
    const card = document.getElementById(`card-${a.emotion.id}`);
    if (card) {
      const btn = card.querySelector('.buy-btn');
      if (btn) btn.textContent = a.remaining + 's LEFT';
    }
  });
  
  // Remove expired
  const expired = activeInjections.filter(a => a.remaining <= 0);
  expired.forEach(a => {
    const card = document.getElementById(`card-${a.emotion.id}`);
    if (card) {
      card.classList.remove('active-injection');
      const btn = card.querySelector('.buy-btn');
      if (btn) { btn.textContent = 'INJECT'; btn.className = 'buy-btn'; btn.disabled = false; }
      const badge = document.getElementById(`timer-${a.emotion.id}`);
      if (badge) badge.remove();
    }
    showToast(`${a.emotion.name} EXPIRED`, 'Affect depleted — saturation fading', true);
    changed = true;
  });
  
  activeInjections = activeInjections.filter(a => a.remaining > 0);
  
  if (changed || activeInjections.length > 0) {
    recalcSaturation();
    updateBracelet();
    checkOverload();
  }
  
  // Gradual drain when no emotions active
  if (activeInjections.length === 0 && worldSaturation > 0) {
    worldSaturation = Math.max(0, worldSaturation - 1.5);
    updateSaturation();
  }
}

function recalcSaturation() {
  let target = 0;
  activeInjections.forEach(a => {
    const pct = a.remaining / a.emotion.timerSec;
    target += a.emotion.saturation * pct;
  });
  worldSaturation = Math.min(100, target);
  updateSaturation();
}

function updateSaturation() {
  const inner = document.querySelector('#screenMarket .market-inner');
  if (!inner) return;
  const gray = Math.max(0, 100 - worldSaturation);
  inner.style.filter = `grayscale(${gray}%)`;
  inner.style.transition = 'filter 1.5s ease';
  
  // Update intensity display
  const pctEl = document.getElementById('intensityPct');
  if (pctEl) pctEl.textContent = Math.round(worldSaturation);
}

function checkOverload() {
  const wasOverloaded = isOverloaded;
  isOverloaded = activeInjections.length >= 3;
  
  const glitch = document.getElementById('overloadGlitch');
  const bracelet = document.getElementById('braceletBar');
  
  if (isOverloaded && !wasOverloaded) {
    if (glitch) glitch.classList.add('active');
    if (bracelet) bracelet.classList.add('overloaded');
    playOverloadNoise();
    showToast('⚠ SYSTEM OVERLOAD', 'Too many simultaneous injections — proxy destabilizing', true);
  } else if (!isOverloaded && wasOverloaded) {
    if (glitch) glitch.classList.remove('active');
    if (bracelet) bracelet.classList.remove('overloaded');
  }
}

function updateBracelet() {
  const nameEl = document.getElementById('currentEmotion');
  const row = document.getElementById('activeInjectionsRow');
  
  if (activeInjections.length === 0) {
    nameEl.textContent = 'VACANT';
    if (row) row.innerHTML = '';
  } else if (activeInjections.length === 1) {
    nameEl.textContent = activeInjections[0].emotion.name;
    if (row) row.innerHTML = '';
  } else {
    nameEl.textContent = activeInjections.length + ' ACTIVE';
    if (row) {
      row.innerHTML = activeInjections.map(a => {
        const expiring = a.remaining <= 8;
        return `<div class="active-inject-chip${expiring ? ' expiring' : ''}"><span>${a.emotion.name}</span><span class="chip-timer">${a.remaining}s</span></div>`;
      }).join('');
    }
  }
}

function addNulls() {
  G.nulls += 100; document.getElementById('nullBalance').textContent = G.nulls;
  showToast('NULLS ACQUIRED', 'Ø 100 added to your balance', false);
}

// ================================================================
// TOAST
// ================================================================
let toastTimer;
function showToast(title, body, isError) {
  const t = document.getElementById('toast');
  document.getElementById('toastTitle').textContent = title;
  document.getElementById('toastBody').textContent = body;
  document.getElementById('toastTitle').style.color = isError ? '#aa4444' : 'var(--white)';
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3500);
}

// ================================================================
// SOUND ENGINE
// ================================================================
let AC = null;
let masterGain, ambienceGain, sfxGain, musicGain;
let rainNodes = [], droneNodes = [];

function initAudio() {
  if(AC) return;
  AC = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = AC.createGain(); masterGain.gain.value = 0.82; masterGain.connect(AC.destination);
  ambienceGain = AC.createGain(); ambienceGain.gain.value = 0.0; ambienceGain.connect(masterGain);
  sfxGain = AC.createGain(); sfxGain.gain.value = 1.0; sfxGain.connect(masterGain);
  musicGain = AC.createGain(); musicGain.gain.value = 0.0; musicGain.connect(masterGain);
}

function createNoiseBuffer(seconds, type) {
  const rate = AC.sampleRate; const frames = rate * seconds;
  const buf = AC.createBuffer(2, frames, rate);
  for(let c=0;c<2;c++) {
    const data = buf.getChannelData(c);
    if(type === 'white') { for(let i=0;i<frames;i++) data[i] = (Math.random()*2-1); }
    else if(type === 'pink') { let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0; for(let i=0;i<frames;i++){const w=(Math.random()*2-1);b0=0.99886*b0+w*0.0555179;b1=0.99332*b1+w*0.0750759;b2=0.96900*b2+w*0.1538520;b3=0.86650*b3+w*0.3104856;b4=0.55000*b4+w*0.5329522;b5=-0.7616*b5-w*0.0168980;data[i]=(b0+b1+b2+b3+b4+b5+b6+w*0.5362)*0.11;b6=w*0.115926;} }
  }
  return buf;
}

function startRainAmbience() { if(!AC) return; const buf=createNoiseBuffer(3,'pink'); const src=AC.createBufferSource();src.buffer=buf;src.loop=true;const lpf=AC.createBiquadFilter();lpf.type='lowpass';lpf.frequency.value=2800;const hpf=AC.createBiquadFilter();hpf.type='highpass';hpf.frequency.value=400;const g=AC.createGain();g.gain.value=0.28;src.connect(hpf);hpf.connect(lpf);lpf.connect(g);g.connect(ambienceGain);src.start();rainNodes.push(src,lpf,hpf,g); function scheduleThunder(){setTimeout(()=>{if(AC){playThunder();scheduleThunder();}},8000+Math.random()*18000);} scheduleThunder(); }
function stopRainAmbience() { rainNodes.forEach(n=>{try{n.stop&&n.stop();n.disconnect&&n.disconnect();}catch(e){}}); rainNodes=[]; }
function startCityDrone() { if(!AC) return; const freqs=[55,82.4,110,164.8]; droneNodes=freqs.map((f,i)=>{const osc=AC.createOscillator();osc.type=i%2===0?'sawtooth':'sine';osc.frequency.value=f;const g=AC.createGain();g.gain.value=0.018-i*0.003;const lfo=AC.createOscillator();lfo.frequency.value=0.08+i*0.02;const lfoG=AC.createGain();lfoG.gain.value=1.5;lfo.connect(lfoG);lfoG.connect(osc.detune);const filter=AC.createBiquadFilter();filter.type='lowpass';filter.frequency.value=300;osc.connect(filter);filter.connect(g);g.connect(ambienceGain);osc.start();lfo.start();return[osc,lfo,g,filter,lfoG];}); }
function stopCityDrone() { droneNodes.forEach(group=>group.forEach(n=>{try{n.stop&&n.stop();n.disconnect&&n.disconnect();}catch(e){}})); droneNodes=[]; }

let marketHumNodes = []; let pianoLoopTimer = null;
function playPianoNote(freq,vol,when){if(!AC)return;const t=when||AC.currentTime;const osc1=AC.createOscillator();osc1.type='sine';osc1.frequency.value=freq;const osc2=AC.createOscillator();osc2.type='sine';osc2.frequency.value=freq*2;const g1=AC.createGain();g1.gain.setValueAtTime(0,t);g1.gain.linearRampToValueAtTime(vol,t+0.012);g1.gain.exponentialRampToValueAtTime(0.001,t+3.2);const g2=AC.createGain();g2.gain.setValueAtTime(vol*0.22,t);g2.gain.exponentialRampToValueAtTime(0.001,t+2.0);const lpf=AC.createBiquadFilter();lpf.type='lowpass';lpf.frequency.value=2200;osc1.connect(g1);osc2.connect(g2);g1.connect(lpf);g2.connect(lpf);lpf.connect(ambienceGain);osc1.start(t);osc1.stop(t+3.5);osc2.start(t);osc2.stop(t+2.5);marketHumNodes.push(osc1,osc2,g1,g2,lpf);}
function startMarketHum(){if(!AC)return;stopCityDrone();stopRainAmbience();if(marketHumNodes.length)return;ambienceGain.gain.setTargetAtTime(0.45,AC.currentTime,1.8);const melody=[{f:220,t:0,v:0.055},{f:196,t:1.4,v:0.045},{f:164.8,t:2.6,v:0.050},{f:130.8,t:4.0,v:0.035},{f:146.8,t:5.2,v:0.040},{f:164.8,t:6.6,v:0.045},{f:220,t:8.4,v:0.050},{f:261.6,t:10.0,v:0.040},{f:220,t:11.6,v:0.038},{f:196,t:13.0,v:0.035},{f:164.8,t:14.8,v:0.042},{f:110,t:16.5,v:0.030}];const phraseDuration=19.5;const now=AC.currentTime;playPianoNote(110,0.06,now+0.5);playPianoNote(164.8,0.04,now+0.5);playPianoNote(220,0.03,now+0.5);function scheduleMelody(startOffset){melody.forEach(n=>{if(!AC)return;playPianoNote(n.f,n.v,AC.currentTime+startOffset+n.t);});playPianoNote(55,0.04,AC.currentTime+startOffset);playPianoNote(55,0.03,AC.currentTime+startOffset+9.5);}scheduleMelody(0.5);pianoLoopTimer=setInterval(()=>{if(!AC||G.currentScreen!=='market')return;scheduleMelody(0.2+Math.random()*0.4);},phraseDuration*1000);}
function stopMarketHum(){clearInterval(pianoLoopTimer);pianoLoopTimer=null;marketHumNodes.forEach(n=>{try{n.stop&&n.stop();n.disconnect&&n.disconnect();}catch(e){}});marketHumNodes=[];}

function playThunder(){if(!AC)return;const buf=createNoiseBuffer(3,'pink');const src=AC.createBufferSource();src.buffer=buf;const g=AC.createGain();const now=AC.currentTime;g.gain.setValueAtTime(0,now);g.gain.linearRampToValueAtTime(0.35,now+0.05);g.gain.exponentialRampToValueAtTime(0.001,now+3.0);const lpf=AC.createBiquadFilter();lpf.type='lowpass';lpf.frequency.value=180;src.connect(lpf);lpf.connect(g);g.connect(sfxGain);src.start();src.stop(now+3.1);}
function playClick(freq,dur){if(!AC)return;const osc=AC.createOscillator();osc.type='square';osc.frequency.value=freq||440;const g=AC.createGain();const now=AC.currentTime;g.gain.setValueAtTime(0.18,now);g.gain.exponentialRampToValueAtTime(0.001,now+(dur||0.08));const lpf=AC.createBiquadFilter();lpf.type='lowpass';lpf.frequency.value=2000;osc.connect(lpf);lpf.connect(g);g.connect(sfxGain);osc.start(now);osc.stop(now+(dur||0.08));}
function playForgeSound(){if(!AC)return;const now=AC.currentTime;const osc1=AC.createOscillator();osc1.type='sine';osc1.frequency.setValueAtTime(80,now);osc1.frequency.exponentialRampToValueAtTime(30,now+0.6);const g1=AC.createGain();g1.gain.setValueAtTime(0.6,now);g1.gain.exponentialRampToValueAtTime(0.001,now+0.7);osc1.connect(g1);g1.connect(sfxGain);osc1.start(now);osc1.stop(now+0.7);const nb=createNoiseBuffer(0.2,'white');const ns=AC.createBufferSource();ns.buffer=nb;const ng=AC.createGain();ng.gain.setValueAtTime(0.12,now);ng.gain.exponentialRampToValueAtTime(0.001,now+0.18);const nhpf=AC.createBiquadFilter();nhpf.type='highpass';nhpf.frequency.value=3000;ns.connect(nhpf);nhpf.connect(ng);ng.connect(sfxGain);ns.start(now);ns.stop(now+0.2);}
function playEnterCitySound(){if(!AC)return;const now=AC.currentTime;const osc=AC.createOscillator();osc.type='sawtooth';osc.frequency.setValueAtTime(800,now);osc.frequency.exponentialRampToValueAtTime(55,now+1.2);const g=AC.createGain();g.gain.setValueAtTime(0.0,now);g.gain.linearRampToValueAtTime(0.25,now+0.05);g.gain.exponentialRampToValueAtTime(0.001,now+1.2);const lpf=AC.createBiquadFilter();lpf.type='lowpass';lpf.frequency.value=1200;osc.connect(lpf);lpf.connect(g);g.connect(sfxGain);osc.start(now);osc.stop(now+1.3);}
function playCutsceneDrone(){if(!AC)return;startRainAmbience();startCityDrone();ambienceGain.gain.setTargetAtTime(0.7,AC.currentTime,2.0);const now=AC.currentTime;[[110,0.0,0.8],[138.6,0.5,0.6],[164.8,1.0,0.5],[110,2.0,1.2]].forEach(([f,t,d])=>{const o=AC.createOscillator();o.type='sine';o.frequency.value=f;const g=AC.createGain();g.gain.setValueAtTime(0,now+t);g.gain.linearRampToValueAtTime(0.12,now+t+0.1);g.gain.exponentialRampToValueAtTime(0.001,now+t+d);const del=AC.createDelay(1.0);del.delayTime.value=0.35;const delG=AC.createGain();delG.gain.value=0.25;o.connect(g);g.connect(musicGain);g.connect(del);del.connect(delG);delG.connect(musicGain);o.start(now+t);o.stop(now+t+d+0.5);});musicGain.gain.setTargetAtTime(0.5,now,0.5);}
function playTitleReveal(){if(!AC)return;const now=AC.currentTime;const nb=createNoiseBuffer(2.0,'white');const src=AC.createBufferSource();src.buffer=nb;const g=AC.createGain();g.gain.setValueAtTime(0.001,now);g.gain.exponentialRampToValueAtTime(0.18,now+1.8);g.gain.linearRampToValueAtTime(0,now+2.2);const hpf=AC.createBiquadFilter();hpf.type='highpass';hpf.frequency.value=6000;src.connect(hpf);hpf.connect(g);g.connect(sfxGain);src.start(now);src.stop(now+2.2);}
function playJunctionReveal(){if(!AC)return;const now=AC.currentTime;const o1=AC.createOscillator();o1.type='sine';o1.frequency.value=55;const g1=AC.createGain();g1.gain.setValueAtTime(0,now);g1.gain.linearRampToValueAtTime(0.18,now+1.5);g1.gain.exponentialRampToValueAtTime(0.001,now+4);o1.connect(g1);g1.connect(sfxGain);o1.start(now);o1.stop(now+4.2);const o2=AC.createOscillator();o2.type='sine';o2.frequency.setValueAtTime(400,now);o2.frequency.exponentialRampToValueAtTime(800,now+2);const g2=AC.createGain();g2.gain.setValueAtTime(0,now);g2.gain.linearRampToValueAtTime(0.06,now+0.5);g2.gain.exponentialRampToValueAtTime(0.001,now+3);o2.connect(g2);g2.connect(sfxGain);o2.start(now);o2.stop(now+3.2);}

let footstepTimer = null;
function startFootsteps(){if(!AC)return;let step=0;footstepTimer=setInterval(()=>{if(!AC)return;const now=AC.currentTime;const nb=createNoiseBuffer(0.08,'white');const src=AC.createBufferSource();src.buffer=nb;const g=AC.createGain();g.gain.setValueAtTime(0.06,now);g.gain.exponentialRampToValueAtTime(0.001,now+0.07);const lpf=AC.createBiquadFilter();lpf.type='lowpass';lpf.frequency.value=step%2===0?300:250;src.connect(lpf);lpf.connect(g);g.connect(sfxGain);src.start(now);src.stop(now+0.09);step++;},420);}
function stopFootsteps(){clearInterval(footstepTimer);footstepTimer=null;}

// Sound hooks
document.getElementById('forgeBtn').addEventListener('click', () => { initAudio(); playForgeSound(); });
document.getElementById('enterCityBtn').addEventListener('click', () => { initAudio(); playEnterCitySound(); }, true);
let sliderThrottle = 0;
['luxSlider','noxSlider'].forEach(id => { document.getElementById(id).addEventListener('input', () => { const now = Date.now(); if(now - sliderThrottle > 80) { initAudio(); playClick(600+Math.random()*200, 0.04); sliderThrottle = now; } }); });

const _origStartCutscene = startCutscene;
startCutscene = function() { initAudio(); _origStartCutscene(); };
const _origRunCutscene = runCutscene;
runCutscene = function() { playCutsceneDrone(); startFootsteps(); _origRunCutscene(); };
const titleCardObs = new MutationObserver((muts) => { muts.forEach(m => { if(m.target.classList.contains('show')) { playTitleReveal(); stopFootsteps(); } else if(!m.target.classList.contains('show') && m.oldValue && m.oldValue.includes('show')) { startFootsteps(); } }); });
titleCardObs.observe(document.getElementById('titleCard'), { attributes: true, attributeFilter: ['class'], attributeOldValue: true });

const _origEnterMarket = enterMarket;
enterMarket = function(cancelFn) { stopFootsteps(); setTimeout(() => { if(AC) startMarketHum(); }, 800); _origEnterMarket(cancelFn); setTimeout(() => updateNavHub('market'), 200); };

const _origHandleBuy = handleBuy;
handleBuy = function(id) { initAudio(); _origHandleBuy(id); };

const _origAddNulls = addNulls;
addNulls = function() { initAudio(); playClick(554, 0.08); _origAddNulls(); };

// Hover sounds
document.addEventListener('mouseover', (e) => { if(e.target.classList.contains('buy-btn') || e.target.classList.contains('emotion-card')) { if(AC && Date.now() - sliderThrottle > 120) { const now=AC.currentTime;const o=AC.createOscillator();o.type='sine';o.frequency.value=800;const g=AC.createGain();g.gain.setValueAtTime(0.03,now);g.gain.exponentialRampToValueAtTime(0.001,now+0.06);o.connect(g);g.connect(sfxGain);o.start(now);o.stop(now+0.06);sliderThrottle=Date.now(); } } });

// ================================================================
// RUINBOW FACTORY
// ================================================================
const ORES = [
  { id:'melancholy', name:'MELANCHOLY SHARD', desc:'Crystallised low-grade sadness. Common. Stable yield.', yield:3, clicks:8, color:'#a06a3a', color2:'#4a2a1a' },
  { id:'nostalgia', name:'NOSTALGIA CRYSTAL', desc:'Compressed longing for lost time. Mid-grade. Warm undertones.', yield:7, clicks:15, color:'#c8884a', color2:'#6a4a3a' },
  { id:'dread', name:'DREAD OBSIDIAN', desc:'Solidified anticipatory fear. Dense. High yield per gram.', yield:12, clicks:22, color:'#3a3a4a', color2:'#1a1a1a' },
  { id:'euphoria', name:'EUPHORIA PRISM', desc:'Rare crystallised joy. Unstable — decays rapidly. Maximum risk.', yield:20, clicks:30, color:'#e8a850', color2:'#b87a3a' },
];

let activeOre = ORES[0];
let distillClicks = 0;
let distillComplete = false;
let factoryEarnings = 0;
let machineAnimFrame = null;
let machinePhase = 0;
let machineEnergy = 0;
let lastClickTime = 0;
let clickVelocity = 0;
let sparks = [];
let sparkTimer = 0;

function buildRuinbow() {
  const container = document.getElementById('ruinbowParticles'); container.innerHTML = '';
  for(let i=0;i<18;i++){const p=document.createElement('div');p.className='r-particle';const size=4+Math.random()*14;p.style.cssText=`width:${size}px;height:${size}px;left:${Math.random()*100}%;animation-duration:${12+Math.random()*20}s;animation-delay:${Math.random()*15}s;--drift:${(Math.random()-0.5)*120}px;opacity:0.4`;container.appendChild(p);}
  const list = document.getElementById('oreList'); list.innerHTML = '';
  ORES.forEach(ore => {
    const item = document.createElement('div'); item.className = `ore-item${ore.id===activeOre.id?' active-ore':''}`; item.id = `ore-${ore.id}`; item.onclick = () => selectOre(ore);
    item.innerHTML = `<div class="ore-gem" style="background:linear-gradient(135deg,${ore.color},${ore.color2});box-shadow:0 0 10px ${ore.color}44"></div><div><div class="ore-item-name">${ore.name}</div><div class="ore-item-desc">Ø${ore.yield} per batch · ${ore.clicks} clicks</div></div><div class="ore-item-yield">Ø${ore.yield}</div><div class="ore-item-active-dot"></div>`;
    list.appendChild(item);
  });
  startMachineAnimation(); resetDistill(); updateFactoryNulls();
}

function selectOre(ore) { activeOre=ore;document.querySelectorAll('.ore-item').forEach(el=>el.classList.remove('active-ore'));const el=document.getElementById(`ore-${ore.id}`);if(el)el.classList.add('active-ore');document.getElementById('activeOreName').textContent=ore.name;document.getElementById('activeOreName').style.color=ore.color;document.getElementById('activeOreDesc').textContent=ore.desc;document.getElementById('rewardAmt').textContent=ore.yield;resetDistill();playClick(440,0.08);addLog(`Ore loaded: ${ore.name}`,'default'); }
function resetDistill() { distillClicks=0;distillComplete=false;machinePhase=0;updateDistillUI();document.getElementById('distillCta').textContent='◈ CLICK TO DISTIL ◈';document.getElementById('distillCta').style.color='#b87a3a'; }
function updateDistillUI() { const pct=Math.round((distillClicks/(activeOre?activeOre.clicks:10))*100);document.getElementById('distillPct').textContent=pct+'%';document.getElementById('distillFill').style.width=pct+'%'; }
function clickDistill() { if(!activeOre||distillComplete)return;initAudio();const now=Date.now();clickVelocity=Math.min(1,1/(Math.max(50,now-lastClickTime)/200));lastClickTime=now;distillClicks++;machinePhase=1;machineEnergy=Math.min(1,machineEnergy+0.15);updateDistillUI();playDistillClick();if(distillClicks>=activeOre.clicks){distillComplete=true;machinePhase=2;factoryEarnings+=activeOre.yield;updateFactoryNulls();document.getElementById('distillCta').textContent='✓ BATCH COMPLETE';document.getElementById('distillCta').style.color='#8a9a8a';addLog(`Batch complete: +Ø${activeOre.yield}`,'success');playDistillComplete();setTimeout(()=>resetDistill(),1500);} }
function updateFactoryNulls() { document.getElementById('factoryNulls').textContent=factoryEarnings;const btn=document.getElementById('transferBtn');btn.disabled=factoryEarnings<=0; }
function transferNulls() { if(factoryEarnings<=0)return;G.nulls+=factoryEarnings;document.getElementById('nullBalance').textContent=G.nulls;showToast('EARNINGS TRANSFERRED',`Ø ${factoryEarnings} moved to Null Wallet`,false);factoryEarnings=0;updateFactoryNulls(); }
function addLog(msg,type) { const log=document.getElementById('outputLog');const entry=document.createElement('div');entry.className=`log-entry ${type||''}`;const d=new Date();entry.innerHTML=`<span class="log-time">[${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}]</span><span>${msg}</span>`;log.insertBefore(entry,log.children[0]); }

function startMachineAnimation() {
  const mc = document.getElementById('machineCanvas'); const ctx = mc.getContext('2d');
  function drawMachine() {
    machineAnimFrame = requestAnimationFrame(drawMachine);
    ctx.clearRect(0,0,160,160);
    const cx=80,cy=80;
    machineEnergy = Math.max(0, machineEnergy - 0.003);
    const isWorking = machinePhase === 1;
    const isComplete = machinePhase === 2;
    const col = activeOre ? activeOre.color : '#b87a3a';

    // Outer ring
    ctx.beginPath(); ctx.arc(cx,cy,60,0,Math.PI*2);
    ctx.strokeStyle=`${col}${isWorking?'88':'33'}`;ctx.lineWidth=1.5;ctx.stroke();
    // Inner rotating hexagons
    const t=Date.now()*0.001;
    for(let i=0;i<6;i++){
      const a=t*0.8+i*Math.PI/3;const r=28+machineEnergy*8;
      const hx=cx+r*Math.cos(a);const hy=cy+r*Math.sin(a);
      ctx.save();ctx.translate(hx,hy);ctx.rotate(a+t);
      ctx.beginPath();for(let j=0;j<6;j++){const ha=Math.PI/3*j;const s=6+machineEnergy*4;ctx.lineTo(s*Math.cos(ha),s*Math.sin(ha));}ctx.closePath();
      ctx.strokeStyle=`${col}${isWorking?'aa':'55'}`;ctx.lineWidth=1;ctx.stroke();ctx.restore();
    }
    // Center glow
    const gg=ctx.createRadialGradient(cx,cy,0,cx,cy,30+machineEnergy*10);
    gg.addColorStop(0,isWorking?col:`${col}44`);gg.addColorStop(1,'transparent');
    ctx.beginPath();ctx.arc(cx,cy,22+machineEnergy*6,0,Math.PI*2);ctx.fillStyle=gg;ctx.fill();
    if(isComplete){sparkTimer++;ctx.beginPath();ctx.arc(cx,cy,25+(sparkTimer%30),0,Math.PI*2);ctx.strokeStyle=`${col}${Math.floor(255*(1-(sparkTimer%30)/30)).toString(16).padStart(2,'0')}`;ctx.lineWidth=2;ctx.stroke();}
    if(machineEnergy>0.3&&isWorking){if(Math.random()<machineEnergy*0.4){const sa=Math.random()*Math.PI*2;sparks.push({x:cx+Math.cos(sa)*28,y:cy+Math.sin(sa)*28,vx:Math.cos(sa)*2+Math.random()*2-1,vy:Math.sin(sa)*2+Math.random()*2-1,life:1});}}
    for(let i=sparks.length-1;i>=0;i--){const sp=sparks[i];sp.x+=sp.vx;sp.y+=sp.vy;sp.life-=0.08;if(sp.life<=0){sparks.splice(i,1);continue;}ctx.beginPath();ctx.arc(sp.x,sp.y,2*sp.life,0,Math.PI*2);ctx.fillStyle=`${col}${Math.floor(sp.life*200).toString(16).padStart(2,'0')}`;ctx.fill();}
    const prog=distillClicks/(activeOre?activeOre.clicks:10);ctx.beginPath();ctx.arc(cx,cy,50,-Math.PI/2,-Math.PI/2+prog*Math.PI*2);ctx.strokeStyle=col;ctx.lineWidth=3;ctx.lineCap='round';ctx.stroke();
  }
  drawMachine();
}

function playDistillClick(){if(!AC)return;const now=AC.currentTime;const nb=createNoiseBuffer(0.06,'white');const src=AC.createBufferSource();src.buffer=nb;const g=AC.createGain();g.gain.setValueAtTime(0.18,now);g.gain.exponentialRampToValueAtTime(0.001,now+0.055);const bpf=AC.createBiquadFilter();bpf.type='bandpass';bpf.frequency.value=800+clickVelocity*600;bpf.Q.value=3;src.connect(bpf);bpf.connect(g);g.connect(sfxGain);src.start(now);src.stop(now+0.07);}
function playDistillComplete(){if(!AC)return;const now=AC.currentTime;[220,277.2,329.6,440].forEach((f,i)=>{const o=AC.createOscillator();o.type='sine';o.frequency.value=f;const g2=AC.createGain();const t=now+i*0.07;g2.gain.setValueAtTime(0.09,t);g2.gain.exponentialRampToValueAtTime(0.001,t+0.9);o.connect(g2);g2.connect(sfxGain);o.start(t);o.stop(t+1);});}

// Ruinbow atmosphere
let ruinbowAtmoNodes = []; let ruinbowDroneTimer = null;
function startRuinbowAtmo(){if(!AC||ruinbowAtmoNodes.length)return;ambienceGain.gain.setTargetAtTime(0.5,AC.currentTime,2.0);const osc=AC.createOscillator();osc.type='sawtooth';osc.frequency.value=44;const g=AC.createGain();g.gain.value=0.02;const lpf=AC.createBiquadFilter();lpf.type='lowpass';lpf.frequency.value=120;osc.connect(lpf);lpf.connect(g);g.connect(ambienceGain);osc.start();ruinbowAtmoNodes=[osc,lpf,g];ruinbowDroneTimer=setInterval(()=>{if(!AC||G.currentScreen!=='ruinbow')return;const f=[82.4,98,110,123.5,146.8,164.8][Math.floor(Math.random()*6)];const now=AC.currentTime;const o=AC.createOscillator();o.type='sine';o.frequency.value=f;const gn=AC.createGain();gn.gain.setValueAtTime(0,now);gn.gain.linearRampToValueAtTime(0.04,now+0.08);gn.gain.exponentialRampToValueAtTime(0.001,now+4.5);const lpf2=AC.createBiquadFilter();lpf2.type='lowpass';lpf2.frequency.value=1800;o.connect(lpf2);lpf2.connect(gn);gn.connect(ambienceGain);o.start(now);o.stop(now+5);ruinbowAtmoNodes.push(o,gn,lpf2);},3500+Math.random()*2000);}
function stopRuinbowAtmo(){clearInterval(ruinbowDroneTimer);ruinbowDroneTimer=null;ruinbowAtmoNodes.forEach(n=>{try{n.stop&&n.stop();n.disconnect&&n.disconnect();}catch(e){}});ruinbowAtmoNodes=[];if(ambienceGain)ambienceGain.gain.setTargetAtTime(0,AC?AC.currentTime:0,0.5);}


// ================================================================
// ENTER CITY MAP (replaces junction destination choice)
// ================================================================
function enterCityMap(cancelFn) {
  if(cancelFn) cancelFn();
  cutscenePlaying = false;
  enableCityNav();
  switchScreen('map');
  updateNavHub('map');
  document.getElementById('mapNulls').textContent = G.nulls;
  setTimeout(updateMapTransform, 50);
  if(AC) startMapAmbience();
}

function enableCityNav() {
  document.getElementById('navInv').style.display = '';
  document.getElementById('navMap').style.display = '';
  document.getElementById('navWalk').style.display = '';
}

function navGoToInventory() { toggleNavPanel(); renderInventory(); switchScreen('inventory'); updateNavHub('inventory'); }
function navGoToWalk() { toggleNavPanel(); startWalkTheCity(); switchScreen('walk'); updateNavHub('walk'); }
function navGoToMap() { toggleNavPanel(); switchScreen('map'); updateNavHub('map'); document.getElementById('mapNulls').textContent = G.nulls; }

// ================================================================
// MAP SYSTEM
// ================================================================
let mapScale = 1, mapX = -740, mapY = -440;

function updateMapTransform() {
  const c = document.getElementById('mapCanvas');
  if(c) c.style.transform = `translate(${mapX}px, ${mapY}px) scale(${mapScale})`;
}

function mapZoom(dir) {
  mapScale = Math.max(0.4, Math.min(2.5, mapScale + dir * 0.12));
  updateMapTransform();
}

// Drag support (mouse)
(function() {
  let dragging = false, lastX, lastY;
  document.addEventListener('mousedown', e => {
    if(!e.target.closest('#mapViewport') || e.target.closest('.map-location') || e.target.closest('.map-zoom-btn')) return;
    dragging = true; lastX = e.clientX; lastY = e.clientY; e.preventDefault();
  });
  document.addEventListener('mousemove', e => {
    if(!dragging) return;
    mapX += e.clientX - lastX; mapY += e.clientY - lastY;
    lastX = e.clientX; lastY = e.clientY; updateMapTransform();
  });
  document.addEventListener('mouseup', () => { dragging = false; });
  document.addEventListener('wheel', e => {
    if(!e.target.closest('#mapViewport')) return;
    e.preventDefault(); mapZoom(e.deltaY < 0 ? 1 : -1);
  }, {passive: false});
})();

// Touch support (mobile drag + pinch zoom)
(function() {
  let touchDragging = false, lastTouchX, lastTouchY, lastPinchDist = 0;

  function getTouchDist(touches) {
    const dx = touches[0].clientX - touches[1].clientX;
    const dy = touches[0].clientY - touches[1].clientY;
    return Math.sqrt(dx*dx + dy*dy);
  }

  document.addEventListener('touchstart', e => {
    if(!e.target.closest('#mapViewport') || e.target.closest('.map-location') || e.target.closest('.map-zoom-btn') || e.target.closest('.map-back-btn')) return;
    if(e.touches.length === 2) {
      lastPinchDist = getTouchDist(e.touches);
      e.preventDefault();
    } else if(e.touches.length === 1) {
      touchDragging = true;
      lastTouchX = e.touches[0].clientX;
      lastTouchY = e.touches[0].clientY;
      e.preventDefault();
    }
  }, {passive: false});

  document.addEventListener('touchmove', e => {
    if(!e.target.closest('#mapViewport')) return;
    if(e.touches.length === 2 && lastPinchDist > 0) {
      e.preventDefault();
      const newDist = getTouchDist(e.touches);
      const delta = newDist - lastPinchDist;
      if(Math.abs(delta) > 3) {
        mapZoom(delta > 0 ? 0.5 : -0.5);
        lastPinchDist = newDist;
      }
    } else if(e.touches.length === 1 && touchDragging) {
      e.preventDefault();
      const tx = e.touches[0].clientX, ty = e.touches[0].clientY;
      mapX += tx - lastTouchX; mapY += ty - lastTouchY;
      lastTouchX = tx; lastTouchY = ty;
      updateMapTransform();
    }
  }, {passive: false});

  document.addEventListener('touchend', e => {
    touchDragging = false;
    if(e.touches.length < 2) lastPinchDist = 0;
  });
})();

function mapNav(dest) {
  initAudio(); playClick(660, 0.1); stopMapAmbience();
  if(dest === 'market') { startMarketHum(); buildMarket(); switchScreen('market'); updateNavHub('market'); }
  else if(dest === 'ruinbow') { if(typeof startRuinbowAtmo==='function') startRuinbowAtmo(); buildRuinbow(); switchScreen('ruinbow'); updateNavHub('ruinbow'); }
  else if(dest === 'delirium') { startDeliriumAmbience(); buildDelirium(); switchScreen('delirium'); updateNavHub('delirium'); }
  else if(dest === 'inventory') { renderInventory(); switchScreen('inventory'); updateNavHub('inventory'); }
}

function mapNavWondrix() {
  const loc = document.getElementById('mapWondrix');
  if(loc && loc.classList.contains('unlocked')) {
    initAudio(); playClick(300, 0.15);
    stopMapAmbience();
    switchScreen('wondrix'); updateNavHub('wondrix');
    setTimeout(() => startWondrixGame(), 400);
  } else {
    wondrixAccess();
  }
}

// ================================================================
// INVENTORY SYSTEM
// ================================================================
if(!G.inventory) G.inventory = { emotions: [], items: [] };

function addToInventory(type, item) {
  if(type === 'emotion') {
    if(!G.inventory.emotions.find(e => e.id === item.id)) G.inventory.emotions.push(item);
  } else if(type === 'item') {
    if(!G.inventory.items.find(i => i.id === item.id)) G.inventory.items.push(item);
  }
}

function hasItem(itemId) { return G.inventory.items.some(i => i.id === itemId); }

function renderInventory() {
  // Refresh character SVG with current alignment
  if(G.charGenerated) {
    drawCharacter(G.lux, G.nox, seededRand(G.lux * 1337 + G.nox * 31));
  }
  const svgEl = document.getElementById('invCharSvg');
  if(svgEl && G.charSVGContent) svgEl.innerHTML = G.charSVGContent;
  document.getElementById('invCharName').textContent = G.charName || '—';
  document.getElementById('invCharCode').textContent = G.charCode || '—';
  document.getElementById('invCharArch').textContent = G.charArchetype || '—';
  document.getElementById('invNulls').textContent = G.nulls;

  // Alignment
  document.getElementById('invLuxPct').textContent = Math.round(G.lux);
  document.getElementById('invNoxPct').textContent = Math.round(G.nox);
  document.getElementById('invAlignLux').style.width = G.lux + '%';
  document.getElementById('invAlignNox').style.width = G.nox + '%';

  // Emotions
  const emotDiv = document.getElementById('invEmotions');
  const ownedEmotions = Object.keys(purchases).filter(k => purchases[k]);
  if(ownedEmotions.length === 0) { emotDiv.innerHTML = '<div class="inv-empty">No emotions acquired</div>'; }
  else { emotDiv.innerHTML = ownedEmotions.map(id => { const e = EMOTIONS.find(em => em.id === id); return e ? `<div class="inv-item-chip emotion-chip">${e.name}</div>` : ''; }).join(''); }

  // Items
  const itemDiv = document.getElementById('invItems');
  if(G.inventory.items.length === 0) { itemDiv.innerHTML = '<div class="inv-empty">No items owned</div>'; }
  else { itemDiv.innerHTML = G.inventory.items.map(i => `<div class="inv-item-chip delirium-chip">${i.icon || ''} ${i.name}</div>`).join(''); }

  // Codes
  const codeSection = document.getElementById('invCodeSection');
  let codeHTML = '';
  if(hasItem('data_chip')) codeHTML += '<div class="inv-code-display">VV-VERDICT-7Q2</div>';
  if(hasItem('code_lux')) codeHTML += '<div class="inv-code-display" style="margin-top:8px;">LX-LUMEN-8BP</div>';
  if(hasItem('code_nox')) codeHTML += '<div class="inv-code-display" style="margin-top:8px;border-color:rgba(60,60,80,0.15);color:rgba(100,100,140,0.6);">NX-UMBRA-4KF</div>';
  if(codeHTML) { codeSection.style.display = ''; codeSection.innerHTML = '<div class="inv-section-title">Classified Data</div>' + codeHTML; }
  else { codeSection.style.display = 'none'; }
}

// ================================================================
// THE DELIRIUM — SHOP
// ================================================================
const DELIRIUM_ITEMS = {
  trinkets: [
    {id:'badge', name:'Smilemore Badge', desc:'A corroded compliance pin. They used to hand these out at the gates.', price:5, icon:'⊛'},
    {id:'fragment', name:'Memory Fragment', desc:'A shard of crystallised recall. Origin unknown. Content: indeterminate.', price:8, icon:'◇'},
    {id:'null_coin', name:'Null Coin Replica', desc:'Counterfeit currency. No exchange value. Collectors only.', price:3, icon:'Ø'},
    {id:'lens', name:'Cracked Lens', desc:'Optical filter from a decommissioned surveillance unit. Still warm.', price:12, icon:'◎'},
    {id:'thread', name:'Nanofiber Thread', desc:'A single strand of mask-grade material. Illegal to possess in quantities.', price:6, icon:'|'},
  ],
  high_value: [
    {id:'bolt_cutters', name:'Bolt Cutters', desc:'Industrial grade. Cuts through Sector perimeter fencing. One use. No questions.', price:500, icon:'✂', special:'wondrix_access'},
    {id:'data_chip', name:'Encrypted Data Chip', desc:'Contents sealed until acquired. Classification level: ABSOLUTE. Handle with discretion.', price:750, icon:'◆', special:'code_reveal'},
  ]
};

function buildDelirium() {
  document.getElementById('deliriumNulls').textContent = G.nulls;
  const tGrid = document.getElementById('deliriumTrinkets');
  const hGrid = document.getElementById('deliriumHighValue');
  tGrid.innerHTML = DELIRIUM_ITEMS.trinkets.map(i => renderDeliriumItem(i)).join('');
  hGrid.innerHTML = DELIRIUM_ITEMS.high_value.map(i => renderDeliriumItem(i, true)).join('');
}

function renderDeliriumItem(item, highlight) {
  const owned = hasItem(item.id);
  return `<div class="delirium-item ${owned?'owned':''} ${highlight?'highlight-item':''}" onclick="${owned?'':'buyDeliriumItem(\'' + item.id + '\')'}" >
    <div class="delirium-item-icon">${item.icon}</div>
    <div class="delirium-item-name">${item.name}</div>
    <div class="delirium-item-desc">${item.desc}</div>
    <div class="delirium-item-price"><span>Ø</span> ${item.price}</div>
  </div>`;
}

function buyDeliriumItem(itemId) {
  if(hasItem(itemId)) return;
  const allItems = [...DELIRIUM_ITEMS.trinkets, ...DELIRIUM_ITEMS.high_value];
  const item = allItems.find(i => i.id === itemId);
  if(!item) return;
  if(G.nulls < item.price) { showToast('INSUFFICIENT NULLS', `Requires Ø${item.price}. Current balance: Ø${G.nulls}`, true); return; }

  G.nulls -= item.price;
  addToInventory('item', item);
  initAudio(); playClick(880, 0.12);

  // Special effects
  if(item.special === 'wondrix_access') {
    const wLoc = document.getElementById('mapWondrix');
    if(wLoc) wLoc.classList.add('unlocked');
    showToast('BOLT CUTTERS ACQUIRED', 'Wondrix perimeter access granted. Proceed at own risk.', false);
  } else if(item.special === 'code_reveal') {
    showToast('DATA CHIP ACQUIRED', 'Encrypted contents transferred to inventory.', false);
  } else {
    showToast(item.name.toUpperCase(), 'Item added to inventory.', false);
  }

  buildDelirium();
  syncNullDisplays();
}

function syncNullDisplays() {
  const els = ['nullBalance','factoryNulls','deliriumNulls','mapNulls','invNulls'];
  els.forEach(id => { const el = document.getElementById(id); if(el) el.textContent = G.nulls; });
}

// ================================================================
// DELIRIUM AMBIENCE
// ================================================================
let deliriumNodes = [], deliriumMelodyTimer = null;

function startDeliriumAmbience() {
  if(!AC || deliriumNodes.length) return;
  stopMarketHum(); if(typeof stopRuinbowAtmo==='function') stopRuinbowAtmo(); stopMapAmbience();
  ambienceGain.gain.setTargetAtTime(0.4, AC.currentTime, 1.5);

  // Low drone — dark pad
  const osc1 = AC.createOscillator(); osc1.type = 'sine'; osc1.frequency.value = 65;
  const g1 = AC.createGain(); g1.gain.value = 0.03;
  const lpf = AC.createBiquadFilter(); lpf.type = 'lowpass'; lpf.frequency.value = 200;
  osc1.connect(lpf); lpf.connect(g1); g1.connect(ambienceGain); osc1.start();
  deliriumNodes.push(osc1, lpf, g1);

  // Shimmering high texture
  const osc2 = AC.createOscillator(); osc2.type = 'sine'; osc2.frequency.value = 1320;
  const g2 = AC.createGain(); g2.gain.value = 0.005;
  const lfo = AC.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = 0.3;
  const lfoG = AC.createGain(); lfoG.gain.value = 0.004;
  lfo.connect(lfoG); lfoG.connect(g2.gain);
  osc2.connect(g2); g2.connect(ambienceGain); osc2.start(); lfo.start();
  deliriumNodes.push(osc2, g2, lfo, lfoG);

  // Melody — eerie descending notes
  const notes = [392, 370, 330, 311, 294, 261.6, 246.9, 220, 196, 174.6];
  let noteIdx = 0;
  deliriumMelodyTimer = setInterval(() => {
    if(!AC || G.currentScreen !== 'delirium') return;
    const now = AC.currentTime;
    const f = notes[noteIdx % notes.length] * (0.5 + Math.random()*0.5);
    const o = AC.createOscillator(); o.type = 'triangle'; o.frequency.value = f;
    o.frequency.setValueAtTime(f, now); o.frequency.exponentialRampToValueAtTime(f*0.95, now+3);
    const gn = AC.createGain(); gn.gain.setValueAtTime(0, now);
    gn.gain.linearRampToValueAtTime(0.02, now+0.3); gn.gain.exponentialRampToValueAtTime(0.001, now+4);
    const rev = AC.createBiquadFilter(); rev.type = 'lowpass'; rev.frequency.value = 1200;
    o.connect(rev); rev.connect(gn); gn.connect(ambienceGain); o.start(now); o.stop(now+4.5);
    deliriumNodes.push(o, gn, rev);
    noteIdx++;
  }, 2800 + Math.random()*1500);
}

function stopDeliriumAmbience() {
  clearInterval(deliriumMelodyTimer); deliriumMelodyTimer = null;
  deliriumNodes.forEach(n => { try { n.stop && n.stop(); n.disconnect && n.disconnect(); } catch(e) {} });
  deliriumNodes = [];
}

// ================================================================
// MAP AMBIENCE — Civic hum
// ================================================================
let mapAmbiNodes = [], mapMelodyTimer = null;

function startMapAmbience() {
  if(!AC || mapAmbiNodes.length) return;
  stopMarketHum(); if(typeof stopRuinbowAtmo==='function') stopRuinbowAtmo(); stopDeliriumAmbience();
  ambienceGain.gain.setTargetAtTime(0.35, AC.currentTime, 1.5);

  // City murmur — filtered noise
  const buf = createNoiseBuffer(4, 'pink');
  const src = AC.createBufferSource(); src.buffer = buf; src.loop = true;
  const bpf = AC.createBiquadFilter(); bpf.type = 'bandpass'; bpf.frequency.value = 400; bpf.Q.value = 0.5;
  const g = AC.createGain(); g.gain.value = 0.04;
  src.connect(bpf); bpf.connect(g); g.connect(ambienceGain); src.start();
  mapAmbiNodes.push(src, bpf, g);

  // Slow civic melody — sparse piano-like tones
  const phrases = [196, 220, 261.6, 220, 196, 164.8, 146.8, 164.8];
  let pIdx = 0;
  mapMelodyTimer = setInterval(() => {
    if(!AC || G.currentScreen !== 'map') return;
    const f = phrases[pIdx % phrases.length];
    if(typeof playPianoNote === 'function') playPianoNote(f, 0.025, AC.currentTime);
    pIdx++;
  }, 4000);
}

function stopMapAmbience() {
  clearInterval(mapMelodyTimer); mapMelodyTimer = null;
  mapAmbiNodes.forEach(n => { try { n.stop && n.stop(); n.disconnect && n.disconnect(); } catch(e) {} });
  mapAmbiNodes = [];
}


// ================================================================
// WALK THE CITY — Choose Your Own Adventure
// ================================================================

// ================================================================
// WALK THE CITY — SVG Scene Art Generator
// ================================================================
function walkArt(type) {
  const w=600,h=140;
  let s='<svg viewBox="0 0 '+w+' '+h+'" xmlns="http://www.w3.org/2000/svg" style="opacity:0.7;">';
  // Ground
  s+='<rect x="0" y="105" width="'+w+'" height="35" fill="rgba(15,15,18,1)"/>';
  s+='<line x1="0" y1="106" x2="'+w+'" y2="106" stroke="rgba(200,184,154,0.08)" stroke-width="1" stroke-dasharray="12,20"/>';
  
  if(type==='street') {
    // Buildings
    for(let i=0;i<8;i++){const bx=i*78+10,bw=55+Math.sin(i*3)*15,bh=40+Math.sin(i*7)*25;
    s+='<rect x="'+bx+'" y="'+(105-bh)+'" width="'+bw+'" height="'+bh+'" fill="rgba(18,18,22,0.95)" stroke="rgba(200,184,154,0.04)" stroke-width="0.5"/>';
    for(let j=0;j<3;j++){const wx=bx+8+j*16,wy=105-bh+8+Math.floor(i+j)%2*18;
    s+='<rect x="'+wx+'" y="'+wy+'" width="5" height="6" fill="rgba(200,180,140,'+(0.08+Math.sin(i+j)*0.15).toFixed(2)+')"/>';}}
    // Neon sign
    s+='<rect x="180" y="32" width="90" height="22" rx="1" fill="rgba(5,5,8,0.9)" stroke="rgba(200,184,154,0.15)"/>';
    s+='<text x="225" y="47" text-anchor="middle" font-family="monospace" font-size="8" fill="rgba(200,184,154,0.5)" letter-spacing="3">SMILEMORE</text>';
    // Lamp posts
    s+='<line x1="120" y1="50" x2="120" y2="105" stroke="rgba(80,80,80,0.5)" stroke-width="2"/>';
    s+='<circle cx="120" cy="48" r="4" fill="rgba(200,180,140,0.2)"/>';
    s+='<circle cx="120" cy="48" r="12" fill="rgba(200,180,140,0.03)"/>';
    s+='<line x1="420" y1="55" x2="420" y2="105" stroke="rgba(80,80,80,0.5)" stroke-width="2"/>';
    s+='<circle cx="420" cy="53" r="4" fill="rgba(200,180,140,0.2)"/>';
  } else if(type==='alley') {
    // Narrow walls converging
    s+='<polygon points="0,20 180,50 180,105 0,105" fill="rgba(16,16,20,0.95)" stroke="rgba(200,184,154,0.03)"/>';
    s+='<polygon points="600,20 380,50 380,105 600,105" fill="rgba(16,16,20,0.95)" stroke="rgba(200,184,154,0.03)"/>';
    // Graffiti marks
    s+='<text x="50" y="72" font-family="monospace" font-size="7" fill="rgba(200,184,154,0.08)" transform="rotate(-8 50 72)">FEEL</text>';
    s+='<text x="480" y="65" font-family="monospace" font-size="5" fill="rgba(200,184,154,0.06)" transform="rotate(5 480 65)">who am i</text>';
    s+='<text x="100" y="88" font-family="monospace" font-size="10" fill="rgba(200,184,154,0.06)">Ø</text>';
    // Hunched figure
    s+='<ellipse cx="300" cy="92" rx="8" ry="12" fill="rgba(60,58,54,0.5)"/>';
    s+='<circle cx="300" cy="78" r="6" fill="rgba(60,58,54,0.5)"/>';
    // Steam
    s+='<path d="M250,60 Q260,40 255,20" stroke="rgba(200,200,200,0.04)" fill="none" stroke-width="8"/>';
    s+='<path d="M350,55 Q340,35 345,15" stroke="rgba(200,200,200,0.03)" fill="none" stroke-width="6"/>';
  } else if(type==='officer') {
    // Boulevard with officer figure
    for(let i=0;i<6;i++){const bx=i*105+20,bh=30+i*5;
    s+='<rect x="'+bx+'" y="'+(105-bh)+'" width="70" height="'+bh+'" fill="rgba(18,18,22,0.9)"/>';}
    // Officer — tall, rigid stance
    s+='<rect x="285" y="65" width="14" height="38" fill="rgba(240,237,230,0.35)"/>';
    s+='<circle cx="292" cy="58" r="8" fill="rgba(240,237,230,0.35)"/>';
    s+='<rect x="283" y="58" width="18" height="6" fill="rgba(240,237,230,0.25)"/>';
    // Neural dampener glow
    s+='<circle cx="304" cy="82" r="3" fill="rgba(200,60,60,0.3)"/>';
    s+='<circle cx="304" cy="82" r="8" fill="rgba(200,60,60,0.06)"/>';
    // Compliance screen
    s+='<rect x="420" y="30" width="50" height="35" fill="rgba(5,8,15,0.9)" stroke="rgba(60,120,200,0.15)"/>';
    s+='<rect x="424" y="38" width="42" height="3" fill="rgba(60,120,200,0.15)"/>';
    s+='<rect x="424" y="44" width="30" height="3" fill="rgba(60,200,60,0.1)"/>';
    s+='<rect x="424" y="50" width="20" height="3" fill="rgba(200,180,60,0.1)"/>';
  } else if(type==='registry') {
    // Big imposing building
    s+='<rect x="150" y="20" width="300" height="85" fill="rgba(16,16,20,0.97)" stroke="rgba(200,184,154,0.08)"/>';
    s+='<polygon points="140,20 300,0 460,20" fill="rgba(20,20,25,0.95)" stroke="rgba(200,184,154,0.06)"/>';
    for(let i=0;i<5;i++){s+='<rect x="'+(175+i*55)+'" y="30" width="6" height="70" fill="rgba(35,34,30,0.8)" stroke="rgba(200,184,154,0.04)"/>';}
    // Door glow
    s+='<rect x="270" y="60" width="60" height="45" fill="rgba(5,5,3,0.95)" stroke="rgba(200,184,154,0.2)"/>';
    s+='<circle cx="300" cy="82" r="30" fill="rgba(200,184,154,0.04)"/>';
    s+='<text x="300" y="14" text-anchor="middle" font-family="monospace" font-size="6" fill="rgba(200,184,154,0.2)" letter-spacing="4">CENTRAL REGISTRY</text>';
  } else if(type==='pipes') {
    // Maintenance corridor with pipes
    s+='<rect x="0" y="0" width="'+w+'" height="105" fill="rgba(10,10,14,0.98)"/>';
    for(let i=0;i<4;i++){const py=15+i*22;
    s+='<line x1="0" y1="'+py+'" x2="'+w+'" y2="'+py+'" stroke="rgba(60,58,50,0.25)" stroke-width="'+(3-i*0.5)+'"/>';
    if(i%2===0) s+='<circle cx="'+(200+i*80)+'" cy="'+py+'" r="6" fill="none" stroke="rgba(200,184,154,0.08)" stroke-width="1"/>';}
    // Steam vents
    s+='<path d="M300,60 Q310,40 305,10" stroke="rgba(200,200,200,0.06)" fill="none" stroke-width="12"/>';
    // Terminal glow
    s+='<rect x="400" y="50" width="30" height="40" fill="rgba(5,8,15,0.9)" stroke="rgba(60,200,60,0.12)"/>';
    s+='<rect x="404" y="56" width="22" height="2" fill="rgba(60,200,60,0.15)"/>';
    s+='<rect x="404" y="62" width="16" height="2" fill="rgba(60,200,60,0.1)"/>';
    s+='<rect x="404" y="68" width="20" height="2" fill="rgba(60,200,60,0.08)"/>';
  } else if(type==='market') {
    // Market stalls
    for(let i=0;i<5;i++){const sx=30+i*115;
    s+='<rect x="'+sx+'" y="55" width="80" height="50" fill="rgba(14,14,18,0.95)" stroke="rgba(200,184,154,0.06)"/>';
    s+='<line x1="'+sx+'" y1="55" x2="'+(sx+80)+'" y2="55" stroke="rgba(200,184,154,0.1)"/>';
    s+='<text x="'+(sx+40)+'" y="84" text-anchor="middle" font-family="monospace" font-size="5" fill="rgba(200,184,154,0.12)" letter-spacing="1">Ø '+(5+i*12)+'</text>';}
    // Crowd silhouettes
    for(let i=0;i<12;i++){const cx=50+i*45+Math.sin(i)*15,cy=95;
    s+='<ellipse cx="'+cx+'" cy="'+cy+'" rx="5" ry="10" fill="rgba(40,40,44,0.4)"/>';
    s+='<circle cx="'+cx+'" cy="'+(cy-13)+'" r="4" fill="rgba(40,40,44,0.4)"/>';}
  } else if(type==='dark') {
    // Near-darkness with faint shapes
    s+='<rect x="0" y="0" width="'+w+'" height="'+h+'" fill="rgba(3,3,5,0.98)"/>';
    s+='<circle cx="300" cy="70" r="60" fill="rgba(200,184,154,0.01)"/>';
    s+='<circle cx="300" cy="70" r="30" fill="rgba(200,184,154,0.015)"/>';
    // Distant faint figure
    s+='<ellipse cx="300" cy="90" rx="4" ry="10" fill="rgba(200,184,154,0.04)"/>';
    s+='<circle cx="300" cy="78" r="3" fill="rgba(200,184,154,0.04)"/>';
    // Faint eyes
    s+='<rect x="298" y="76" width="1.5" height="1" fill="rgba(200,184,154,0.12)"/>';
    s+='<rect x="301" y="76" width="1.5" height="1" fill="rgba(200,184,154,0.12)"/>';
  } else if(type==='cathedral') {
    // Grand interior — high arches
    s+='<rect x="0" y="0" width="'+w+'" height="'+h+'" fill="rgba(8,8,12,0.98)"/>';
    s+='<path d="M100,105 L100,30 Q300,-20 500,30 L500,105" fill="none" stroke="rgba(200,184,154,0.06)" stroke-width="2"/>';
    s+='<path d="M150,105 L150,40 Q300,0 450,40 L450,105" fill="none" stroke="rgba(200,184,154,0.04)" stroke-width="1"/>';
    // Stained glass suggestion
    s+='<circle cx="300" cy="25" r="18" fill="none" stroke="rgba(60,120,220,0.08)" stroke-width="1"/>';
    s+='<circle cx="300" cy="25" r="12" fill="rgba(60,120,220,0.02)"/>';
    // Candle glow
    for(let i=0;i<5;i++){s+='<circle cx="'+(200+i*50)+'" cy="95" r="2" fill="rgba(200,180,140,0.15)"/>';
    s+='<circle cx="'+(200+i*50)+'" cy="95" r="8" fill="rgba(200,180,140,0.02)"/>';}
  } else if(type==='rooftop') {
    s+='<rect x="0" y="0" width="'+w+'" height="60" fill="rgba(4,4,8,1)"/>';
    // Stars
    for(let i=0;i<20;i++){s+='<circle cx="'+(Math.sin(i*7)*280+300)+'" cy="'+(5+Math.sin(i*3)*25+15)+'" r="0.5" fill="rgba(200,200,220,'+(0.1+Math.sin(i)*0.1).toFixed(2)+')"/>';}
    s+='<rect x="0" y="60" width="'+w+'" height="45" fill="rgba(15,15,18,1)"/>';
    // Roof edge
    s+='<line x1="0" y1="62" x2="'+w+'" y2="62" stroke="rgba(200,184,154,0.08)" stroke-width="1"/>';
    // Distant city glow
    for(let i=0;i<10;i++){const bx=i*65,bh=10+Math.sin(i*4)*8;
    s+='<rect x="'+bx+'" y="'+(60-bh)+'" width="45" height="'+bh+'" fill="rgba(15,15,20,0.8)"/>';}
    s+='<ellipse cx="300" cy="60" rx="250" ry="15" fill="rgba(200,180,140,0.015)"/>';
  } else if(type==='gate') {
    // Perimeter gate
    s+='<rect x="0" y="0" width="'+w+'" height="'+h+'" fill="rgba(4,4,6,0.98)"/>';
    // Fence
    for(let i=0;i<20;i++){s+='<line x1="'+(i*32)+'" y1="30" x2="'+(i*32)+'" y2="105" stroke="rgba(80,75,65,0.2)" stroke-width="1.5"/>';}
    s+='<line x1="0" y1="32" x2="'+w+'" y2="32" stroke="rgba(80,75,65,0.15)" stroke-width="2"/>';
    s+='<line x1="0" y1="65" x2="'+w+'" y2="65" stroke="rgba(80,75,65,0.12)" stroke-width="1"/>';
    // Cut section
    s+='<line x1="280" y1="30" x2="280" y2="105" stroke="rgba(200,60,60,0.15)" stroke-width="2" stroke-dasharray="4,6"/>';
    s+='<line x1="312" y1="30" x2="312" y2="105" stroke="rgba(200,60,60,0.15)" stroke-width="2" stroke-dasharray="4,6"/>';
    // Warning sign
    s+='<rect x="260" y="10" width="80" height="16" fill="rgba(140,30,30,0.15)"/>';
    s+='<text x="300" y="21" text-anchor="middle" font-family="monospace" font-size="6" fill="rgba(200,60,60,0.4)" letter-spacing="2">RESTRICTED</text>';
  } else if(type==='dome') {
    // Under the dome
    s+='<path d="M0,105 Q300,-40 600,105" fill="none" stroke="rgba(200,184,154,0.04)" stroke-width="1"/>';
    s+='<path d="M50,105 Q300,-20 550,105" fill="none" stroke="rgba(200,184,154,0.03)" stroke-width="0.5"/>';
    // Rain suggestion
    for(let i=0;i<30;i++){const rx=i*20+Math.sin(i)*5,ry=20+Math.sin(i*3)*30;
    s+='<line x1="'+rx+'" y1="'+ry+'" x2="'+(rx+1)+'" y2="'+(ry+8)+'" stroke="rgba(150,160,180,0.06)" stroke-width="0.5"/>';}
  } else {
    // Fallback: empty dark scene
    s+='<rect x="0" y="0" width="'+w+'" height="'+h+'" fill="rgba(4,4,6,0.95)"/>';
    s+='<circle cx="300" cy="60" r="40" fill="rgba(200,184,154,0.01)"/>';
  }
  s+='</svg>';
  return s;
}

// ================================================================
// WALK THE CITY — Expanded Scene Tree (25+ scenes)
// ================================================================
const WALK_SCENES = {
  start: {
    art: 'street',
    text: 'The streets of Smilemore stretch before you. Neon compliance signs flicker overhead. Your MoodSwing bracelet hums against your wrist — a cold ring of authority wrapped around your pulse. The air smells of ozone and synthetic contentment. Two paths diverge at the intersection: the lit boulevard curves east toward the Central District, and a narrow alley descends west into shadow.',
    prompt: 'Which way do you walk?',
    choices: [
      {text: 'Take the lit boulevard — stay visible, stay compliant', tag: '+LUX', next: 'boulevard', lux: 6},
      {text: 'Slip into the shadowed alley — avoid the patrol drones', tag: '+NOX', next: 'alley', nox: 6},
    ]
  },
  boulevard: {
    art: 'officer',
    text: 'The boulevard is immaculate. Citizens walk in measured steps, their masks gleaming white under regulation lighting. A public compliance screen displays today\'s emotion quota: CONTENTMENT 78%, JOY 12%, OTHER 10%. A Smilemore officer approaches — they\'ve noticed your bracelet readings are irregular. Their hand rests on a neural dampener.',
    prompt: 'How do you respond?',
    choices: [
      {text: 'Submit to a voluntary scan — transparency is safety', tag: '+LUX', next: 'scan', lux: 8},
      {text: 'Flash your compliance badge and keep walking', tag: 'NEUTRAL', next: 'badge', lux: 3, nox: 3},
      {text: 'Turn sharply into a side corridor before they reach you', tag: '+NOX', next: 'corridor', nox: 8},
    ]
  },
  alley: {
    art: 'alley',
    text: 'The alley narrows. Graffiti covers the walls — "FEEL NOTHING, FEAR NOTHING" scratched in crude letters beside a faded Ø symbol. You pass a figure hunched in a doorway, their mask cracked down the center, one eye visible beneath the fracture line. They whisper: "The Order took my daughter\'s laughter. Classified it as contraband." They hold out a small object wrapped in dirty cloth.',
    prompt: 'What do you do?',
    choices: [
      {text: 'Accept the wrapped object — someone needs you to carry it', tag: '+NOX', next: 'accept_object', nox: 8},
      {text: 'Report the figure to the nearest compliance terminal', tag: '+LUX', next: 'report', lux: 8},
      {text: 'Sit with them in silence — sometimes presence is enough', tag: 'NEUTRAL', next: 'silence', lux: 2, nox: 4},
    ]
  },
  scan: {
    art: 'officer',
    text: 'The officer\'s scanner passes over your temples. Readings flash across their visor in cool blue lines. "Elevated Nox signatures detected," they murmur. "Nothing actionable. You\'re free to go." As you walk away, you notice they\'ve tagged your file — a small amber dot now blinks on your citizen record. Ahead, the Central Registry building looms, its columned entrance bathed in institutional light.',
    prompt: 'The Registry doors stand open.',
    choices: [
      {text: 'Enter the Registry — knowledge is power, even theirs', tag: '+LUX', next: 'registry', lux: 8},
      {text: 'Walk past — you\'ve been scanned enough today', tag: '+NOX', next: 'market_district', nox: 6},
    ]
  },
  badge: {
    art: 'street',
    text: 'The officer hesitates. Your compliance badge glows steady — unremarkable. They nod and move on, but you feel the weight of their gaze long after. Further down the boulevard, a child drops a small paper crane on the pavement. No one stops. Paper folding was removed from the approved activities list in Directive 14. The crane sits there, white angles against gray stone.',
    prompt: 'The crane sits on the pavement.',
    choices: [
      {text: 'Pick it up and pocket it — a small rebellion', tag: '+NOX', next: 'crane_pocket', nox: 6},
      {text: 'Leave it — attachment to objects breeds unregulated sentiment', tag: '+LUX', next: 'leave_crane', lux: 6},
    ]
  },
  corridor: {
    art: 'pipes',
    text: 'You lose the officer in a maze of maintenance corridors. Steam hisses from overhead pipes. Down here, the city\'s infrastructure is exposed — emotion concentrate pipes, neural monitoring cables, the mechanical organs of a system that feels nothing but demands feeling from everyone. You find a junction box with a loose panel. A green terminal blinks inside.',
    prompt: 'A maintenance terminal pulses.',
    choices: [
      {text: 'Access the terminal — see what data flows through these veins', tag: '+NOX', next: 'terminal', nox: 8},
      {text: 'Seal the panel and move on — ignorance is compliance', tag: '+LUX', next: 'seal', lux: 6},
    ]
  },
  accept_object: {
    art: 'dark',
    text: 'You take the cloth bundle. Inside: a vial of something iridescent — raw, unprocessed emotion. Not synthetic. Real. The figure watches you with their one visible eye. "Take the back routes," they whisper. "Through the old cathedral. The Order sealed it after the Directive, but the locks are rusted."',
    prompt: 'The vial pulses with warmth.',
    choices: [
      {text: 'Head for the old cathedral — follow their directions', tag: '+NOX', next: 'cathedral', nox: 8},
      {text: 'Take the vial but stay on main roads — too risky underground', tag: 'NEUTRAL', next: 'vial_mainroad', nox: 4, lux: 2},
    ]
  },
  report: {
    art: 'officer',
    text: 'The compliance terminal accepts your report. CITIZEN COOPERATION NOTED. Your record gains a silver commendation marker. As you leave, two enforcement drones converge on the alley. The figure will be processed. Their cracked mask replaced. Their unauthorized memories flagged for review. A Smilemore banner overhead reads: "Your Vigilance Is Our Stability."',
    prompt: 'The boulevard widens ahead.',
    choices: [
      {text: 'Continue toward the Central Registry — full compliance, full clearance', tag: '+LUX', next: 'registry', lux: 8},
      {text: 'Stop and watch the drones work — something feels wrong', tag: '+NOX', next: 'drone_watch', nox: 6},
    ]
  },
  silence: {
    art: 'dark',
    text: 'You sit. Minutes pass. The figure\'s breathing steadies. They pull back their cloth to reveal a face lined with years of suppressed feeling. "Thank you," they say. "No one sits anymore." They reach into their coat and place something in your hand — a small disc, warm, humming faintly. Pre-Smilemore technology. "Take the underpass to the cathedral," they say. "There are others."',
    prompt: 'The disc hums against your palm.',
    choices: [
      {text: 'Head underground toward the cathedral', tag: '+NOX', next: 'cathedral', nox: 6},
      {text: 'Turn the disc over to the Registry — it\'s safer in their hands', tag: '+LUX', next: 'registry_disc', lux: 8},
    ]
  },
  registry: {
    art: 'registry',
    text: 'Inside the Central Registry, rows of citizen files stretch floor to ceiling. The air is cool, antiseptic. Your own file is here — Section 7, Drawer 4412. You find it. Mostly redacted in black ink. But one line is visible: "SUBJECT DEMONSTRATES ANOMALOUS COMPLIANCE PATTERNS. RECOMMEND: ELEVATED MONITORING." There is a supervisor\'s desk nearby. A promotion application form sits in the tray.',
    prompt: 'Your file is in your hands.',
    choices: [
      {text: 'File the promotion application — rise within the system', tag: '+LUX', next: 'promotion', lux: 10},
      {text: 'Pocket your file and leave — they don\'t get to define you', tag: '+NOX', next: 'pocket_file', nox: 8},
      {text: 'Read more files — see what they know about others', tag: 'NEUTRAL', next: 'other_files', lux: 4, nox: 4},
    ]
  },
  registry_disc: {
    art: 'registry',
    text: 'You hand the disc to a Registry clerk. They examine it with barely concealed interest. "Pre-Directive technology. This is valuable intelligence." They stamp your file with a gold commendation. "The Order rewards compliance," they say. "Have you considered a position in the Monitoring Division?"',
    prompt: 'An opportunity presents itself.',
    choices: [
      {text: 'Accept the interview — serve the system from within', tag: '+LUX', next: 'promotion', lux: 10},
      {text: 'Decline and leave — you\'ve done enough for one day', tag: 'NEUTRAL', next: 'leave_registry', lux: 4},
    ]
  },
  promotion: {
    art: 'registry',
    text: 'The supervisor reviews your application. "Exemplary record. Silver commendations. Voluntary scans." They stamp APPROVED. You are now Level 3 Registry Personnel. A new mask awaits you — whiter, brighter, with a small blue insignia at the temple. As they hand it to you, you notice the old one felt lighter. This one carries weight.',
    prompt: 'The new mask gleams.',
    choices: [
      {text: 'Wear it proudly — you earned this', tag: '+LUX', next: 'patrol', lux: 10},
      {text: 'Accept it but feel the weight — is this who you are?', tag: 'NEUTRAL', next: 'end_compliant', lux: 6},
    ]
  },
  patrol: {
    art: 'street',
    text: 'Your first patrol. You walk the boulevard now with authority. Citizens step aside. Your scanner pings at every irregular reading. You pass the spot where the child dropped the paper crane. It\'s gone now — swept by automated cleaners. Ahead, an old woman sits on a bench. Her bracelet readings are flatlined. Not dead — just... empty. The system says she\'s compliant. But her eyes say something else.',
    prompt: 'Your scanner shows no violation.',
    choices: [
      {text: 'Log her as compliant and move on — the system is correct', tag: '+LUX', next: 'end_pure_lux', lux: 12},
      {text: 'Sit beside her, just for a moment — off the record', tag: '+NOX', next: 'end_doubt_lux', lux: 4, nox: 6},
    ]
  },
  pocket_file: {
    art: 'pipes',
    text: 'You slide the file into your coat. Your heart is pounding — the first unauthorized act of your entire registered life. The corridors blur as you walk fast, then faster. You find yourself in the maintenance level, pipes groaning overhead. Your bracelet chirps a warning: ELEVATED HEART RATE DETECTED. You tear it off and drop it in a drainage grate.',
    prompt: 'The bracelet sinks into darkness.',
    choices: [
      {text: 'Keep going deeper — find the others the figure mentioned', tag: '+NOX', next: 'cathedral', nox: 10},
      {text: 'Retrieve the bracelet — you went too far', tag: '+LUX', next: 'end_retreat', lux: 6},
    ]
  },
  other_files: {
    art: 'registry',
    text: 'You pull more drawers. Hundreds of files, thousands. Each one a person reduced to metrics. EMOTIONAL COMPLIANCE RATING. LOYALTY INDEX. One file catches your eye — it belongs to the cracked-mask figure from the alley. Their name was Mira. They were a teacher before the Directive. Their file says: "RECOMMEND: FULL ERASURE." You\'re holding someone\'s death sentence.',
    prompt: 'Mira\'s file trembles in your grip.',
    choices: [
      {text: 'Destroy the file — they can\'t erase someone with no record', tag: '+NOX', next: 'destroy_file', nox: 10},
      {text: 'Return it to the drawer — you can\'t save everyone', tag: '+LUX', next: 'end_compliant', lux: 6},
    ]
  },
  destroy_file: {
    art: 'dark',
    text: 'You tear the pages. The ink smears across your fingers like guilt — or maybe like freedom. An alarm begins to pulse, red lights cycling in the corridor. You run. Down stairs, through maintenance tunnels, past humming pipes, until you emerge in the old quarter. The cathedral spire rises in the distance, dark against the domed sky.',
    prompt: 'The alarm fades behind you.',
    choices: [
      {text: 'Head for the cathedral — find sanctuary', tag: '+NOX', next: 'cathedral', nox: 8},
    ]
  },
  cathedral: {
    art: 'cathedral',
    text: 'The cathedral is vast and abandoned. Pews overturned, stained glass panels dark except where moonlight from the dome filters through cracks. But it\'s not empty. In the chancel, a dozen figures sit in a circle, masks removed. Their faces are bare — scarred, lined, alive. They look at you without fear. One of them stands. "You found us," she says. "The question is: what did you bring?"',
    prompt: 'The circle watches you.',
    choices: [
      {text: 'Show the vial — "Raw emotion. Unprocessed."', tag: '+NOX', next: 'share_vial', nox: 8},
      {text: '"I brought nothing but myself."', tag: 'NEUTRAL', next: 'just_self', nox: 5, lux: 2},
    ]
  },
  share_vial: {
    art: 'dark',
    text: 'They pass the vial around the circle. Each person inhales once. Some weep. Some laugh. One man presses his palm to his chest like he\'s remembering what his heart is for. "This is what they took from us," the woman says. "Not happiness. Not sadness. The right to choose which one to feel." She turns to you. "There\'s a way through the perimeter. Beyond the gate, the dome ends. Real sky. Real rain."',
    prompt: 'The perimeter is close.',
    choices: [
      {text: 'Go to the gate — leave Smilemore forever', tag: '+NOX', next: 'gate', nox: 10},
      {text: 'Stay with the group — build something here, from the inside', tag: 'NEUTRAL', next: 'end_deep_nox', nox: 6},
    ]
  },
  just_self: {
    art: 'cathedral',
    text: 'The woman studies you. "That\'s enough," she says. "More than most bring." They make room in the circle. No questions. No scans. No compliance ratings. Just people, breathing together in the dark. For the first time since you entered Smilemore, your bracelet — if you still have it — goes silent. Not broken. Just... irrelevant.',
    prompt: 'The circle holds you.',
    choices: [
      {text: 'Remove your mask — show them who you are', tag: '+NOX', next: 'end_deep_nox', nox: 10},
      {text: 'Keep your mask on — you\'re not ready yet', tag: 'NEUTRAL', next: 'end_balanced', nox: 4, lux: 4},
    ]
  },
  gate: {
    art: 'gate',
    text: 'The perimeter fence stretches into the dark. Razor wire glints above. Warning signs flash: RESTRICTED ZONE — EMOTIONAL CONTAMINATION RISK. Beyond the fence, you can see it — the dome\'s edge, where the artificial sky cracks into real darkness. Real stars. Real cold. You hear the woman\'s voice behind you: "Once you go through, the system marks you dead. No file. No record. No name."',
    prompt: 'The fence hums with current.',
    choices: [
      {text: 'Step through — die to Smilemore, live for yourself', tag: '+NOX', next: 'end_pure_nox', nox: 12},
      {text: 'Turn back — you\'re not ready to disappear', tag: 'NEUTRAL', next: 'end_deep_nox', nox: 4},
    ]
  },
  terminal: {
    art: 'pipes',
    text: 'The data scrolls past in green phosphor lines. Emotion distribution routes. Surveillance schedules. A file labeled "PROJECT WONDRIX: PHASE 2." And deeper still — schematics for something called the Bleach Protocol. A mass emotional reset. Every citizen. Every memory. Scheduled for implementation in 30 days. You download what you can before the terminal locks you out.',
    prompt: 'Alarms may be pinging.',
    choices: [
      {text: 'Take the data underground — the resistance needs to see this', tag: '+NOX', next: 'cathedral', nox: 10},
      {text: 'Report what you found to the Registry — they need to know', tag: '+LUX', next: 'report_bleach', lux: 8},
    ]
  },
  seal: {
    art: 'street',
    text: 'You close the panel. The corridor returns to silence. You emerge near the market district, where emotion vendors call out today\'s specials from clean white kiosks. "CONTENTMENT — 12 Nulls! JOY — Limited Supply!" The market hums with regulated commerce. A compliance recruiter spots you and approaches with a warm, regulation smile.',
    prompt: 'They hand you a pamphlet.',
    choices: [
      {text: 'Accept it — "Monitoring Division: Protect What Matters"', tag: '+LUX', next: 'recruiter', lux: 8},
      {text: 'Decline and browse the market — just passing through', tag: 'NEUTRAL', next: 'market_browse', lux: 3, nox: 3},
    ]
  },
  recruiter: {
    art: 'officer',
    text: 'The recruiter walks beside you. "You have the right profile," they say. "High compliance. Steady readings. The Division needs people like you. People who understand that structure isn\'t oppression — it\'s protection." They hand you a keycard. "Level 2 access. The Central Registry. Consider it a trial run."',
    prompt: 'The keycard is cool in your hand.',
    choices: [
      {text: 'Accept the keycard — serve from within', tag: '+LUX', next: 'registry', lux: 8},
      {text: 'Pocket the card and walk away — you\'ll decide later', tag: 'NEUTRAL', next: 'rooftop', lux: 3, nox: 3},
    ]
  },
  crane_pocket: {
    art: 'street',
    text: 'The crane is fragile in your pocket. You walk three blocks before ducking into a doorway to examine it. Inside the folds, someone has written in tiny letters: "CATHEDRAL. MIDNIGHT. MASKS OFF." It\'s not a toy. It\'s a map. An invitation. Something forbidden and alive.',
    prompt: 'The writing is faint but clear.',
    choices: [
      {text: 'Follow the instructions — go to the cathedral at midnight', tag: '+NOX', next: 'cathedral', nox: 8},
      {text: 'Destroy the crane — this is too dangerous', tag: '+LUX', next: 'leave_crane', lux: 6},
    ]
  },
  leave_crane: {
    art: 'street',
    text: 'You step over the crane. Three blocks later you stop. You can still see it in your mind — white angles, folded with intention. The compliance screen overhead cycles to a new message: "ATTACHMENT IS RISK. DETACHMENT IS STRENGTH." You believe it. The market district gleams ahead.',
    prompt: 'The boulevard continues.',
    choices: [
      {text: 'Head to the market — normalcy feels right', tag: '+LUX', next: 'market_browse', lux: 6},
      {text: 'Go back for the crane — you can\'t leave it', tag: '+NOX', next: 'crane_pocket', nox: 8},
    ]
  },
  market_district: {
    art: 'market',
    text: 'The market district pulses with regulated activity. Emotion kiosks line the streets. A vendor demonstrates a new MoodSwing cartridge — "Premium Focus, 35% more clarity than standard issue." Citizens queue in orderly lines. Above it all, a billboard: "SMILEMORE: 847 DAYS WITHOUT AN EMOTIONAL INCIDENT." Someone has scratched a question mark after the number.',
    prompt: 'The crowd flows around you.',
    choices: [
      {text: 'Join the queue — purchase some standard Contentment', tag: '+LUX', next: 'market_buy', lux: 6},
      {text: 'Follow the scratched question mark — who would dare?', tag: '+NOX', next: 'question_mark', nox: 8},
    ]
  },
  market_buy: {
    art: 'market',
    text: 'You purchase a vial of Contentment. Standard dose. The vendor scans your bracelet and smiles — a regulation smile, measured to the millimeter. "Thank you for your patronage." The contentment spreads warm and flat, like lukewarm water. Not unpleasant. Not anything, really. A woman beside you is buying her sixth dose today. Her eyes are glassy, her smile permanent.',
    prompt: 'The warmth spreads.',
    choices: [
      {text: 'Buy another dose — the numbness is comfortable', tag: '+LUX', next: 'end_pure_lux', lux: 10},
      {text: 'Stop. Look at the woman. See what this does.', tag: '+NOX', next: 'rooftop', nox: 8},
    ]
  },
  market_browse: {
    art: 'market',
    text: 'You wander the stalls. One vendor sells contraband detectors. Another offers "Loyalty Enhancement Supplements." At the far end, almost hidden, a stall with no sign. The vendor wears a mask that\'s slightly off-regulation — too dark, too angular. They catch your eye and slide something across the counter: a blank keycard.',
    prompt: 'The vendor watches you.',
    choices: [
      {text: 'Take the keycard — ask no questions', tag: '+NOX', next: 'blank_keycard', nox: 8},
      {text: 'Report the irregular vendor to market security', tag: '+LUX', next: 'report_vendor', lux: 8},
    ]
  },
  blank_keycard: {
    art: 'dark',
    text: '"Back alley, thirty paces, red door," the vendor whispers. You follow the directions. The red door leads down. Down into the old infrastructure, where the city\'s bones are exposed. At the bottom, a room. On the wall, a map — every surveillance blind spot in Smilemore, marked in phosphorescent paint. Someone has been planning something.',
    prompt: 'The map glows in the dark.',
    choices: [
      {text: 'Study the map — memorize the blind spots', tag: '+NOX', next: 'cathedral', nox: 8},
      {text: 'Photograph it and leave — this is bigger than you', tag: 'NEUTRAL', next: 'rooftop', nox: 4, lux: 2},
    ]
  },
  report_vendor: {
    art: 'officer',
    text: 'Security arrives within minutes. The irregular vendor is detained. They don\'t resist. As they\'re led away, they look at you — not with anger, but with something worse. Pity. "You\'ll understand eventually," they say. Security stamps your record: EXEMPLARY MARKET VIGILANCE. The stall is dismantled. In its place, a standard Contentment kiosk.',
    prompt: 'The boulevard is cleaner now.',
    choices: [
      {text: 'Return to the Central Registry — apply for advancement', tag: '+LUX', next: 'promotion', lux: 8},
      {text: 'Go home and think about what they said', tag: 'NEUTRAL', next: 'rooftop', lux: 3, nox: 5},
    ]
  },
  report_bleach: {
    art: 'registry',
    text: 'You bring the data to the Registry. A senior official reviews it behind closed doors. When they emerge, their face is unreadable. "You\'ve done the right thing," they say. "The Bleach Protocol is a safety measure. Emotional overgrowth threatens civic stability. This reset will help everyone." They promote you on the spot. Level 4. Gold commendation. But their eyes... their eyes don\'t match their words.',
    prompt: 'The promotion papers are signed.',
    choices: [
      {text: 'Accept the promotion — trust the system', tag: '+LUX', next: 'patrol', lux: 10},
      {text: 'Refuse — something is deeply wrong here', tag: '+NOX', next: 'pocket_file', nox: 10},
    ]
  },
  question_mark: {
    art: 'alley',
    text: 'You trace the scratch marks. They lead to a service alley behind the billboard. More scratches on the wall — a trail of Ø symbols, each one slightly different. Not the currency. Something older. They lead to a basement entrance sealed with a rusted chain. The chain has been cut recently.',
    prompt: 'Darkness waits below.',
    choices: [
      {text: 'Descend into the basement', tag: '+NOX', next: 'cathedral', nox: 8},
      {text: 'This is too dangerous — return to the market', tag: '+LUX', next: 'market_buy', lux: 6},
    ]
  },
  rooftop: {
    art: 'rooftop',
    text: 'You climb to the rooftop of an old residential block. From here, you can see the entire dome — the artificial sky, the regulated lighting cycles, the grid of sectors stretching to the perimeter. Somewhere below, people queue for emotions they used to feel for free. Somewhere deeper, others sit in circles with their masks off. The city hums. It doesn\'t care about your choice. It will keep humming regardless.',
    prompt: 'The dome stretches above you.',
    choices: [
      {text: 'Descend toward the cathedral — you\'ve seen enough from above', tag: '+NOX', next: 'cathedral', nox: 6},
      {text: 'Descend toward the Registry — the view clarified things', tag: '+LUX', next: 'registry', lux: 6},
    ]
  },
  drone_watch: {
    art: 'alley',
    text: 'You watch the drones process the cracked-mask figure. They don\'t resist. The enforcement protocol is efficient: scan, sedate, transport. Three minutes. The alley is empty again, as if nothing happened. A maintenance drone scrubs the graffiti. Your silver commendation pulses on your record. It feels heavier now.',
    prompt: 'The alley is clean.',
    choices: [
      {text: 'Walk to the market — distract yourself', tag: 'NEUTRAL', next: 'market_district', lux: 4, nox: 2},
      {text: 'Follow the enforcement transport — where do they take people?', tag: '+NOX', next: 'follow_transport', nox: 8},
    ]
  },
  follow_transport: {
    art: 'pipes',
    text: 'The transport descends into Sub-Level 3. You follow at a distance. The corridors down here are unmarked, unmonitored — a blind spot in the surveillance grid. The transport stops at a heavy door labeled "RECONDITIONING — AUTHORIZED PERSONNEL ONLY." Through a window, you see rows of chairs. People strapped in. Machines humming. Their masks being replaced, their eyes being emptied.',
    prompt: 'The machines hum.',
    choices: [
      {text: 'Turn away — find the cathedral, find the resistance', tag: '+NOX', next: 'cathedral', nox: 10},
      {text: 'Report what you saw to the Registry — this must be illegal, even here', tag: '+LUX', next: 'report_bleach', lux: 8},
    ]
  },
  vial_mainroad: {
    art: 'street',
    text: 'You take the main road with the vial concealed in your coat. Every compliance screen you pass makes your pulse jump. Your bracelet chirps: ANXIETY LEVELS ELEVATED. A patrol drone circles overhead, its scanner beam sweeping the crowd. You need to get off this road.',
    prompt: 'The drone circles closer.',
    choices: [
      {text: 'Duck into the market district — hide in the crowd', tag: 'NEUTRAL', next: 'market_district', nox: 4, lux: 2},
      {text: 'Head underground — find the maintenance tunnels', tag: '+NOX', next: 'terminal', nox: 6},
    ]
  },
  leave_registry: {
    art: 'street',
    text: 'You leave the Registry. The boulevard stretches out, clean and ordered. You did the right thing. The disc is in their hands now. Whatever was on it, it\'s their problem. The compliance screen cycles to evening mode: "REMEMBER: TOMORROW IS ALWAYS BETTER WHEN REGULATED." You believe it. Mostly.',
    prompt: 'Evening falls.',
    choices: [
      {text: 'Go home — rest, comply, repeat', tag: '+LUX', next: 'end_compliant', lux: 8},
      {text: 'Take a detour through the old quarter — just to see', tag: '+NOX', next: 'rooftop', nox: 6},
    ]
  },

  // === ENDINGS ===
  end_pure_lux: { art: 'registry', text: 'You are Level 4 Registry Personnel. Gold commendation. Perfect compliance. Your new mask gleams brighter than anyone\'s in Sector 9. You patrol the boulevard and citizens step aside with respect. Your file is clean. Your emotions are regulated. Your purpose is clear. The system works. You are proof. And somewhere deep in the structure of that belief, in the foundation no one examines, something very small and very old has stopped breathing. But you don\'t feel it. That\'s the point.', prompt: '', choices: [], ending: 'deep_lux' },
  end_pure_nox: { art: 'gate', text: 'You step through the cut fence. The dome\'s edge passes over you like a membrane — warm to cold, synthetic to real. The sky above is vast and dark and full of stars no one in Smilemore has seen in decades. Rain touches your face. Real rain. It\'s cold and imperfect and it doesn\'t care about your compliance rating. You pull off your mask. The wind takes it. Behind you, Smilemore hums on, a bright wound in the landscape. Ahead, the dark stretches out, full of everything the Order classified as dangerous. Full of everything that matters.', prompt: '', choices: [], ending: 'deep_nox' },
  end_deep_nox: { art: 'dark', text: 'The cathedral holds you. Masks off, faces bare, the circle breathes together in the dark. You are not registered here. You are not monitored. You are not compliant. You are, for the first time, something the system has no category for: free. It\'s terrifying. It\'s everything.', prompt: '', choices: [], ending: 'deep_nox' },
  end_deep_lux: { art: 'registry', text: 'Your record gleams with commendations. The system trusts you completely. You trust it back. And in that mutual trust, in that perfect loop of compliance and reward, there is a kind of peace. Not joy — joy is expensive. Not freedom — freedom is unregulated. Peace. Measured, monitored, and entirely sufficient. The Order provides.', prompt: '', choices: [], ending: 'deep_lux' },
  end_compliant: { art: 'street', text: 'You go home. The apartment is regulation-standard. The lighting adjusts to evening cycle. Your bracelet reports: ALL READINGS NOMINAL. Tomorrow you will walk the same boulevard, pass the same screens, feel the same measured contentment. It is enough. The Order says it is enough. And you have learned not to ask whether enough is the same as good.', prompt: '', choices: [], ending: 'lux' },
  end_balanced: { art: 'rooftop', text: 'From the rooftop, both paths are visible — the gleaming boulevard and the shadowed alley, the Registry\'s columns and the cathedral\'s broken spire. Neither is honest. Neither is complete. You stand between them, and for now, that\'s enough. The dome arches overhead, and somewhere beyond it, real stars are burning.', prompt: '', choices: [], ending: 'balanced' },
  end_doubt_lux: { art: 'street', text: 'You sit beside the old woman on the bench. Her eyes are empty of everything the system measures. But when you sit down, something flickers there — not an emotion, exactly. Recognition. Someone chose to be here. Someone chose to see. Your scanner stays in your pocket. The system will log this as a break in patrol. You don\'t care. For thirty seconds, you are not an officer. You are a person. It\'s enough. It has to be.', prompt: '', choices: [], ending: 'balanced' },
  end_retreat: { art: 'street', text: 'You fish the bracelet from the grate. Your hands shake as you clasp it back on. RECONNECTING... READINGS RESUMED. The walk home is long and quiet. You still have the file in your coat. You\'ll return it tomorrow. Or maybe you won\'t. The question sits in your pocket alongside the redacted pages, and neither one has an answer.', prompt: '', choices: [], ending: 'balanced' },
};

let walkLux = 0, walkNox = 0;

function startWalkTheCity() {
  walkLux = G.lux; walkNox = G.nox;
  renderWalkScene('start');
}

function renderWalkScene(sceneId) {
  const scene = WALK_SCENES[sceneId];
  if(!scene) return;
  const el = document.getElementById('walkInner');

  if(scene.ending) {
    // Final alignment push based on ending type
    if(scene.ending === 'deep_lux') { G.lux = Math.min(100, G.lux + 8); G.nox = 100 - G.lux; }
    else if(scene.ending === 'deep_nox') { G.nox = Math.min(100, G.nox + 8); G.lux = 100 - G.nox; }
    else if(scene.ending === 'lux') { G.lux = Math.min(100, G.lux + 4); G.nox = 100 - G.lux; }
    else if(scene.ending === 'nox') { G.nox = Math.min(100, G.nox + 4); G.lux = 100 - G.nox; }
    // Redraw character with final alignment
    if(G.charGenerated) drawCharacter(G.lux, G.nox, seededRand(G.lux * 1337 + G.nox * 31));

    let itemHTML = '';
    const totalLux = Math.min(100, walkLux);
    const totalNox = Math.min(100, walkNox);

    if(totalLux >= 100 && !hasItem('code_lux')) {
      addToInventory('item', {id:'code_lux', name:'Lumen Cipher', icon:'◈'});
      itemHTML += '<div class="walk-item-reveal" style="border-color:rgba(60,120,220,0.3);color:rgba(100,160,255,0.7);">ITEM ACQUIRED: LUMEN CIPHER</div><div class="walk-item-reveal" style="margin-top:6px;border-color:rgba(60,120,220,0.3);color:rgba(100,160,255,0.7);">LX-LUMEN-8BP</div>';
    }
    if(totalNox >= 100 && !hasItem('code_nox')) {
      addToInventory('item', {id:'code_nox', name:'Umbra Cipher', icon:'◆'});
      itemHTML += '<div class="walk-item-reveal" style="border-color:rgba(200,60,60,0.3);color:rgba(220,80,80,0.7);">ITEM ACQUIRED: UMBRA CIPHER</div><div class="walk-item-reveal" style="margin-top:6px;border-color:rgba(200,60,60,0.3);color:rgba(220,80,80,0.7);">NX-UMBRA-4KF</div>';
    }

    el.innerHTML = '<div class="walk-header"><div class="walk-title">Walk the City</div><div class="walk-alignment">Final Reading · <span class="lux-val">LUX ' + Math.round(G.lux) + '%</span> · <span class="nox-val">NOX ' + Math.round(G.nox) + '%</span></div></div>' +
      '<div class="walk-meter"><div class="walk-meter-label" style="color:rgba(100,160,255,0.4);">LUX</div><div class="walk-meter-bar"><div class="walk-meter-fill lux-fill" style="width:' + Math.round(G.lux) + '%"></div></div></div>' +
      '<div class="walk-meter"><div class="walk-meter-label" style="color:rgba(220,80,80,0.4);">NOX</div><div class="walk-meter-bar"><div class="walk-meter-fill nox-fill" style="width:' + Math.round(G.nox) + '%"></div></div></div>' +
      '<div class="walk-scene-art">' + walkArt(scene.art || 'dark') + '</div>' +
      '<div class="walk-result"><div class="walk-result-title">JOURNEY COMPLETE</div><div class="walk-result-desc">' + scene.text + '</div>' + itemHTML + '<button class="walk-again-btn" onclick="startWalkTheCity()">↻ Walk Again</button><button class="walk-again-btn" style="margin-left:8px;" onclick="navTo(\'map\')">◇ Return to Map</button></div>';
    return;
  }

  const luxPct = Math.round(G.lux);
  const noxPct = Math.round(G.nox);

  let choicesHTML = scene.choices.map((c, i) =>
    '<div class="walk-choice" onclick="walkChoose(\'' + c.next + '\',' + (c.lux||0) + ',' + (c.nox||0) + ')">' + c.text + '</div>'
  ).join('');

  el.innerHTML = '<div class="walk-header"><div class="walk-title">Walk the City</div><div class="walk-alignment"><span class="lux-val">LUX ' + luxPct + '%</span> · <span class="nox-val">NOX ' + noxPct + '%</span></div></div>' +
    '<div class="walk-meter"><div class="walk-meter-label" style="color:rgba(100,160,255,0.4);">LUX</div><div class="walk-meter-bar"><div class="walk-meter-fill lux-fill" style="width:' + luxPct + '%"></div></div></div>' +
    '<div class="walk-meter"><div class="walk-meter-label" style="color:rgba(220,80,80,0.4);">NOX</div><div class="walk-meter-bar"><div class="walk-meter-fill nox-fill" style="width:' + noxPct + '%"></div></div></div>' +
    '<div class="walk-scene-art">' + walkArt(scene.art || 'street') + '</div>' +
    '<div class="walk-scene"><div class="walk-narrative">' + scene.text + '</div>' +
    (scene.prompt ? '<div class="walk-prompt">' + scene.prompt + '</div>' : '') +
    '<div class="walk-choices">' + choicesHTML + '</div></div>';
}

function walkChoose(next, luxAdd, noxAdd) {
  walkLux = Math.min(100, walkLux + luxAdd);
  walkNox = Math.min(100, walkNox + noxAdd);
  // Update global alignment (shift by half walk gain)
  const luxShift = Math.round(luxAdd * 0.5);
  const noxShift = Math.round(noxAdd * 0.5);
  G.lux = Math.max(0, Math.min(100, G.lux + luxShift - noxShift));
  G.nox = 100 - G.lux;
  // Redraw character with new alignment
  if(G.charGenerated) {
    drawCharacter(G.lux, G.nox, seededRand(G.lux * 1337 + G.nox * 31));
  }
  initAudio(); playClick(550 + Math.random()*200, 0.06);
  renderWalkScene(next);
  document.getElementById('walkInner').scrollTo({top: 0, behavior: 'smooth'});
}



// ================================================================
// WONDRIX GAME — Survive The Twisted
// ================================================================
let wondrixGameId = null, wondrixKeys = {};

let wondrixAudioNodes = [];
function startWondrixAmbience() {
  if(!AC) return;
  stopMapAmbience(); stopMarketHum(); stopDeliriumAmbience(); if(typeof stopRuinbowAtmo==='function') stopRuinbowAtmo();
  ambienceGain.gain.setTargetAtTime(0.5, AC.currentTime, 0.5);
  // Low menacing drone
  const o = AC.createOscillator(); o.type = 'sawtooth'; o.frequency.value = 36;
  const g = AC.createGain(); g.gain.value = 0.03;
  const lp = AC.createBiquadFilter(); lp.type = 'lowpass'; lp.frequency.value = 100;
  o.connect(lp); lp.connect(g); g.connect(ambienceGain); o.start();
  wondrixAudioNodes.push(o, lp, g);
  // Heartbeat
  let hbTimer = setInterval(() => {
    if(!AC || G.currentScreen !== 'wondrix') { clearInterval(hbTimer); return; }
    const now = AC.currentTime;
    [0, 0.15].forEach(d => {
      const ob = AC.createOscillator(); ob.type = 'sine'; ob.frequency.value = 50;
      const gb = AC.createGain(); gb.gain.setValueAtTime(0, now+d);
      gb.gain.linearRampToValueAtTime(0.06, now+d+0.04);
      gb.gain.exponentialRampToValueAtTime(0.001, now+d+0.25);
      ob.connect(gb); gb.connect(sfxGain); ob.start(now+d); ob.stop(now+d+0.3);
    });
  }, 1200);
}
function stopWondrixAmbience() {
  wondrixAudioNodes.forEach(n => { try { n.stop && n.stop(); n.disconnect && n.disconnect(); } catch(e) {} });
  wondrixAudioNodes = [];
}

function startWondrixGame() {
  const canvas = document.getElementById('wondrixCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  document.getElementById('wondrixEndOverlay').classList.remove('show');
  document.getElementById('wondrixTimer').textContent = '30';
  initAudio(); startWondrixAmbience();

  const W = canvas.width, H = canvas.height;
  const player = { x: W/2, y: H/2, speed: 4, size: 12 };
  const twisted = [];
  let survived = 0, gameOver = false, surviveTime = 30;

  // Spawn twisted periodically
  function spawnTwisted() {
    const edge = Math.floor(Math.random()*4);
    let x, y;
    if(edge===0) { x=Math.random()*W; y=-20; }
    else if(edge===1) { x=W+20; y=Math.random()*H; }
    else if(edge===2) { x=Math.random()*W; y=H+20; }
    else { x=-20; y=Math.random()*H; }
    twisted.push({ x, y, speed: 1.2 + Math.random()*1.5, size: 10 + Math.random()*6, wobble: Math.random()*Math.PI*2 });
  }

  for(let i=0;i<5;i++) spawnTwisted();
  let spawnTimer = setInterval(() => { if(!gameOver) spawnTwisted(); }, 1200);
  let countdownTimer = setInterval(() => {
    if(gameOver) return;
    survived++;
    document.getElementById('wondrixTimer').textContent = Math.max(0, surviveTime - survived);
    if(survived >= surviveTime) { endWondrix(true); }
  }, 1000);

  function drawPlayer(ctx, p) {
    const isLux = G.lux >= 50;
    const col = isLux ? '#d8d4cc' : '#1e1e1e';
    const mask = isLux ? '#f0ede6' : '#0a0a0a';
    ctx.save(); ctx.translate(p.x, p.y);
    // Body
    ctx.fillStyle = col;
    ctx.fillRect(-4, 2, 8, 18);
    // Head
    ctx.beginPath(); ctx.arc(0, -4, 7, 0, Math.PI*2); ctx.fillStyle = col; ctx.fill();
    // Mask
    ctx.beginPath(); ctx.arc(0, -3, 5, 0, Math.PI*2); ctx.fillStyle = mask; ctx.fill();
    // Eyes
    ctx.fillStyle = '#c8b89a';
    ctx.fillRect(-3, -5, 2, 2); ctx.fillRect(1, -5, 2, 2);
    // Legs
    ctx.fillStyle = col;
    ctx.fillRect(-4, 20, 3, 10); ctx.fillRect(1, 20, 3, 10);
    // Arms
    ctx.fillRect(-8, 4, 4, 12); ctx.fillRect(4, 4, 4, 12);
    ctx.restore();
  }

  function drawTwisted(ctx, t, frame) {
    ctx.save(); ctx.translate(t.x, t.y);
    t.wobble += 0.08;
    const wb = Math.sin(t.wobble) * 3;
    // Bandaged body
    ctx.fillStyle = 'rgba(180,170,155,0.7)';
    ctx.fillRect(-3+wb*0.3, 2, 6, 16);
    // Head — bandaged
    ctx.beginPath(); ctx.arc(wb*0.5, -3, 6, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(200,190,175,0.8)'; ctx.fill();
    // Spiral on face
    ctx.strokeStyle = 'rgba(20,20,20,0.7)'; ctx.lineWidth = 1.5;
    ctx.beginPath();
    for(let a=0; a<Math.PI*4; a+=0.3) {
      const r = a * 0.8;
      const sx = wb*0.5 + Math.cos(a + frame*0.02) * r;
      const sy = -3 + Math.sin(a + frame*0.02) * r;
      if(a===0) ctx.moveTo(sx, sy); else ctx.lineTo(sx, sy);
    }
    ctx.stroke();
    // Legs
    ctx.fillStyle = 'rgba(160,150,140,0.6)';
    ctx.fillRect(-3+wb*0.2, 18, 2, 8); ctx.fillRect(1+wb*0.2, 18, 2, 8);
    // Arms — reaching
    ctx.fillRect(-7+wb, 3, 4, 10); ctx.fillRect(3+wb, 3, 4, 10);
    ctx.restore();
  }

  let frame = 0;
  function gameLoop() {
    if(gameOver) return;
    wondrixGameId = requestAnimationFrame(gameLoop);
    frame++;
    // Clear
    ctx.fillStyle = '#020204'; ctx.fillRect(0,0,W,H);

    // Grid
    ctx.strokeStyle = 'rgba(140,30,30,0.03)'; ctx.lineWidth = 1;
    for(let x=0;x<W;x+=60) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
    for(let y=0;y<H;y+=60) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }

    // Fog particles
    for(let i=0;i<3;i++) {
      const fx = (frame*0.3 + i*400) % (W+200) - 100;
      const fy = H*0.3 + Math.sin(frame*0.005+i)*H*0.3;
      const fg = ctx.createRadialGradient(fx,fy,0,fx,fy,80);
      fg.addColorStop(0, 'rgba(140,30,30,0.015)'); fg.addColorStop(1, 'transparent');
      ctx.fillStyle = fg; ctx.fillRect(fx-80,fy-80,160,160);
    }

    // Player movement
    if(wondrixKeys['w'] || wondrixKeys['arrowup']) player.y -= player.speed;
    if(wondrixKeys['s'] || wondrixKeys['arrowdown']) player.y += player.speed;
    if(wondrixKeys['a'] || wondrixKeys['arrowleft']) player.x -= player.speed;
    if(wondrixKeys['d'] || wondrixKeys['arrowright']) player.x += player.speed;
    player.x = Math.max(player.size, Math.min(W-player.size, player.x));
    player.y = Math.max(player.size, Math.min(H-player.size, player.y));

    // Twisted AI
    twisted.forEach(t => {
      const dx = player.x - t.x, dy = player.y - t.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist > 0) { t.x += (dx/dist) * t.speed; t.y += (dy/dist) * t.speed; }
      if(dist < player.size + t.size * 0.6) { endWondrix(false); }
      drawTwisted(ctx, t, frame);
    });

    drawPlayer(ctx, player);
  }

  function endWondrix(won) {
    gameOver = true;
    clearInterval(spawnTimer); clearInterval(countdownTimer);
    cancelAnimationFrame(wondrixGameId);
    stopWondrixAmbience();
    const overlay = document.getElementById('wondrixEndOverlay');
    overlay.classList.add('show');
    if(won) {
      document.getElementById('wondrixEndTitle').textContent = 'YOU SURVIVED';
      document.getElementById('wondrixEndDesc').textContent = 'The Twisted could not reach you. The zone yields its secrets. For now.';
    } else {
      document.getElementById('wondrixEndTitle').textContent = 'CAPTURED';
      document.getElementById('wondrixEndDesc').textContent = 'A Twisted one found you. Their bandaged hands close around your arm. The spiral fills your vision. You wake back at the perimeter.';
    }
  }

  gameLoop();
}

function exitWondrix() {
  cancelAnimationFrame(wondrixGameId);
  wondrixKeys = {};
  stopWondrixAmbience();
  startMapAmbience();
  switchScreen('map'); updateNavHub('map');
  document.getElementById('mapNulls').textContent = G.nulls;
  setTimeout(updateMapTransform, 50);
}

document.addEventListener('keydown', e => { wondrixKeys[e.key.toLowerCase()] = true; });
document.addEventListener('keyup', e => { wondrixKeys[e.key.toLowerCase()] = false; });


// ================================================================
// INIT
// ================================================================
updateSliderDisplay(50, 50);

</script>

</body>
</html>
